---
title: "Практическое руководство. Присоединение профилировщика к службе .NET для сбора данных о параллелизме при помощи командной строки | Microsoft Docs"
ms.custom: ""
ms.date: "12/15/2016"
ms.prod: "visual-studio-dev14"
ms.reviewer: ""
ms.suite: ""
ms.technology: 
  - "vs-ide-debug"
ms.tgt_pltfrm: ""
ms.topic: "article"
ms.assetid: ffbdfe37-8325-44be-bd36-2c8aab2dec7b
caps.latest.revision: 24
caps.handback.revision: 24
author: "mikejo5000"
ms.author: "mikejo"
manager: "ghogen"
---
# Практическое руководство. Присоединение профилировщика к службе .NET для сбора данных о параллелизме при помощи командной строки
[!INCLUDE[vs2017banner](../code-quality/includes/vs2017banner.md)]

В этом разделе описан порядок использования программ командной строки средств профилирования [!INCLUDE[vsprvs](../code-quality/includes/vsprvs_md.md)] для присоединения профилировщика к службе [!INCLUDE[dnprdnshort](../code-quality/includes/dnprdnshort_md.md)] и сбора данных о параллелизме потоков и процессов с помощью метода выборки.  
  
> [!NOTE]
>  Функции усиленной безопасности в Windows 8 и Windows Server 2012 требуют значительных изменений в способе сбора данных профилировщиком Visual Studio на этих платформах.  Для Приложений Магазина Windows также требуются новые методы сбора.  См. раздел [Профилирование приложений для Windows 8 и Windows Server 2012](../profiling/performance-tools-on-windows-8-and-windows-server-2012-applications.md).  
  
> [!NOTE]
>  Программы командной строки средств профилирования расположены в подкаталоге \\Team Tools\\Performance Tools каталога установки Visual Studio.  На 64\-разрядных компьютерах доступны 64\-разрядные и 32\-разрядные версии программ.  Для использования программ командной строки профилировщика необходимо добавить путь к этим программам в переменную среды PATH окна командной строки или указать этот путь при вызове команды.  Для получения дополнительной информации см. [Указание пути к средствам командной строки](../profiling/specifying-the-path-to-profiling-tools-command-line-tools.md).  
  
 Для сбора данных о параллелизме нужно присоединить профилировщик к процессу службы.  Пока профилировщик присоединен к службе, можно приостанавливать и возобновлять сбор данных.  Чтобы завершить сеанс профилирования, необходимо отсоединить профилировщик от службы и явным образом завершить его работу.  В большинстве случаев рекомендуется удалять в конце сеанса значения переменных среды, используемые для профилирования.  
  
## Присоединение профилировщика  
  
#### Присоединение профилировщика к службе .NET Framework  
  
1.  Установите службу.  
  
2.  Откройте окно командной строки.  
  
3.  Инициализируйте переменные среды, используемые для профилирования.  Type:  
  
     [VSPerfClrEnv](../profiling/vsperfclrenv.md) **\/globalsampleon** \[**\/samplelineoff**\]  
  
    -   Параметр **\/globalsampleon** включает выборку.  
  
    -   **\/samplelineoff** отключает связывание собранных данных с определенными строками исходного кода.  При выборе этого параметра данные назначаются только функциям.  
  
4.  Перезагрузите компьютер.  
  
5.  Запустите профилировщик.  Type:  
  
     [VSPerfCmd](../profiling/vsperfcmd.md) **\/start:concurrency  \/output:**`OutputFile` \[`Options`\]  
  
     Параметр [\/output](../profiling/output.md)**:**`OutputFile` является обязательным при использовании параметра **\/start**.  Параметр `OutputFile` задает имя и расположение файла с данными профилирования \(VSP\-файла\).  
  
     С параметром **\/start** можно использовать любые из следующих параметров.  
  
    > [!NOTE]
    >  Обычно параметры **\/user** и **\/crosssession** являются обязательными для служб.  
  
    |Команда|Описание|  
    |-------------|--------------|  
    |[\/user](../profiling/user-vsperfcmd.md) **:**\[`Domain`**\\**\]`UserName`|Задает домен и имя пользователя учетной записи, которая является владельцем профилируемого процесса.  Этот параметр является обязательным только в том случае, если процесс выполняется от имени пользователя, отличного от пользователя, который выполнил вход в систему.  Имя владельца процесса отображается в столбце "Имя пользователя" на вкладке "Процессы" диспетчера задач Windows.|  
    |[\/crosssession](../profiling/crosssession.md)|Включает профилирование процессов в других сеансах.  Этот параметр является обязательным, если служба выполняется в рамках другого сеанса.  Идентификатор сеанса отображается в столбце "Код сеанса" на вкладке "Процессы" диспетчера задач Windows.  Для **\/crosssession** может быть задано сокращение **\/CS**.|  
    |[\/wincounter](../profiling/wincounter.md) **:** `WinCounterPath`|Задает счетчик производительности Windows, данные которого следует собирать в процессе профилирования.|  
    |[\/automark](../profiling/automark.md) **:** `Interval`|Используйте только с **\/wincounter**.  Задает интервал времени \(в миллисекундах\) между событиями сбора данных счетчика производительности Windows.  Значение по умолчанию — 500 мс.|  
    |[\/events](../profiling/events-vsperfcmd.md) **:** `Config`|Задает событие трассировки событий Windows, данные которого следует собирать в процессе профилирования.  События трассировки событий Windows собираются в отдельный ETL\-файл.|  
  
6.  Если необходимо, запустите службу.  
  
7.  Присоедините профилировщик к службе.  Type:  
  
     **VSPerfCmd \/attach:** `PID` \[[\/targetclr](../profiling/targetclr.md)**:**`Version`\]  
  
    -   Параметр `PID` задает идентификатор или имя процесса службы.  Диспетчер задач Windows позволяет просмотреть идентификаторы всех запущенных процессов.  
  
    -   **targetclr:** `Version` задает версию среды CLR для профилирования, если в приложении загружено несколько версий среды выполнения.  Необязательно.  
  
## Управление сбором данных  
 Пока выполняется служба, можно управлять сбором данных путем запуска и остановки записи данных в файл с помощью параметров VSPerfCmd.exe.  Управление сбором данных позволяет собирать данные на различных этапах выполнения программы, например при запуске или завершении работы приложения.  
  
#### Запуск и остановка сбора данных  
  
-   Следующие пары параметров **VSPerfCmd** используются для запуска и остановки сбора данных.  Задайте каждый параметр в отдельной строке командной строки.  Запуск и приостановка сбора данных могут выполняться неоднократно.  
  
    |Команда|Описание|  
    |-------------|--------------|  
    |[\/globalon \/globaloff](../profiling/globalon-and-globaloff.md)|Запускает \(**\/globalon**\) или останавливает \(**\/globaloff**\) сбор данных для всех процессов.|  
    |[\/processon](../profiling/processon-and-processoff.md) **:** `PID` [\/processoff](../profiling/processon-and-processoff.md)**:**`PID`|Запускает \(**\/processon**\) или останавливает \(**\/processoff**\) сбор данных для процесса с указанным идентификатором процесса \(`PID`\).|  
    |**\/attach:**{`PID`&#124;`ProcName`} [\/detach](../profiling/detach.md)\[:{`PID`&#124;`ProcName`}\]|**\/attach** запускает сбор данных для процесса, определяемого идентификатором или именем процесса.  **\/detach** останавливает сбор данных для указанного процесса или, если он не задан, для всех процессов.|  
  
-   Для добавления метки профилирования в файл данных можно также использовать параметр **VSPerfCmd.exe** [\/mark](../profiling/mark.md).  Команда **\/mark** добавляет идентификатор, отметку времени и необязательную определенную пользователем текстовую строку.  Метки могут использоваться для фильтрации данных в отчетах профилировщика и представлениях данных.  Следующие пары параметров VSPerfCmd используются для запуска и остановки сбора данных.  Задайте каждый параметр в отдельной строке командной строки.  Запуск и приостановка сбора данных могут выполняться неоднократно.  
  
## Завершение сеанса профилирования  
 При завершении сеанса профилирования профилировщик не должен собирать данные.  Чтобы остановить процесс сбора данных от приложения, для которого выполняется профилирование методом параллелизма, можно остановить службу или воспользоваться параметром **VSPerfCmd \/detach**.  Затем для завершения работы профилировщика и закрытия файла с данными профилирования используется параметр **VSPerfCmd \/shutdown**.  Команда **VSPerfClrEnv \/globaloff** удаляет переменные среды, используемые для профилирования, но конфигурация системы не изменяется до перезагрузки компьютера.  
  
#### Завершение сеанса профилирования  
  
1.  Для отсоединения профилировщика от целевого приложения выполните одно из следующих действий.  
  
    -   Остановите службу.  
  
         – или –  
  
    -   Введите **VSPerfCmd \/detach.**.  
  
2.  Завершите работу профилировщика.  Type:  
  
     **VSPerfCmd**  [Shutdown](../profiling/shutdown.md)