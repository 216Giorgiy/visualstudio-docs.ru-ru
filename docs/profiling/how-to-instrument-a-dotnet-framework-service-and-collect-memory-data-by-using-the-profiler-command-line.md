---
title: "Практическое руководство. Инструментирование службы .NET Framework и сбор данных об использовании памяти с помощью командной строки профилировщика | Microsoft Docs"
ms.custom: ""
ms.date: "12/15/2016"
ms.prod: "visual-studio-dev14"
ms.reviewer: ""
ms.suite: ""
ms.technology: 
  - "vs-ide-debug"
ms.tgt_pltfrm: ""
ms.topic: "article"
ms.assetid: 2fa072fc-05fe-4420-99c0-51d2ea3ac4ce
caps.latest.revision: 24
caps.handback.revision: 24
author: "mikejo5000"
ms.author: "mikejo"
manager: "ghogen"
---
# Практическое руководство. Инструментирование службы .NET Framework и сбор данных об использовании памяти с помощью командной строки профилировщика
[!INCLUDE[vs2017banner](../code-quality/includes/vs2017banner.md)]

В этом разделе описывается использование программы командной строки средств профилирования [!INCLUDE[vsprvs](../code-quality/includes/vsprvs_md.md)] для инструментирования службы [!INCLUDE[dnprdnshort](../code-quality/includes/dnprdnshort_md.md)] и сбора данных об использовании памяти.  Пользователь может собрать данные о выделении памяти или одновременно данные о выделении памяти и данные о времени существования объекта.  
  
> [!NOTE]
>  Функции усиленной безопасности в Windows 8 и Windows Server 2012 требуют значительных изменений в способе сбора данных профилировщиком Visual Studio на этих платформах.  Для Приложений Магазина Windows также требуются новые методы сбора.  См. раздел [Профилирование приложений для Windows 8 и Windows Server 2012](../profiling/performance-tools-on-windows-8-and-windows-server-2012-applications.md).  
  
> [!NOTE]
>  Службу нельзя профилировать с помощью метода инструментирования, если ее нельзя перезапустить после включения компьютера, например, если она запускается при запуске операционной системы.  
>   
>  Программы командной строки средств профилирования расположены в подкаталоге \\Team Tools\\Performance Tools каталога установки [!INCLUDE[vs_current_short](../code-quality/includes/vs_current_short_md.md)].  На 64\-разрядных компьютерах доступны 64\-разрядные и 32\-разрядные версии программ.  Для использования программ командной строки профилировщика необходимо добавить путь к этим программам в переменную среды PATH окна командной строки или указать этот путь при вызове команды.  Для получения дополнительной информации см. [Указание пути к средствам командной строки](../profiling/specifying-the-path-to-profiling-tools-command-line-tools.md).  
  
## Запуск сеанса профилирования  
 Для сбора данных о производительности, полученных от службы [!INCLUDE[dnprdnshort](../code-quality/includes/dnprdnshort_md.md)], используется программа [VSPerfCLREnv.cmd](../profiling/vsperfclrenv.md), инициализирующая соответствующие переменные среды и программа [VSInstr.exe](../profiling/vsinstr.md), создающая инструментированную копию двоичного файла службы.  
  
 Чтобы настроить компьютер, на котором размещена служба, для профилирования, его нужно перезагрузить.  Кроме того, нужно вручную запустить службу с помощью диспетчера служб.  Затем нужно запустить профилировщик и службу [!INCLUDE[dnprdnshort](../code-quality/includes/dnprdnshort_md.md)].  
  
 При выполнении инструментированного компонента данные об использовании памяти автоматически сохраняются в файле данных.  В ходе сеанса профилирования можно приостанавливать и возобновлять сбор данных.  
  
 Для завершения сеанса профилирования нужно закрыть службу и явным образом завершить работу профилировщика.  В большинстве случаев рекомендуется удалять в конце сеанса значения переменных среды, используемые для профилирования.  
  
#### Запуск профилирования службы .NET Framework  
  
1.  Откройте окно командной строки.  
  
2.  Воспользуйтесь программой **VSInstr** для создания инструментированной версии двоичных файлов сборки.  
  
3.  С помощью диспетчера служб замените исходный двоичный файл инструментированной версией.  Убедитесь, что для типа запуска задано значение "Вручную".  
  
4.  Инициализируйте переменные среды, используемые для профилирования.  Type:  
  
     **VSPerfClrEnv** {**\/globaltracegc** &#124; **\/globaltracegclife**}  
  
    -   При использовании параметров **\/globaltracegc** и **\/globaltracegclife** включается сбор данных о выделении памяти и времени существования объекта.  
  
        |Команда|Описание|  
        |-------------|--------------|  
        |**\/globaltracegc**|Обеспечивает сбор данных исключительно о выделении памяти.|  
        |**\/globaltracegclife**|Собирает данные о выделении памяти и времени существования объекта.|  
  
5.  Перезагрузите компьютер.  
  
6.  Откройте окно командной строки.  
  
7.  Запустите профилировщик.  Type:  
  
     **VSPerfCmd**  [\/start](../profiling/start.md) **:trace**  [\/output](../profiling/output.md) **:** `OutputFile` \[`Options`\]  
  
    -   Параметр **\/start: contention** обеспечивает инициализацию профилировщика.  
  
    -   Параметр **\/output:**`OutputFile` является обязательным при использовании параметра **\/start**.  Параметр `OutputFile` задает имя и расположение файла с данными профилирования \(VSP\-файла\).  
  
     С параметром **\/start:sample** можно использовать любые из следующих параметров.  
  
    > [!NOTE]
    >  Обычно параметры **\/user** и **\/crosssession** являются обязательными для служб.  
  
    |Команда|Описание|  
    |-------------|--------------|  
    |[\/user](../profiling/user-vsperfcmd.md) **:**\[`Domain`**\\**\]`UserName`|Задает домен и имя пользователя учетной записи, которая является владельцем рабочего процесса ASP.NET.  Этот параметр является обязательным, если процесс выполняется от имени пользователя, отличного от пользователя, который выполнил вход в систему.  Имя владельца процесса отображается в столбце "Имя пользователя" на вкладке "Процессы" диспетчера задач Windows.|  
    |[\/crosssession](../profiling/crosssession.md)|Включает профилирование процессов в других сеансах входа в систему.  Этот параметр является обязательным, если приложение ASP.NET выполняется в рамках другого сеанса.  Идентификатор сеанса отображается в столбце "Код сеанса" на вкладке "Процессы" диспетчера задач Windows.  Для **\/crosssession** может быть задано сокращение **\/CS**.|  
    |[\/waitstart](../profiling/waitstart.md)\[**:**`Interval`\]|Задает \(в секундах\) интервал ожидания инициализации профилировщика до возвращения ошибки.  Если значение `Interval` не указано, профилировщик ожидает в течение неограниченного периода.  По умолчанию немедленно возвращается параметр **\/start**.|  
    |[\/globaloff](../profiling/globalon-and-globaloff.md)|Для запуска профилировщика с приостановкой сбора данных добавьте параметр **\/globaloff** в командную строку **\/start**.  Для возобновления профилирования используйте параметр **\/globalon**.|  
    |[\/counter](../profiling/counter.md) **:** `Config`|Собирает данные счетчика производительности процессора, заданного параметром Config.  Данные, собранные для каждого события профилирования, дополняются данными счетчиков.|  
    |[\/wincounter](../profiling/wincounter.md) **:** `WinCounterPath`|Задает счетчик производительности Windows, данные которого следует собирать в процессе профилирования.|  
    |[\/automark](../profiling/automark.md) **:** `Interval`|Используйте только с **\/wincounter**.  Задает интервал времени \(в миллисекундах\) между событиями сбора данных счетчика производительности Windows.  Значение по умолчанию — 500 мс.|  
    |[\/events](../profiling/events-vsperfcmd.md) **:** `Config`|Задает событие трассировки событий Windows, данные которого следует собирать в процессе профилирования.  События трассировки событий Windows собираются в отдельный ETL\-файл.|  
  
8.  Если необходимо, запустите службу.  
  
9. Присоедините профилировщик к службе.  Type:  
  
     **VSPerfCmd \/attach:** `PID` &#124;`ProcessName`  
  
    -   Задайте идентификатор процесса или имя службы процесса.  Диспетчер задач Windows позволяет просмотреть идентификаторы и имена всех запущенных процессов.  
  
## Управление сбором данных  
 Во время выполнения службы можно управлять сбором данных путем запуска и остановки записи данных в файл с помощью параметров **VSPerfCmd.exe**.  Управление сбором данных позволяет собирать данные на различных этапах выполнения программы, например, при запуске или завершении работы приложения.  
  
#### Запуск и остановка сбора данных  
  
-   Следующие пары параметров **VSPerfCmd** используются для запуска и остановки сбора данных.  Задайте каждый параметр в отдельной строке командной строки.  Запуск и приостановка сбора данных могут выполняться неоднократно.  
  
    |Команда|Описание|  
    |-------------|--------------|  
    |[\/globalon \/globaloff](../profiling/globalon-and-globaloff.md)|Запускает \(**\/globalon**\) или останавливает \(**\/globaloff**\) сбор данных для всех процессов.|  
    |[\/processon](../profiling/processon-and-processoff.md) **:** `PID`  [\/processoff](../profiling/processon-and-processoff.md) **:** `PID`|Запускает \(**\/processon**\) или останавливает \(**\/processoff**\) сбор данных для процесса с указанным идентификатором процесса \(`PID`\).|  
    |[\/threadon](../profiling/threadon-and-threadoff.md) **:** `TID`  [\/threadoff](../profiling/threadon-and-threadoff.md) **:** `TID`|Запускает \(**\/threadon**\) или останавливает \(**\/threadoff**\) сбор данных для потока с указанным идентификатором потока \(`TID`\).|  
  
## Завершение сеанса профилирования  
 Для завершения сеанса профилирования закройте приложение, в котором выполняется инструментированный компонент, а затем воспользуйтесь параметром **VSPerfCmd** [\/shutdown](../profiling/shutdown.md), чтобы выключить профилировщик и закрыть файл данных профилирования.  Команда **VSPerfClrEnv \/globaloff** удаляет переменные среды, используемые для профилирования.  
  
#### Завершение сеанса профилирования  
  
1.  Остановите службу с помощью диспетчера служб.  
  
2.  Завершите работу профилировщика.  Type:  
  
     **VSPerfCmd \/shutdown**  
  
3.  После завершения профилирования удалите значения переменных среды этого процесса.  Type:  
  
     **VSPerfClrEnv \/globaloff**  
  
     Замените инструментированный модуль на оригинал.  При необходимости измените тип запуска службы.  
  
4.  Перезагрузите компьютер.  
  
## См. также  
 [Службы профилирования](../profiling/command-line-profiling-of-services.md)   
 [Представления данных в памяти .NET](../profiling/dotnet-memory-data-views.md)