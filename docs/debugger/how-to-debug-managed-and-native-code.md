---
title: 'Учебник: Отладка управляемого и машинного кода | Документы Microsoft'
description: Узнайте, как выполнить отладку собственной библиотеки DLL из приложения .NET Core или .NET Framework
ms.custom: ''
ms.date: 04/27/2018
ms.technology: vs-ide-debug
ms.topic: tutorial
dev_langs:
- CSharp
- C++
helpviewer_keywords:
- mixed mode debugging
author: mikejo5000
ms.author: mikejo
manager: douge
ms.workload:
- dotnet
- cplusplus
ms.openlocfilehash: aeb74bac5196450ec98426727a1456a009adb5c1
ms.sourcegitcommit: a8e01952be5a539104e2c599e9b8945322118055
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 05/03/2018
---
# <a name="tutorial-debug-managed-and-native-code-in-visual-studio"></a>Учебник: Отладка управляемого и машинного кода в Visual Studio

Visual Studio позволяет включить более чем один тип отладчика при отладке, называемый Отладка в смешанном режиме. В этом учебнике устанавливаются параметры, отладка управляемого и машинного кода в одном сеансе отладки. Этот учебник показывает, как выполнить отладку машинного кода из управляемого приложения, но можно также выполнять обратную операцию, и [отладки управляемого кода из собственного приложения](../debugger/how-to-debug-in-mixed-mode.md). Отладчик также поддерживает другие виды Отладка в смешанном режиме, такие как отладка [Python и машинный код](../python/debugging-mixed-mode-c-cpp-python-in-visual-studio.md) и с помощью отладчика сценариев в типах приложений, таких как ASP.NET.

В этом руководстве рассмотрены следующие задачи:

> [!div class="checklist"]
> * Создание простого собственной библиотеки DLL
> * Создание простого приложения .NET Core или .NET Framework для вызова библиотеки DLL
> * Запуск отладчика
> * Попадание в точку останова в управляемом приложении
> * Шаг с заходом в машинный код

## <a name="prerequisites"></a>Предварительные требования

* Необходимо иметь установленной среды Visual Studio и **разработки настольных приложений с помощью C++** рабочей нагрузки.

    Установите Visual Studio бесплатно [здесь](http://www.visualstudio.com), если еще не сделали это.

    Если вам нужно установить рабочую нагрузку, но среда Visual Studio уже имеется, щелкните ссылку **Открыть установщик Visual Studio** в левой области диалогового окна **Новый проект**. Запускается Visual Studio Installer. Выберите рабочую нагрузку **Разработка Node.js**, а затем элемент **Изменить**.

* Также должен иметь либо **разработки настольных приложений .NET** рабочей нагрузки или **.NET Core кросс-платформенной разработки** рабочей нагрузки установлены, в зависимости от типа какое приложение, вы хотите создать.

## <a name="create-a-simple-native-dll"></a>Создание простого собственной библиотеки DLL

1. В Visual Studio выберите **файл** > **New** > **проекта**.

1. В **новый проект** диалогового окна выберите **Visual C++**, **Общие** из установленных шаблонов раздела, а затем в средней области выберите **пустой проект** .

1. В **имя** введите **смешанный режим отладки** и нажмите кнопку **ОК**.

    Visual Studio создает пустой проект, который отображается в обозревателе решений в области справа.

1. В обозревателе решений щелкните правой кнопкой мыши **исходные файлы** узел в C++ проекта, а затем выберите **добавить** > **новый элемент**и выберите **C++ файл (.cpp)**. Присвойте файлу имя **Mixed Mode.cpp**и выберите **добавить**.

    Visual Studio добавляет новый файл C++.

1. Скопируйте следующий код в *Mixed Mode.cpp*:

    ```cpp
    #include "Mixed_Mode.h"
    ```
1. В обозревателе решений щелкните правой кнопкой мыши **файлы заголовков** узел в C++ проекта, а затем выберите **добавить** > **новый элемент**и выберите  **Файл заголовка (.h)**. Присвойте файлу имя **Mixed Mode.h**и выберите **добавить**.

    Visual Studio добавляет новый файл заголовка.

1. Скопируйте следующий код в *Mixed Mode.h*:

    ```cpp
    #ifndef MIXED_MODE_MULTIPLY_HPP
    #define MIXED_MODE_MULTIPLY_HPP
    
    extern "C"
    {
        __declspec(dllexport) int __stdcall mixed_mode_multiply(int a, int b) {
            return a * b;
        }
    }
    #endif
    ```

1. На панели инструментов отладки, выберите **отладки** конфигурации и **любой ЦП** платформы, либо в случае .NET Core, выберите **x64** как платформы.

    > [!NOTE]
    > В .NET Core выберите **x64** качестве платформы. .NET core всегда выполняется в 64-разрядном режиме, поэтому это не требуется.

1. В обозревателе решений щелкните правой кнопкой мыши узел проекта (**смешанный режим отладки**) и выберите **свойства**.

1. В **свойства** выберите **свойства конфигурации** > **компоновщика** > **Дополнительно**, и затем в **не точка входа** раскрывающемся списке выберите **нет**. Затем примените параметры.

1. В **свойства** выберите **свойства конфигурации** > **Общие**, а затем выберите **динамическая библиотека (.dll)** из **тип конфигурации** поля. Затем примените параметры.

    ![Переключитесь в собственной библиотеки DLL](../debugger/media/mixed-mode-set-as-native-dll.png)

1. Щелкните правой кнопкой мыши проект и выберите **отладки** > **сборки**.

    Проект должен быть построен без ошибок.

## <a name="create-a-simple-net-framework-or-net-core-app-to-call-the-dll"></a>Создание простого приложения .NET Framework или .NET Core для вызова библиотеки DLL

1. В Visual Studio выберите **файл** > **New** > **проекта**.

1. Выберите шаблон для кода приложения.

    Для .NET Framework в **новый проект** диалогового окна выберите **Visual C#**, **Windows классического** из установленных шаблонов раздела, а затем в средней области Выберите **консольного приложения (.NET Framework)**.

    Для .NET Core в **новый проект** диалогового окна выберите **Visual C#**, **.NET Core** из установленных шаблонов раздела, а затем в средней области выберите  **Консольное приложение (.NET Core)**.

1. В **имя** введите **Mixed_Mode_Calling_App** и нажмите кнопку **ОК**.

    Visual Studio создает проект консоли, который отображается в обозревателе решений в области справа.

1. В *Program.cs*, замените код по умолчанию следующим кодом:

    ```c#
    using System;
    using System.Runtime.InteropServices;
    
    namespace Mixed_Mode_Calling_App
    {
        public class Program
        {
            // Replace the file path shown here with the
            // file path on your computer. For .NET Core, the typical (default) path
            // for a 64-bit DLL might look like this:
            // C:\Users\username\source\repos\Mixed-Mode-Debugging\x64\Debug\Mixed-Mode-Debugging.dll
            // Here, we show a typical path for a DLL targeting the **Any CPU** option.
            [DllImport(@"C:\Users\username\source\repos\Mixed-Mode-Debugging\Debug\Mixed-Mode-Debugging.dll", EntryPoint =
            "mixed_mode_multiply", CallingConvention = CallingConvention.StdCall)]
            public static extern int Multiply(int x, int y);
            public static void Main(string[] args)
            { 
                int result = Multiply(7, 7);
                Console.WriteLine("The answer is {0}", result);
                Console.ReadKey();
            }
        }
    }
    ```

## <a name="configure-mixed-mode-debugging-net-framework"></a>Настройка смешанного режима отладки (.NET Framework)

1. В обозревателе решений щелкните правой кнопкой мыши управляемый **Mixed_Mode_Calling_App** проект и выберите **Назначить запускаемым проектом**.

1. Щелкните правой кнопкой мыши управляемый **Mixed_Mode_Calling_App** проекта, а затем выберите **свойства**и нажмите кнопку **отладки** в левой области. Выберите **включить отладку машинного кода**, а затем закройте страницу свойств, чтобы сохранить изменения.

    ![Включить отладку в смешанном режиме](../debugger/media/mixed-mode-enable-native-code-debugging.png)

## <a name="configure-mixed-mode-debugging-net-core"></a>Настройка смешанный режим отладки (.NET Core)

Во многих версиях Visual Studio 2017 г., необходимо включить отладку машинного кода в приложения .NET Core с использованием смешанного режима *launchSettings.json* файла вместо **свойства** страницы. Для отслеживания обновления пользовательского интерфейса для этой функции, см. это [вопрос GitHub](https://github.com/dotnet/project-system/issues/1125).

1. Откройте *launchSettings.json* файла в *свойства* папки. По умолчанию можно найти файл в этом расположении.

    *C:\Users\<имя пользователя > \source\repos\Mixed_Mode_Calling_App\Properties*

    Если файл отсутствует, откройте свойства проекта (щелкните правой кнопкой мыши управляемый **Mixed_Mode_Calling_App** проекта в обозревателе решений и выберите **свойства**). Временные изменения в **отладки** вкладку и построить проект. Отмените изменения конфигурации.

1. В *lauchsettings.json* файл, добавьте следующее свойство:

    ```
    "nativeDebugging": true
    ```
    
    Таким образом например, файл может выглядеть следующим образом:
    
    ```
    {
      "profiles": {
        "Mixed_Mode_Calling_App": {
          "commandName": "Project",
          "nativeDebugging": true
        }
      }
    }
    ```

## <a name="set-a-breakpoint-and-start-the-debugger"></a>Установите точку останова и запустите отладчик

1. В проекте C# откройте *Program.cs* и установите точку останова в следующую строку кода, щелкнув в левом поле:

    ```c#
    int result = Multiply(7, 7);
    ```

    В левом поле, чтобы указать, что установлена точка останова появится красный кружок.

1. Нажмите клавишу **F5** (**отладки** > **начать отладку**) для запуска отладчика.

    Отладчик останавливается на заданной точке останова. Желтая стрелка указывает, где в настоящий момент приостановлена отладчик.

## <a name="step-into-native-code"></a>Шаг с заходом в машинный код

1. Во время паузы в управляемое приложение, нажмите клавишу **F11** (**отладки** > **шаг с заходом**).

    Файл заголовка с машинным кодом откроется и появится желтая стрелка, в котором отладчик приостановил.

    ![Шаг с заходом в машинный код](../debugger/media/mixed-mode-step-into-native-code.png)

    Теперь можно выполнять следующие действия набора и задавать точки останова и просматривать значения переменных.

1. Наведите указатель на переменные, чтобы увидеть их значения.

1. Посмотрите на **видимые** и **локальные** windows для просмотра переменных и их значения.

    Во время приостановки в отладчике, можно использовать другие функции отладчика, такие как **Контрольные значения** окна и **стек вызовов** окна.

1. Нажмите клавишу **F11** еще раз, чтобы переместить отладчик одной строки.

1. Нажмите клавишу **Shift + F11** (**отладки** > **шаг с выходом**) продолжить выполнение приложения и снова приостановку в управляемом приложении.

1. Чтобы продолжить выполнение приложения, нажмите клавишу **F5**.

    Поздравляем! Завершить работу с учебником по отладке в смешанном режиме.

## <a name="next-steps"></a>Следующие шаги

В этом учебнике вы узнали, как выполнить отладку машинного кода из управляемого приложения, включив Отладка в смешанном режиме. Обзор других функций отладчика см. в следующей статье:

> [!div class="nextstepaction"]
> [Первое знакомство с отладчиком](../debugger/debugger-feature-tour.md)