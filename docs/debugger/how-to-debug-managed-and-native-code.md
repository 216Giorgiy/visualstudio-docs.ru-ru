---
title: Руководство По отладке управляемого и машинного кода (смешанный режим)
description: Сведения об отладке собственная библиотека DLL из приложений .NET Core или .NET Framework, с помощью отладки в смешанном режиме
ms.custom: ''
ms.date: 11/02/2018
ms.technology: vs-ide-debug
ms.topic: tutorial
dev_langs:
- CSharp
- C++
helpviewer_keywords:
- mixed mode debugging
author: mikejo5000
ms.author: mikejo
manager: douge
ms.workload:
- dotnet
- cplusplus
ms.openlocfilehash: 121584611dcf0f25fa1f32a616253ecdecf04332
ms.sourcegitcommit: 0a8ac5f2a685270d9ca79bb39d26fd90099bfa29
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 11/09/2018
ms.locfileid: "51295765"
---
# <a name="tutorial-debug-managed-and-native-code-in-the-same-debugging-session"></a>Руководство По отладке управляемого и машинного кода в одном сеансе отладки

Visual Studio позволяет включить более чем один тип отладчика в сеансе отладки, который называется Отладка в смешанном режиме. В этом руководстве вы узнаете, как отладка управляемого и машинного кода в одном сеансе отладки. 

Этом руководстве показано, как выполнить отладку машинного кода из управляемого приложения, но вы также можете [отладку управляемого кода из собственного приложения](../debugger/how-to-debug-in-mixed-mode.md). Отладчик также поддерживает отладку в смешанном режиме, такими как отладка других типов [Python и машинным кодом](../python/debugging-mixed-mode-c-cpp-python-in-visual-studio.md)и с помощью отладчика сценариев в типах приложений, таких как ASP.NET.

В этом руководстве рассмотрены следующие задачи:

> [!div class="checklist"]
> * Создание простой собственная библиотека DLL
> * Создание простого приложения .NET Core или .NET Framework для вызова библиотеки DLL
> * Настройка отладки в смешанном режиме
> * Запустите отладчик
> * Попадание в точку останова в управляемом приложении
> * Шаг с заходом в машинный код

## <a name="prerequisites"></a>Предварительные требования

Необходимо установить Visual Studio, установки, с указанными ниже рабочими нагрузками:
- **Разработка классических приложений C++**
- Либо **разработка классических приложений .NET** или **.NET Core, кроссплатформенной разработки**, в зависимости от типа создаваемого приложения, вы хотите создать.

Если у вас нет Visual Studio, перейдите к [загрузки Visual Studio](https://visualstudio.microsoft.com/downloads/?utm_medium=microsoft&utm_source=docs.microsoft.com&utm_campaign=button+cta&utm_content=download+vs2017) страницу, чтобы установить его бесплатно.

Если вы установили Visual Studio, но нет рабочих нагрузок выберите **открыть установщик Visual Studio** в левой части Visual Studio **новый проект** диалоговое окно. В установщике Visual Studio, выберите рабочие нагрузки должны, а затем выберите **изменить**.

## <a name="create-a-simple-native-dll"></a>Создание простой собственная библиотека DLL

**Для создания файлов для проекта DLL:**

1. В Visual Studio выберите **файл** > **New** > **проекта**.

1. В **новый проект** диалогового **Visual C++** выберите **других**, а затем выберите **пустой проект** в средней области.

1. В **имя** введите **Mixed_Mode_Debugging**, а затем выберите **ОК**.

   Visual Studio создает пустой проект и отображает его в **обозревателе решений**.

1. В **обозревателе решений**выберите **исходные файлы**, а затем выберите **проекта** > **Добавление нового элемента**. Или щелкните правой кнопкой мыши **исходные файлы** и выберите **добавить** > **новый элемент**. 

1. В **новый элемент** диалоговом окне выберите **файл C++ (.cpp)**. Тип **Mixed_Mode.cpp** в **имя** поле, а затем выберите **добавить**.

    Visual Studio добавляет новый файл C++ **обозревателе решений**.

1. Скопируйте следующий код в *Mixed_Mode.cpp*:

    ```cpp
    #include "Mixed_Mode.h"
    ```
1. В **обозревателе решений**выберите **файлы заголовков**, а затем выберите **проекта** > **Добавление нового элемента**. Или щелкните правой кнопкой мыши **файлы заголовков** и выберите **добавить** > **новый элемент**. 

1. В **новый элемент** диалоговом окне выберите **файл заголовка (.h)**. Тип **Mixed_Mode.h** в **имя** поле, а затем выберите **добавить**.

   Visual Studio добавляет новый файл заголовка для **обозревателе решений**.

1. Скопируйте следующий код в *Mixed_Mode.h*:

    ```cpp
    #ifndef MIXED_MODE_MULTIPLY_HPP
    #define MIXED_MODE_MULTIPLY_HPP

    extern "C"
    {
        __declspec(dllexport) int __stdcall mixed_mode_multiply(int a, int b) {
            return a * b;
        }
    }
    #endif
    ```

1. Выберите **файл** > **сохранить все** или нажмите клавишу **Ctrl**+**Shift**+**S**  для сохранения файлов.

**Настройка и построение проекта библиотеки DLL:**

1. На панели инструментов Visual Studio, выберите **Отладка** конфигурации и **x86** или **x64** платформы. Если вызывающего приложения будет иметь .NET Core, которая всегда выполняется в 64-разрядном режиме, установите **x64** как платформы.

1. В **обозревателе решений**выберите **Mixed_Mode_Debugging** узел проекта и выберите **свойства** значок, или щелкните правой кнопкой мыши узел проекта и выберите **Свойства**.

1. В верхней части **свойства** области, убедитесь, что **конфигурации** присваивается **Активная (Debug)** и **платформы** совпадает с теми, которые на панели инструментов измените: **x64**, или **Win32** для x86 платформы. 

   > [!IMPORTANT]
   > При переключении платформы из **x86** для **x64** или наоборот, необходимо перенастроить свойства для новой платформы. 

1. В разделе **свойства конфигурации** в левой области выберите **компоновщика** > **Дополнительно**и в раскрывающемся списке рядом с полем **нет точки входа**выберите **нет**. Если вам потребовалось изменить его, чтобы **нет**выберите **применить**.

1. В разделе **свойства конфигурации**выберите **Общие**и в раскрывающемся списке рядом с полем **тип конфигурации**выберите **динамическая библиотека (.dll)**. Выберите **применить**, а затем выберите **ОК**.

   ![Переключиться в режим собственная библиотека DLL](../debugger/media/mixed-mode-set-as-native-dll.png)

1. Выберите проект в **обозревателе решений** , а затем выберите **построения** > **построить решение**, нажмите клавишу **F7**, или щелкните правой кнопкой мыши проект и выберите **построения**.

   Проект должен быть построен без ошибок.

## <a name="create-a-simple-managed-app-to-call-the-dll"></a>Создание простого управляемого приложения для вызова библиотеки DLL

1. В Visual Studio, выберите **файл** > **New** > **проекта**.

   > [!NOTE]
   > Несмотря на то, что можно также добавить новый управляемый проект в имеющееся решение C++, создается новое решение поддерживает дополнительные сценарии отладки.

1. В **новый проект** выберите **Visual C#** и в средней области:

   - Приложения .NET Framework, выберите **консольное приложение (.NET Framework)**.
   
   - Приложения .NET Core, выберите **консольное приложение (.NET Core)**.

1. В **имя** введите **Mixed_Mode_Calling_App**, а затем выберите **ОК**.

   Visual Studio создает пустой проект и отображает его в **обозревателе решений**.

1. Замените весь код в *Program.cs* следующим кодом:

    ```csharp
    using System;
    using System.Runtime.InteropServices;

    namespace Mixed_Mode_Calling_App
    {
        public class Program
        {
            // Replace the file path shown here with the
            // file path on your computer. For .NET Core, the typical (default) path
            // for a 64-bit DLL might look like this:
            // C:\Users\username\source\repos\Mixed_Mode_Debugging\x64\Debug\Mixed_Mode_Debugging.dll
            // Here, we show a typical path for a DLL targeting the **x86** option.
            [DllImport(@"C:\Users\username\source\repos\Mixed_Mode_Debugging\Debug\Mixed_Mode_Debugging.dll", EntryPoint =
            "mixed_mode_multiply", CallingConvention = CallingConvention.StdCall)]
            public static extern int Multiply(int x, int y);
            public static void Main(string[] args)
            {
                int result = Multiply(7, 7);
                Console.WriteLine("The answer is {0}", result);
                Console.ReadKey();
            }
        }
    }
    ```

1. В новом же коде Замените путь к файлу в `[DllImport]` ваш путь к файлу для *Mixed_Mode_Debugging.dll* вы только что создали. См. в разделе комментариев кода для подсказки. Не забудьте заменить *username* заполнителя.

1. Выберите **файл** > **сохранить Program.cs** или нажмите клавишу **Ctrl**+**S** для сохранения файла.

## <a name="configure-mixed-mode-debugging"></a>Настройка отладки в смешанном режиме 

### <a name="to-configure-mixed-mode-debugging-for-a-net-framework-app"></a>Чтобы настроить отладку в смешанном режиме для приложения .NET Framework 

1. В **обозревателе решений**выберите **Mixed_Mode_Calling_App** узел проекта и выберите **свойства** значок, или щелкните правой кнопкой мыши узел проекта и выберите **Свойства**.

1. Выберите **Отладка** в левой области выберите **включить отладку машинного кода** флажок, а затем закройте страницу свойств, чтобы сохранить изменения.

    ![Включить отладку в смешанном режиме](../debugger/media/mixed-mode-enable-native-code-debugging.png)

### <a name="to-configure-mixed-mode-debugging-for-a-net-core-app"></a>Чтобы настроить отладку в смешанном режиме для приложения .NET Core 

В большинстве версий Visual Studio 2017, необходимо использовать *launchSettings.json* файл, а не свойства проекта, чтобы включить отладку в смешанном режиме для машинного кода в приложении .NET Core. Чтобы отслеживать обновления пользовательского интерфейса для этой функции, см. в этой [на сайте github](https://github.com/dotnet/project-system/issues/1125).

1. В **обозревателе решений**, разверните **свойства**и откройте *launchSettings.json* файла. 

   >[!NOTE]
   >По умолчанию *launchSettings.json* в *C:\Users\username\source\repos\Mixed_Mode_Calling_App\Properties*. Если *launchSettings.json* не существует, выберите **Mixed_Mode_Calling_App** в проекте **обозревателе решений** , а затем выберите **свойства** значок, или щелкните правой кнопкой мыши проект и выберите **свойства**. Измените временный в **Отладка** вкладку и постройте проект. Это создаст *launchSettings.json* файла. Отменить изменения, внесенные в **Отладка** вкладки.

1. В *lauchsettings.json* добавьте следующую строку:

    ```csharp
    "nativeDebugging": true
    ```

    Полный файл будет выглядеть как в следующем примере:

    ```csharp
    {
      "profiles": {
        "Mixed_Mode_Calling_App": {
          "commandName": "Project",
          "nativeDebugging": true
        }
      }
    }
    ```

## <a name="set-a-breakpoint-and-start-debugging"></a>Установите точку останова и начните отладку

1. В C# откройте проект *Program.cs*. Установите точку останова на следующую строку кода, щелкнув в крайнем левом поле, выбрав линию и нажав **F9**, или щелкнув строку правой кнопкой мыши и выбрав **точки останова**  >  **Вставить точку останова**.

    ```csharp
    int result = Multiply(7, 7);
    ```

    Появится красный кружок в левом поле, где вы задали точку останова.

1. Нажмите клавишу **F5**выберите зеленую стрелку на панели инструментов Visual Studio, или выберите **Отладка** > **начать отладку** запустить отладку.

   Отладчик приостанавливает в заданной точке останова. Желтая стрелка указывает, где отладчик приостановлена.

## <a name="step-in-and-out-of-native-code"></a>Шаг и из машинного кода

1. Приостановив отладки в управляемое приложение, нажмите клавишу **F11**, или выберите **Отладка** > **шаг с заходом**.

   *Mixed_Mode.h* открывает файл заголовка собственного, и вы увидите желтую стрелку, где работа отладчика была приостановлена.

   ![Шаг с заходом в машинном коде](../debugger/media/mixed-mode-step-into-native-code.png)

1. Теперь можно задать и задавать точки останова и проверять значения переменных в машинный или управляемый код.

   - Наведите указатель мыши над переменными в исходном коде для просмотра их значений.

   - Посмотрите на переменную и их значения в **"Видимые"** и **"Локальные"** windows.

   - После приостановки в отладчике можно также использовать **Watch** windows и **стек вызовов** окна.

1. Нажмите клавишу **F11** еще раз, чтобы перейти в строке отладчиком по одному.

1. Нажмите клавишу **Shift**+**F11** или выберите **Отладка** > **шаг с выходом** продолжить выполнение и приостановить работу еще раз в управляемое приложение.

1. Нажмите клавишу **F5** или выберите зеленую стрелку, чтобы продолжить отладку приложения.

Поздравляем! Завершить работу с учебником на отладку в смешанном режиме.

## <a name="next-step"></a>Дальнейшие действия

В этом руководстве вы узнали, как выполнить отладку машинного кода из управляемого приложения, включив отладку в смешанном режиме. Обзор других функций отладчика см. в разделе:

> [!div class="nextstepaction"]
> [Первое знакомство с отладчиком](../debugger/debugger-feature-tour.md)
