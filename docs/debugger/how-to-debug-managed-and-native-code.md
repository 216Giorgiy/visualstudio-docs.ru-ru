---
title: Руководство По отладке управляемого и машинного кода (смешанный режим)
description: Сведения об отладке собственная библиотека DLL из приложений .NET Core или .NET Framework, с помощью отладки в смешанном режиме
ms.custom: ''
ms.date: 10/24/2018
ms.technology: vs-ide-debug
ms.topic: tutorial
dev_langs:
- CSharp
- C++
helpviewer_keywords:
- mixed mode debugging
author: mikejo5000
ms.author: mikejo
manager: douge
ms.workload:
- dotnet
- cplusplus
ms.openlocfilehash: 97ad3b6e112a05db817f7a522c3865893d439fd7
ms.sourcegitcommit: 12d6398c02e818de4fbcb4371bae9e5db6cf9509
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 10/25/2018
ms.locfileid: "50050330"
---
# <a name="tutorial-debug-managed-and-native-code-in-the-same-debugging-session"></a>Руководство По отладке управляемого и машинного кода в одном сеансе отладки

Visual Studio позволяет включить более чем один тип отладчика при отладке, который называется Отладка в смешанном режиме. В этом руководстве можно задать параметры для отладки управляемого и машинного кода в одном сеансе отладки. Этом руководстве показано, как выполнить отладку машинного кода из управляемого приложения, но вы также можете выполнить обратное, и [отладку управляемого кода из собственного приложения](../debugger/how-to-debug-in-mixed-mode.md). Отладчик также поддерживает смешанный режим отладки, такими как отладка других типов [Python и машинным кодом](../python/debugging-mixed-mode-c-cpp-python-in-visual-studio.md) и с помощью отладчика сценариев в типах приложений, таких как ASP.NET.

В этом руководстве рассмотрены следующие задачи:

> [!div class="checklist"]
> * Создание простой собственная библиотека DLL
> * Создание простого приложения .NET Core или .NET Framework для вызова библиотеки DLL
> * Запустите отладчик
> * Попадание в точку останова в управляемом приложении
> * Шаг с заходом в машинном коде

## <a name="prerequisites"></a>Предварительные требования

* Необходимо иметь установлена среда Visual Studio и **разработка классических приложений C++** рабочей нагрузки.

    Если вы еще не установили Visual Studio, перейдите на страницу [загрузки Visual Studio](https://visualstudio.microsoft.com/downloads/?utm_medium=microsoft&utm_source=docs.microsoft.com&utm_campaign=button+cta&utm_content=download+vs2017) страницу, чтобы установить его бесплатно.

    Если вам нужно установить рабочую нагрузку, но среда Visual Studio уже имеется, щелкните ссылку **Открыть установщик Visual Studio** в левой области диалогового окна **Новый проект**. Запускается Visual Studio Installer. Выберите рабочую нагрузку **Разработка классических приложений на C++**, а затем нажмите **Изменить**.

* Вам также потребуется **разработка классических приложений .NET** рабочей нагрузки или **.NET Core, кроссплатформенной разработки** установленной рабочей нагрузкой, в зависимости от типа приложения, которое вы хотите создать.

## <a name="create-a-simple-native-dll"></a>Создание простой собственная библиотека DLL

1. В Visual Studio, выберите **файл** > **New** > **проекта**.

1. В **новый проект** диалоговое окно, выберите **Visual C++**, **других** из установленных шаблонов раздела, а затем в средней области выберите **пустой проект** .

1. В **имя** введите **Mixed_Mode_Debugging** и нажмите кнопку **ОК**.

    Visual Studio создает пустой проект, который отображается в обозревателе решений в области справа.

1. В обозревателе решений щелкните правой кнопкой мыши **исходные файлы** узел в C++ проекта, а затем выберите **добавить** > **новый элемент**, а затем выберите **C++ файл (.cpp)**. Присвойте файлу имя **Mixed_Mode.cpp**и выберите **добавить**.

    Visual Studio добавляет новый файл C++.

1. Скопируйте следующий код в *Mixed_Mode.cpp*:

    ```cpp
    #include "Mixed_Mode.h"
    ```
1. В обозревателе решений щелкните правой кнопкой мыши **файлы заголовков** узел в C++ проекта, а затем выберите **добавить** > **новый элемент**, а затем выберите  **Файл заголовка (.h)**. Присвойте файлу имя **Mixed_Mode.h**и выберите **добавить**.

    Visual Studio добавляет новый файл заголовка.

1. Скопируйте следующий код в *Mixed_Mode.h*:

    ```cpp
    #ifndef MIXED_MODE_MULTIPLY_HPP
    #define MIXED_MODE_MULTIPLY_HPP

    extern "C"
    {
        __declspec(dllexport) int __stdcall mixed_mode_multiply(int a, int b) {
            return a * b;
        }
    }
    #endif
    ```

1. На панели инструментов отладки выберите **Отладка** конфигурации и **x86** или **x64** как платформы (.NET Core, которая всегда выполняется в 64-разрядном режиме, выберите **x64**  как платформы).

1. В обозревателе решений щелкните правой кнопкой мыши узел проекта (**Mixed_Mode_Debugging**) и выберите **свойства**.

    > [!IMPORTANT]
    > Настройка свойств для C++ — каждой платформы. Таким образом при переходе от одного до других (x86 для x64 или наоборот наоборот), необходимо также задать свойства для новой конфигурации. (На странице свойств проверьте **x64** или **Win32** устанавливается в качестве платформы в верхней части страницы.)

1. В **свойства** выберите **свойства конфигурации** > **компоновщика** > **Дополнительно**, и затем в **нет точки входа** выберите в раскрывающемся списке, убедитесь, что **нет** выбран. Если вам нужно изменить параметр, чтобы **нет**, затем выберите **применить**.

1. В **свойства** выберите **свойства конфигурации** > **Общие**, а затем выберите **динамическая библиотека (.dll)** из **тип конфигурации** поля. Затем примените параметры.

    ![Переключиться в режим собственная библиотека DLL](../debugger/media/mixed-mode-set-as-native-dll.png)

1. Щелкните правой кнопкой мыши проект и выберите **построения**.

    Проект должен быть построен без ошибок.

## <a name="create-a-simple-net-framework-or-net-core-app-to-call-the-dll"></a>Создать простое приложение .NET Framework или .NET Core в вызов библиотеки DLL

1. В Visual Studio, выберите **файл** > **New** > **проекта**.

    > [!NOTE]
    > Несмотря на то, что новый управляемый проект можно также добавить в решение проект C++, вместо создания нового решения, мы не таким образом, для поддержки большого набора сценариях отладки.

1. Выберите шаблон из кода приложения.

    Для платформы .NET Framework в **новый проект** диалоговое окно, выберите **Visual C#**, **Windows Desktop** из установленных шаблонов раздела, а затем в средней области выберите  **Консольное приложение (.NET Framework)**.

    Для .NET Core в **новый проект** диалоговое окно, выберите **Visual C#**, **.NET Core** из установленных шаблонов раздела, а затем в средней области выберите  **Консольное приложение (.NET Core)**.

1. В **имя** введите **Mixed_Mode_Calling_App** и нажмите кнопку **ОК**.

    Visual Studio создает проект консоли, который отображается в обозревателе решений в области справа.

1. В *Program.cs*, замените код по умолчанию следующим кодом:

    ```csharp
    using System;
    using System.Runtime.InteropServices;

    namespace Mixed_Mode_Calling_App
    {
        public class Program
        {
            // Replace the file path shown here with the
            // file path on your computer. For .NET Core, the typical (default) path
            // for a 64-bit DLL might look like this:
            // C:\Users\username\source\repos\Mixed_Mode_Debugging\x64\Debug\Mixed_Mode_Debugging.dll
            // Here, we show a typical path for a DLL targeting the **x86** option.
            [DllImport(@"C:\Users\username\source\repos\Mixed_Mode_Debugging\Debug\Mixed_Mode_Debugging.dll", EntryPoint =
            "mixed_mode_multiply", CallingConvention = CallingConvention.StdCall)]
            public static extern int Multiply(int x, int y);
            public static void Main(string[] args)
            {
                int result = Multiply(7, 7);
                Console.WriteLine("The answer is {0}", result);
                Console.ReadKey();
            }
        }
    }
    ```

1. В новом коде обновите путь к файлу в путь для библиотеки DLL, созданную ранее (см. комментарии к коду). Убедитесь, что вы замените *username* заполнителя.

## <a name="configure-mixed-mode-debugging-net-framework"></a>Настройка смешанного режима отладки (.NET Framework)

1. В обозревателе решений щелкните правой кнопкой мыши управляемый **Mixed_Mode_Calling_App** проекта и выберите **Назначить запускаемым проектом**.

1. Щелкните правой кнопкой мыши управляемый **Mixed_Mode_Calling_App** проекта, а затем выберите **свойства**, а затем выберите **Отладка** в левой области. Выберите **включить отладку машинного кода**, а затем закройте страницу свойств, чтобы сохранить изменения.

    ![Включить отладку в смешанном режиме](../debugger/media/mixed-mode-enable-native-code-debugging.png)

## <a name="configure-mixed-mode-debugging-net-core"></a>Настройка смешанного режима отладки (.NET Core)

В большинстве версий Visual Studio 2017, необходимо включить смешанный режим отладки для машинного кода в приложение .NET Core с помощью *launchSettings.json* файл вместо **свойства** страницы. Чтобы отслеживать обновления пользовательского интерфейса для этой функции, см. в этой [на сайте github](https://github.com/dotnet/project-system/issues/1125).

1. Откройте *launchSettings.json* файл *свойства* папки. По умолчанию файл можно найти в этом расположении.

    *C:\Users\<имя пользователя > \source\repos\Mixed_Mode_Calling_App\Properties*

    Если файл отсутствует, откройте свойства проекта (щелкните правой кнопкой мыши управляемый **Mixed_Mode_Calling_App** проекта в обозревателе решений и выберите **свойства**). Измените временный в **Отладка** вкладку и выполните сборку проекта. Отмените внесенные изменения.

1. В *lauchsettings.json* добавьте следующее свойство:

    ```csharp
    "nativeDebugging": true
    ```

    Таким образом например, файл может выглядеть следующим образом:

    ```csharp
    {
      "profiles": {
        "Mixed_Mode_Calling_App": {
          "commandName": "Project",
          "nativeDebugging": true
        }
      }
    }
    ```

## <a name="set-a-breakpoint-and-start-the-debugger"></a>Установите точку останова и запустите отладчик

1. В проекте C# откройте *Program.cs* и установите точку останова в следующей строке кода, щелкнув в левом поле:

    ```csharp
    int result = Multiply(7, 7);
    ```

    Появится красный кружок в левом поле, чтобы указать, что установлена точка останова.

1. Нажмите клавишу **F5** (**Отладка** > **начать отладку**) для запуска отладчика.

    Отладчик приостанавливает в заданной точке останова. Желтая стрелка указывает, где отладчик приостановлена.

## <a name="step-into-native-code"></a>Шаг с заходом в машинном коде

1. Во время паузы в управляемое приложение, нажмите клавишу **F11** (**Отладка** > **шаг с заходом**).

    Открывает файл заголовка с машинным кодом и вы увидите желтую стрелку, где работа отладчика была приостановлена.

    ![Шаг с заходом в машинном коде](../debugger/media/mixed-mode-step-into-native-code.png)

    Теперь можно выполнять следующие действия набора и задавать точки останова и проверять значения переменных.

1. Наведите указатель на переменные, чтобы увидеть их значения.

1. Рассмотрим **"Видимые"** и **"Локальные"** windows переменную и их значения.

    Во время приостановки в отладчике, можно использовать другие функции отладчика, такие как **Watch** окна и **стек вызовов** окна.

1. Нажмите клавишу **F11** еще раз, чтобы перейти в строке отладчиком по одному.

1. Нажмите клавишу **Shift + F11** (**Отладка** > **шаг с выходом**) чтобы продолжить выполнение приложения и снова приостановить в управляемом приложении.

1. Чтобы продолжить выполнение приложения, нажмите клавишу **F5**.

    Поздравляем! Можно ознакомиться с руководством по отладке в смешанном режиме.

## <a name="next-steps"></a>Следующие шаги

В этом руководстве вы узнали, как выполнить отладку машинного кода из управляемого приложения, включив Отладка в смешанном режиме. Общие сведения о других возможности отладчика обратитесь к следующей статье:

> [!div class="nextstepaction"]
> [Первое знакомство с отладчиком](../debugger/debugger-feature-tour.md)
