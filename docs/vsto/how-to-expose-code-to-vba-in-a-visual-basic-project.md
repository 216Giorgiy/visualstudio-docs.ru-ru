---
title: "Практическое руководство. Предоставление доступа к коду со стороны VBA в проекте Visual Basic"
ms.custom: ""
ms.date: "02/02/2017"
ms.prod: "visual-studio-dev14"
ms.reviewer: ""
ms.suite: ""
ms.technology: 
  - "office-development"
ms.tgt_pltfrm: ""
ms.topic: "article"
dev_langs: 
  - "VB"
  - "CSharp"
helpviewer_keywords: 
  - "настройки уровня документа [разработка решений Office в Visual Studio], предоставление доступа к коду"
  - "предоставление доступа к коду VBA"
  - "ведущие элементы [разработка решений Office в Visual Studio], предоставление доступа к коду VBA"
  - "VBA [разработка решений Office в Visual Studio], предоставление доступа к коду (настройки уровня документа)"
  - "Visual Basic [разработка решений Office в Visual Studio], предоставление доступа к коду VBA"
ms.assetid: dc74f3ea-3f78-47f8-8a82-a67896144dd9
caps.latest.revision: 47
author: "kempb"
ms.author: "kempb"
manager: "ghogen"
caps.handback.revision: 46
---
# Практическое руководство. Предоставление доступа к коду со стороны VBA в проекте Visual Basic
  В проекте [!INCLUDE[vbprvb](../sharepoint/includes/vbprvb-md.md)] можно предоставить доступ к коду со стороны кода VBA, если необходимо обеспечить взаимодействие двух типов кода.  
  
 [!INCLUDE[appliesto_alldoc](../vsto/includes/appliesto-alldoc-md.md)]  
  
 Этот процесс для Visual Basic отличается от процесса для Visual C\#.  Дополнительные сведения см. в разделе [Практическое руководство. Предоставление доступа к коду со стороны VBA в проекте Visual C&#35;](../vsto/how-to-expose-code-to-vba-in-a-visual-csharp-project.md).  
  
 Процесс для кода в классе ведущего элемента отличается от процесса для кода в других классах:  
  
-   [Предоставление доступа к коду в классе ведущего элемента](#HostItemCode)  
  
-   [Предоставление доступа к коду в классе, не являющемся классом ведущего элемента](#NonHostItem)  
  
 ![ссылка на видео](../vsto/media/playvideo.png "ссылка на видео") Для просмотра связанных демонстрационных видеороликов перейдите по ссылке [Инструкции по вызову кода VSTO из VBA \(страница может быть на английском языке\)](http://go.microsoft.com/fwlink/?LinkId=136757).  
  
##  <a name="HostItemCode"></a> Предоставление доступа к коду в классе ведущего элемента  
 Чтобы разрешить вызов кода в классе ведущего элемента Visual Basic из кода VBA, установите для свойства **EnableVbaCallers** ведущего элемента значение **True**.  
  
 В разделе [Пошаговое руководство. Вызов кода из VBA в проекте Visual Basic](../vsto/walkthrough-calling-code-from-vba-in-a-visual-basic-project.md) представлено пошаговое руководство по предоставлению доступа к методу класса ведущего элемента и его последующему вызову из кода VBA.  Дополнительные сведения о ведущих элементах см. в разделе [Общие сведения о ведущих элементах и элементах управления ведущего приложения](../vsto/host-items-and-host-controls-overview.md).  
  
#### Предоставление доступа к коду ведущего элемента из кода VBA  
  
1.  Откройте или создайте проект уровня документа [!INCLUDE[vbprvb](../sharepoint/includes/vbprvb-md.md)], основанный на документе Word, рабочей книге Excel или шаблоне Excel, поддерживающем макросы и уже содержащем код VBA.  
  
     Дополнительные сведения о форматах файлов документов, поддерживающих макросы, см. в разделе [Объединение настроек VBA и настроек на уровне документа](../vsto/combining-vba-and-document-level-customizations.md).  
  
    > [!NOTE]  
    >  Эту функцию нельзя использовать в проектах шаблонов Word.  
  
2.  Убедитесь в том, что выполнение кода VBA в документе разрешено без вывода пользователю сообщения о необходимости включения макросов.  Чтобы сделать код VBA надежным и разрешить его выполнение, добавьте расположение проекта Office в список надежных расположений в параметрах центра управления безопасностью для Word или Excel.  
  
3.  Добавьте свойство, метод или событие, к которым необходимо предоставить доступ из кода VBA, в один из классов ведущего элемента проекта и объявите новый элемент с помощью модификатора **Public**.  Имя класса зависит от приложения:  
  
    -   в проектах Word классу ведущего элемента по умолчанию присваивается имя `ThisDocument`;  
  
    -   в проектах Excel классам ведущего элемента по умолчанию присваиваются имена `ThisWorkbook`, `Sheet1`, `Sheet2` и `Sheet3`.  
  
4.  Для свойства **EnableVbaCallers** ведущего элемента установите значение **True**.  Это свойство доступно в окне **Свойства** для открытого в конструкторе ведущего элемента.  
  
     После установки этого свойства в Visual Studio свойству **ReferenceAssemblyFromVbaProject** автоматически присваивается значение **True**.  
  
    > [!NOTE]  
    >  Если книга или документ не содержат кода VBA, или код VBA в документе не имеет доверия для выполнения, при присваивании свойству **EnableVbaCallers** значения **True** отображается сообщение об ошибке.  Это связано с тем, что в данном случае в Visual Studio не поддерживается изменение проекта VBA в документе.  
  
5.  В появившимся окне с сообщением нажмите кнопку **ОК**.  В этом сообщении содержится уведомление о том, что при добавлении кода VBA в книгу или документ во время выполнения проекта в среде [!INCLUDE[vsprvs](../sharepoint/includes/vsprvs-md.md)] этот код будет потерян при следующем построении проекта.  Это происходит потому, что документ в выходной папке сборки перезаписывается при каждом построении проекта.  
  
     На этом этапе Visual Studio настраивает проект, чтобы проект VBA мог обращаться к данной сборке.  Visual Studio также добавляет свойство с именем `CallVSTOAssembly` в модуль проекта VBA `ThisDocument`, `ThisWorkbook`, `Sheet1`, `Sheet2` или `Sheet3`.  Это свойство можно использовать для обращения к открытым элементам класса, к которому предоставляется доступ из кода VBA.  
  
6.  Выполните построение проекта.  
  
##  <a name="NonHostItem"></a> Предоставление доступа к коду в классе, не являющемся классом ведущего элемента  
 Чтобы разрешить вызов кода Visual Basic в классе, не являющемся классом ведущего элемента, из кода VBA, измените код таким образом, чтобы он был видим из кода VBA.  
  
#### Предоставление доступа к коду в классе, не являющемся классом ведущего элемента, из кода VBA  
  
1.  Откройте или создайте проект уровня документа [!INCLUDE[vbprvb](../sharepoint/includes/vbprvb-md.md)], основанный на документе Word, рабочей книге Excel или шаблоне Excel, поддерживающем макросы и уже содержащем код VBA.  
  
     Дополнительные сведения о форматах файлов документов, поддерживающих макросы, см. в разделе [Объединение настроек VBA и настроек на уровне документа](../vsto/combining-vba-and-document-level-customizations.md).  
  
    > [!NOTE]  
    >  Эту функцию нельзя использовать в проектах шаблонов Word.  
  
2.  Убедитесь в том, что выполнение кода VBA в документе разрешено без вывода пользователю сообщения о необходимости включения макросов.  Чтобы сделать код VBA надежным и разрешить его выполнение, добавьте расположение проекта Office в список надежных расположений в параметрах центра управления безопасностью для Word или Excel.  
  
3.  Добавьте элемент, доступ к которому необходимо открыть для VBA, в открытый класс проекта и объявите новый элемент как **public**.  
  
4.  Примените атрибуты <xref:System.Runtime.InteropServices.ComVisibleAttribute> и <xref:Microsoft.VisualBasic.ComClassAttribute> к классу, доступ к которому открывается для VBA.  Эти атрибуты обеспечивают видимость класса для кода VBA.  
  
    ```vb  
    <Microsoft.VisualBasic.ComClass()> _  
    <System.Runtime.InteropServices.ComVisibleAttribute(True)> _  
    ```  
  
5.  Переопределите метод **GetAutomationObject** класса ведущего элемента проекта, чтобы получить экземпляр класса, к которому предоставляется доступ из кода VBA.  В следующем примере коду VBA предоставляется доступ к классу `DocumentUtilities`.  
  
    ```vb  
    Protected Overrides Function GetAutomationObject() As Object  
        Return New DocumentUtilities()  
    End Function  
    ```  
  
6.  Откройте документ \(для Word\) или лист \(для Excel\) в конструкторе [!INCLUDE[vsprvs](../sharepoint/includes/vsprvs-md.md)].  
  
7.  В окне **Свойства** выберите свойство **ReferenceAssemblyFromVbaProject** и измените его значение на **True**.  
  
    > [!NOTE]  
    >  Если книга или документ не содержат кода VBA, или код VBA в документе не имеет доверия для выполнения, при присваивании свойству **ReferenceAssemblyFromVbaProject** значения **True** отображается сообщение об ошибке.  Это связано с тем, что в данном случае в Visual Studio не поддерживается изменение проекта VBA в документе.  
  
8.  В появившимся окне с сообщением нажмите кнопку **ОК**.  В этом сообщении содержится уведомление о том, что при добавлении кода VBA в книгу или документ во время выполнения проекта в среде [!INCLUDE[vsprvs](../sharepoint/includes/vsprvs-md.md)] этот код будет потерян при следующем построении проекта.  Это происходит потому, что документ в выходной папке сборки перезаписывается при каждом построении проекта.  
  
     На этом этапе Visual Studio настраивает проект, чтобы проект VBA мог обращаться к данной сборке.  Visual Studio также добавляет метод с названием `GetManagedClass` в проект VBA.  Этот метод можно вызывать в любом месте проекта VBA для доступа к классу, открытому для VBA.  
  
9. Выполните построение проекта.  
  
## См. также  
 [Практическое руководство. Создание проектов Office в Visual Studio](../vsto/how-to-create-office-projects-in-visual-studio.md)   
 [Проектирование и создание решений Office](../vsto/designing-and-creating-office-solutions.md)   
 [Объединение настроек VBA и настроек на уровне документа](../vsto/combining-vba-and-document-level-customizations.md)   
 [Пошаговое руководство. Вызов кода из VBA в проекте Visual Basic](../vsto/walkthrough-calling-code-from-vba-in-a-visual-basic-project.md)   
 [Практическое руководство. Предоставление доступа к коду со стороны VBA в проекте Visual C&#35;](../vsto/how-to-expose-code-to-vba-in-a-visual-csharp-project.md)  
  
  