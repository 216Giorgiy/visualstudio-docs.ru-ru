---
title: "Пошаговое руководство. Изменение кэшированных данных в книге на сервере | Microsoft Docs"
ms.custom: ""
ms.date: "02/02/2017"
ms.prod: "visual-studio-dev14"
ms.reviewer: ""
ms.suite: ""
ms.technology: 
  - "office-development"
ms.tgt_pltfrm: ""
ms.topic: "article"
dev_langs: 
  - "VB"
  - "CSharp"
helpviewer_keywords: 
  - "данные [разработка решений Office в Visual Studio], доступ к серверу"
  - "наборы данных [разработка решений Office в Visual Studio], доступ к серверу"
  - "документы [разработка решений Office в Visual Studio], доступ к данным на сервере"
  - "доступ к данным со стороны сервера [разработка решений Office в Visual Studio]"
  - "книги [разработка решений Office в Visual Studio], изменение данных сервера"
ms.assetid: 69e13de3-9286-40cc-8c4b-1727caf761bf
caps.latest.revision: 38
author: "kempb"
ms.author: "kempb"
manager: "ghogen"
caps.handback.revision: 37
---
# Пошаговое руководство. Изменение кэшированных данных в книге на сервере
  В этом пошаговом руководстве описано, как изменить набор данных, кэшированный в рабочей книге Microsoft Office Excel, не запуская Excel, с помощью класса <xref:Microsoft.VisualStudio.Tools.Applications.ServerDocument>.  
  
 [!INCLUDE[appliesto_xlalldoc](../vsto/includes/appliesto-xlalldoc-md.md)]  
  
 В данном пошаговом руководстве рассмотрены следующие задачи:  
  
-   Определение набора данных, содержащего данные из базы данных AdventureWorksLT.  
  
-   Создание экземпляров набора данных в проекте рабочей книги Excel и проекте консольного приложения.  
  
-   Создание объекта <xref:Microsoft.Office.Tools.Excel.ListObject> с привязкой к набору данных в рабочей книге и заполнение объекта <xref:Microsoft.Office.Tools.Excel.ListObject> данными при открытии рабочей книги.  
  
-   Добавление набора данных рабочей книги в кэш данных.  
  
-   Изменение столбца данных в кэшированном наборе данных путем выполнения кода в консольном приложении, не запуская Excel.  
  
 Хотя в этом пошаговом руководстве предполагается, что код выполняется на компьютере разработчика, описанный здесь код можно использовать и на сервере, на котором не установлен Excel.  
  
> [!NOTE]  
>  Отображаемые на компьютере имена или расположения некоторых элементов пользовательского интерфейса Visual Studio могут отличаться от указанных в следующих инструкциях.  Эти элементы определяются используемым выпуском Visual Studio и его параметрами.  Дополнительные сведения см. в разделе [Customizing Development Settings in Visual Studio](http://msdn.microsoft.com/ru-ru/22c4debb-4e31-47a8-8f19-16f328d7dcd3).  
  
## Обязательные компоненты  
 Ниже приведены компоненты, необходимые для выполнения данного пошагового руководства.  
  
-   [!INCLUDE[vsto_vsprereq](../vsto/includes/vsto-vsprereq-md.md)]  
  
-   [!INCLUDE[Excel_14_short](../vsto/includes/excel-14-short-md.md)].  
  
-   Доступ к выполняющемуся экземпляру Microsoft SQL Server 2005 или Microsoft SQL Server 2005 Express с подключенным примером базы данных AdventureWorksLT.  Базу данных AdventureWorksLT можно загрузить с веб\-узла [CodePlex](http://go.microsoft.com/fwlink/?linkid=87843).  Дополнительные сведения о прикреплении базы данных см. в следующих разделах.  
  
    -   Подробнее о прикреплении базы данных с помощью SQL Server Management Studio или SQL Server Management Studio Express см. [Практическое руководство. Прикрепление базы данных \(SQL Server Management Studio\)](http://msdn.microsoft.com/ru-ru/b4efb0ae-cfe6-4d81-a4b4-6e4916885caa).  
  
    -   Подробнее о прикреплении базы данных с помощью командной строки см. [Практическое руководство. Прикрепление файла базы данных к SQL Server Express](http://msdn.microsoft.com/ru-ru/0f8e42b5-7a8c-4c30-8c98-7d2bdc8dcc68).  
  
## Создание проекта библиотеки классов, определяющего набор данных  
 Для использования того же набора данных в проекте книги Excel и в консольном приложении необходимо определить набор данных в отдельной сборке, на которую ссылаются оба проекта.  Для этого пошагового руководства определите набор данных в проекте библиотеки классов.  
  
#### Чтобы создать проект библиотеки классов  
  
1.  Запустите [!INCLUDE[vsprvs](../sharepoint/includes/vsprvs-md.md)].  
  
2.  В меню **Файл** последовательно выберите пункты **Создать** и **Проект**.  
  
3.  В области шаблонов разверните узел **Visual C\#** или **Visual Basic**, а затем щелкните **Windows**.  
  
4.  В списке шаблонов проектов выберите **Библиотека классов**.  
  
5.  В поле **Имя** введите **AdventureWorksDataSet**.  
  
6.  Нажмите **Обзор**, перейдите в папку %UserProfile%\\Мои документы \(для Windows XP и более ранних версий\) или %UserProfile%\\Документы \(для Windows Vista\) и нажмите **Выбрать папку**.  
  
7.  В диалоговом окне **Новый проект** снимите флажок **Создать папку для решения**.  
  
8.  Нажмите кнопку **ОК**.  
  
     [!INCLUDE[vsprvs](../sharepoint/includes/vsprvs-md.md)] добавит проект **AdventureWorksDataSet** в **Обозреватель решений** и откроет файл кода **Class1.cs** или **Class1.vb**.  
  
9. В **обозревателе решений** щелкните правой кнопкой мыши **Class1.cs** или **Class1.vb** и выберите команду **Удалить**.  В данном пошаговом руководстве этот файл не нужен.  
  
## Определение набора данных в проекте библиотеки классов  
 Определите типизированный набор данных, содержащий данные из базы данных AdventureWorksLT для SQL Server 2005.  Далее в этом пошаговом руководстве ссылка на этот набор данных будет помещена в проект книги Excel и в проект консольного приложения.  
  
 Набор данных — *типизированный набор данных*, представляющий данные в таблице Product базы данных AdventureWorksLT.  Дополнительные сведения о типизированных наборах данных см. в разделе [Работа с наборами данных в Visual Studio](../data-tools/dataset-tools-in-visual-studio.md).  
  
#### Определение типизированного набора данных в проекте библиотеки классов  
  
1.  В **обозревателе решений** щелкните проект **AdventureWorksDataSet**.  
  
2.  Если окно **Источники данных** не отображается, его отображение в строке меню, выбирая **Вид**, **Другие окна**, **Источники данных**.  
  
3.  Выберите **Добавить новый источник данных**, чтобы запустить **Мастер настройки источника данных**.  
  
4.  Щелкните **База данных** и нажмите кнопку **Далее**.  
  
5.  Если подключение к базе данных AdventureWorksLT существует, выберите его и нажмите кнопку **Далее**.  
  
     В противном случае нажмите кнопку **Новое подключение** и с помощью диалогового окна **Добавить подключение** создайте новое подключение.  Дополнительные сведения см. в разделе [Практическое руководство. Подключение к данным в базе данных](~/data-tools/how-to-connect-to-data-in-a-database.md).  
  
6.  На странице **Сохранить строку подключения в файл конфигурации приложения** нажмите кнопку **Далее**.  
  
7.  На странице **Выбор объектов базы данных** разверните **Таблицы** и выберите **Product \(SalesLT\)**.  
  
8.  Нажмите кнопку **Готово**.  
  
     Файл AdventureWorksLTDataSet.xsd добавлен к проекту **AdventureWorksDataSet**.  Этот файл определяет следующие элементы:  
  
    -   Типизированный набор данных с именем `AdventureWorksLTDataSet`.  Этот набор данных представляет содержимое таблицы Product в базе данных AdventureWorksLT.  
  
    -   Адаптер таблиц TableAdapter с именем `ProductTableAdapter`.  Этот адаптер TableAdapter может использоваться для чтения и записи данных в `AdventureWorksLTDataSet`.  Дополнительные сведения см. в разделе [Общие сведения об адаптере таблиц](/visual-studio/data-tools/tableadapter-overview).  
  
     Далее в пошаговом руководстве используются оба эти объекта.  
  
9. В **обозревателе решений** щелкните правой кнопкой мыши **AdventureWorksDataSet**, а затем щелкните **Построить**.  
  
     Убедитесь, что проект строится без ошибок.  
  
## Создание проекта книги Excel  
 Создайте проект рабочей книги Excel для интерфейса данных.  Далее создается объект <xref:Microsoft.Office.Tools.Excel.ListObject>, отображающий данные, и добавляется экземпляр набора данных в кэш рабочей книги.  
  
#### Создание проекта книги Excel  
  
1.  В **обозревателе решений** щелкните правой кнопкой мыши решение **AdventureWorksDataSet**, выберите **Добавить** и затем щелкните **Новый проект**.  
  
2.  В панели шаблонов разверните узел **Visual C\#** или **Visual Basic**, а затем разверните узел **Office**.  
  
3.  В развернутым узлом **Комната** выберите узел **2010**.  
  
4.  В списке шаблонов проектов выберите проект книги Excel.  
  
5.  В поле **Имя** введите **AdventureWorksReport**.  Не изменяйте расположение.  
  
6.  Нажмите кнопку **ОК**.  
  
     Откроется вкладка **Мастер проектов Visual Studio Tools for Office**.  
  
7.  Убедитесь, что выбрано **Создать новый документ**, и нажмите кнопку **OK**.  
  
     [!INCLUDE[vsprvs](../sharepoint/includes/vsprvs-md.md)] откроет созданную книгу **AdventureWorksReport** в конструкторе и добавит проект **AdventureWorksReport** в **обозреватель решений**.  
  
## Добавление базы данных к источнику данных в проекте книги Excel  
 Перед тем, как можно будет отобразить набор данных в книге Excel, необходимо добавить набор данных к источникам данных проекта книги Excel.  
  
#### Добавление набора данных к источникам данных в проекте книги Excel  
  
1.  В **обозревателе решений** дважды щелкните **Sheet1.cs** или **Sheet1.vb** в проекте **AdventureWorksReport**.  
  
     Книга откроется в конструкторе.  
  
2.  В меню **Данные** выберите команду **Добавить новый источник данных**.  
  
     Появится **мастер настройки источника данных**.  
  
3.  Выберите **Объект** и нажмите кнопку **Далее**.  
  
4.  На странице **Выбор объекта для привязки** нажмите кнопку **Добавить ссылку**.  
  
5.  На вкладке **Проекты** выберите **AdventureWorksDataSet**, после чего нажмите кнопку **ОК**.  
  
6.  В пространстве имен **AdventureWorksDataSet** сборки **AdventureWorksDataSet** выберите **AdventureWorksLTDataSet** и нажмите кнопку **Готово**.  
  
     Откроется окно **Источники данных** и **AdventureWorksLTDataSet** будет добавлен  к списку источников данных.  
  
## Создание элемента ListObject, привязанного к экземпляру базы данных  
 Для отображения набора данных в книге создайте <xref:Microsoft.Office.Tools.Excel.ListObject> с привязкой к экземпляру набора данных.  Дополнительные сведения о привязке элементов управления к данным см. в разделе [Привязка данных к элементам управления в решениях Office](../vsto/binding-data-to-controls-in-office-solutions.md).  
  
#### Создание элемента ListObject, привязанного к экземпляру базы данных  
  
1.  В окне **Источники данных** разверните узел **AdventureWorksLTDataSet** источника данных **AdventureWorksDataSet**.  
  
2.  Выберите узел **Product**, щелкните направленную вниз стрелку и выберите в раскрывающемся списке **ListObject**.  
  
     Если раскрывающийся список не появляется, убедитесь, что рабочая книга открыта в конструкторе.  
  
3.  Перетащите таблицу **Product** на ячейку A1.  
  
     Элемент управления <xref:Microsoft.Office.Tools.Excel.ListObject> с именем `productListObject` создается на листе с началом в ячейке A1.  Одновременно в проект добавляется объект набора данных `adventureWorksLTDataSet` и <xref:System.Windows.Forms.BindingSource> с именем `productBindingSource`.  <xref:Microsoft.Office.Tools.Excel.ListObject> привязан к <xref:System.Windows.Forms.BindingSource>, который, в свою очередь, связан с экземпляром набора данных.  
  
## Добавление набора данных к кэшу данных  
 Чтобы обеспечить коду вне книги Excel возможность получить доступ к набору данных в книге, необходимо добавить набор данных в кэш.  Дополнительные сведения о кэше данных см. в разделах [Кэшированные данные в настройках уровня документа](../vsto/cached-data-in-document-level-customizations.md) и [Кэширование данных](../vsto/caching-data.md).  
  
#### Добавление набора данных в кэш  
  
1.  В конструкторе выберите **adventureWorksLTDataSet**.  
  
2.  В окне **Свойства** измените значение свойства **Modifiers** на **Public**.  
  
3.  Измените значение свойства **CacheInDocument** на **True**.  
  
## Инициализация набора данных в рабочей книге  
 Перед получением данных из кэшированного набора данных с помощью консольного приложения его необходимо заполнить данными.  
  
#### Инициализация набора данных в рабочей книге  
  
1.  В **обозревателе решений** щелкните правой кнопкой мыши файл **Sheet1.cs** или **Sheet1.vb** и выберите **Просмотреть код**.  
  
2.  Замените обработчик событий `Sheet1_Startup` следующим кодом.  Этот код использует экземпляр класса `ProductTableAdapter`, определенного в проекте **AdventureWorksDataSet**, для заполнения кэшированного набора данных данными, если он пуст.  
  
     [!code-csharp[Trin_CachedDataWalkthroughs#8](../snippets/csharp/VS_Snippets_OfficeSP/Trin_CachedDataWalkthroughs/CS/AdventureWorksReport/Sheet1.cs#8)]
     [!code-vb[Trin_CachedDataWalkthroughs#8](../snippets/visualbasic/VS_Snippets_OfficeSP/Trin_CachedDataWalkthroughs/VB/AdventureWorksReport/Sheet1.vb#8)]  
  
## Контрольная точка  
 Постройте и выполните проект книги Excel, чтобы убедиться, что он компилируется и выполняется без ошибок.  Эта операция также заполняет набор данных и сохраняет его в книге.  
  
#### Построение и запуск проекта  
  
1.  В **обозревателе решений** щелкните правой кнопкой мыши проект **AdventureWorksReport**, выберите **Отладка** и нажмите кнопку **Запустить новый экземпляр**.  
  
     Выполняется построение проекта, а рабочая книга открывается в Excel.  Проверьте следующее:  
  
    -   <xref:Microsoft.Office.Tools.Excel.ListObject> заполняется данными.  
  
    -   Значение в столбце **ListPrice** для первой строки <xref:Microsoft.Office.Tools.Excel.ListObject> равно 1431,5.  Далее в этом пошаговом руководстве будет использовано приложение консоли для изменения значений в столбце **ListPrice**.  
  
2.  Сохраните книгу.  Не изменяйте имя файла или расположение книги.  
  
3.  Закройте Excel.  
  
## Создание проекта консольного приложения  
 Создайте проект консольного приложения для изменения данных в кэшированном наборе данных в книге.  
  
#### Создание проекта консольного приложения  
  
1.  В **обозревателе решений** щелкните правой кнопкой мыши решение **AdventureWorksDataSet**, выберите **Добавить** и затем щелкните **Новый проект**.  
  
2.  В панели **Типы проектов** разверните узел **Visual C\#** или **Visual Basic**, а затем щелкните **Windows**.  
  
3.  Выберите область **Консольное приложение** в области **Шаблоны**.  
  
4.  В поле **Имя** введите **DataWriter**.  Не изменяйте расположение.  
  
5.  Нажмите кнопку **ОК**.  
  
     [!INCLUDE[vsprvs](../sharepoint/includes/vsprvs-md.md)] добавит проект **DataWriter** к **Обозревателю решений** и откроет файл кода **Program.cs** или **Module1.vb**.  
  
## Изменение данных к кэшированном наборе данных с помощью консольного приложения  
 Используйте класс <xref:Microsoft.VisualStudio.Tools.Applications.ServerDocument> в консольном приложении для считывания данных в локальный объект `AdventureWorksLTDataSet`, изменения данных и сохранения в кэшированном наборе данных.  
  
#### Изменение данных к кэшированном наборе данных  
  
1.  В **обозревателе решений** щелкните правой кнопкой мыши проект **DataWriter** и выберите команду **Добавить ссылку**.  
  
2.  На вкладке **.NET**, выберите Microsoft.VisualStudio.Tools.Applications.  
  
3.  Нажмите кнопку **ОК**.  
  
4.  В **обозревателе решений** щелкните правой кнопкой мыши проект **DataWriter** и выберите команду **Добавить ссылку**.  
  
5.  На вкладке **Проекты** выберите **AdventureWorksDataSet**, после чего нажмите кнопку **ОК**.  
  
6.  Откройте файл Program.cs или Module1.vb в редакторе кода.  
  
7.  Добавьте операторы **using** \(для Visual C\#\) или **Imports** \(для Visual Basic\) в начало файла кода.  
  
     [!code-csharp[Trin_CachedDataWalkthroughs#1](../snippets/csharp/VS_Snippets_OfficeSP/Trin_CachedDataWalkthroughs/CS/DataWriter/Program.cs#1)]
     [!code-vb[Trin_CachedDataWalkthroughs#1](../snippets/visualbasic/VS_Snippets_OfficeSP/Trin_CachedDataWalkthroughs/VB/DataWriter/Module1.vb#1)]  
  
8.  Добавьте следующий код в метод `Main`.  В этом коде объявляются следующие объекты:  
  
    -   Экземпляр типа `AdventureWorksLTDataSet`, определенный в проекте **AdventureWorksDataSet**.  
  
    -   Путь к книге AdventureWorksReport в папке построения проекта **AdventureWorksReport**.  
  
    -   Объект <xref:Microsoft.VisualStudio.Tools.Applications.ServerDocument>, используемый для доступа к кэшу данных в книге.  
  
        > [!NOTE]  
        >  Следующий код предполагает, что используется книга с расширением имени файла XLSX.  Если книга в проекте имеет иное расширение имени файла, измените путь соответственно.  
  
     [!code-csharp[Trin_CachedDataWalkthroughs#6](../snippets/csharp/VS_Snippets_OfficeSP/Trin_CachedDataWalkthroughs/CS/DataWriter/Program.cs#6)]
     [!code-vb[Trin_CachedDataWalkthroughs#6](../snippets/visualbasic/VS_Snippets_OfficeSP/Trin_CachedDataWalkthroughs/VB/DataWriter/Module1.vb#6)]  
  
9. Добавьте следующий код в метод `Main` после кода, созданного на предыдущем шаге.  Этот код выполняет следующие задачи:  
  
    -   Использует свойство <xref:Microsoft.VisualStudio.Tools.Applications.ServerDocument.CachedData%2A> класса <xref:Microsoft.VisualStudio.Tools.Applications.ServerDocument> для доступа к кэшированному набору данных в книге.  
  
    -   Код считывает данные из кэшированного набора данных в локальный набор данных.  
  
    -   Он изменяет значение `ListPrice` каждого продукта в таблице Product набора данных.  
  
    -   Сохраняет изменения в кэшированном наборе данных в книге.  
  
     [!code-csharp[Trin_CachedDataWalkthroughs#7](../snippets/csharp/VS_Snippets_OfficeSP/Trin_CachedDataWalkthroughs/CS/DataWriter/Program.cs#7)]
     [!code-vb[Trin_CachedDataWalkthroughs#7](../snippets/visualbasic/VS_Snippets_OfficeSP/Trin_CachedDataWalkthroughs/VB/DataWriter/Module1.vb#7)]  
  
10. В **обозревателе решений** щелкните правой кнопкой мыши проект **DataWriter**, выберите **Отладка** и нажмите кнопку **Запустить новый экземпляр**.  
  
     Консольное приложение выводит сообщения при считывании кэшированного набора данных в локальный набор данных, изменяет цены продуктов в локальном наборе данных и сохраняет новые значения к кэшированном наборе данных.  Чтобы закрыть приложение, нажмите клавишу ENTER.  
  
## Тестирование книги  
 При открытии книги <xref:Microsoft.Office.Tools.Excel.ListObject> теперь отображает изменения, сделанные в столбце `ListPrice` данных в кэшированном наборе данных.  
  
#### Тестирование книги  
  
1.  Закройте книгу AdventureWorksReport в конструкторе Visual Studio, если она все еще открыта.  
  
2.  Откройте книгу AdventureWorksReport, находящуюся в папке построения проекта **AdventureWorksReport**.  По умолчанию папка построения — это следующая папка:  
  
    -   %UserProfile%\\Мои документы\\AdventureWorksReport\\bin\\Debug \(для Windows XP и более ранних версий\)  
  
    -   %UserProfile%\\Документы\\AdventureWorksReport\\bin\\Debug \(для Windows Vista\)  
  
3.  Проверьте, чтобы значение в столбце **ListPrice** для первой строки <xref:Microsoft.Office.Tools.Excel.ListObject> было равно 1574,65.  
  
4.  Закройте книгу.  
  
## См. также  
 [Пошаговое руководство. Вставка данных в книгу на сервере](../vsto/walkthrough-inserting-data-into-a-workbook-on-a-server.md)   
 [Подключение к данным в приложениях Windows Forms](/visual-studio/data-tools/connecting-to-data-in-windows-forms-applications)  
  
  