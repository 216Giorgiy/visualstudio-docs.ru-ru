---
title: "Пошаговое руководство. Создание иерархического отношения с помощью кэшированного набора данных | Microsoft Docs"
ms.custom: ""
ms.date: "02/02/2017"
ms.prod: "visual-studio-dev14"
ms.reviewer: ""
ms.suite: ""
ms.technology: 
  - "office-development"
ms.tgt_pltfrm: ""
ms.topic: "article"
dev_langs: 
  - "VB"
  - "CSharp"
helpviewer_keywords: 
  - "кэширование данных [разработка решений Office в Visual Studio], отношение главный/подчиненный"
  - "главные и подчиненные таблицы [разработка решений Office в Visual Studio], пошаговые руководства"
ms.assetid: 419f4e07-c67f-4fc9-973a-bc794f349ac3
caps.latest.revision: 41
author: "kempb"
ms.author: "kempb"
manager: "ghogen"
caps.handback.revision: 40
---
# Пошаговое руководство. Создание иерархического отношения с помощью кэшированного набора данных
  В этом пошаговом руководстве показано создание иерархического отношения на листе и кэширование данных, позволяющее использовать решение в автономном режиме.  
  
 [!INCLUDE[appliesto_xlalldoc](../vsto/includes/appliesto-xlalldoc-md.md)]  
  
 В процессе выполнения этого пошагового руководства вы научитесь:  
  
-   добавление элементов управления на лист;  
  
-   Настройка кэширования данных на листе.  
  
-   Добавление кода, обеспечивающего прокрутку записей.  
  
-   Тестирование проекта.  
  
> [!NOTE]  
>  Отображаемые на компьютере имена или расположения некоторых элементов пользовательского интерфейса Visual Studio могут отличаться от указанных в следующих инструкциях.  Эти элементы определяются используемым выпуском Visual Studio и его параметрами.  Дополнительные сведения см. в разделе [Customizing Development Settings in Visual Studio](http://msdn.microsoft.com/ru-ru/22c4debb-4e31-47a8-8f19-16f328d7dcd3).  
  
## Обязательные компоненты  
 Ниже приведены компоненты, необходимые для выполнения данного пошагового руководства.  
  
-   [!INCLUDE[vsto_vsprereq](../vsto/includes/vsto-vsprereq-md.md)]  
  
-   [!INCLUDE[Excel_15_short](../vsto/includes/excel-15-short-md.md)] или [!INCLUDE[Excel_14_short](../vsto/includes/excel-14-short-md.md)].  
  
-   Доступ к серверу с примером базы данных SQL Server "Northwind".  База данных может располагаться на компьютере разработчика или на сервере.  
  
-   Разрешения на чтение из базы данных SQL Server и запись в нее.  
  
## Создание нового проекта  
 На этом шаге создается проект книги Excel.  
  
#### Создание нового проекта  
  
1.  Создайте проект книги Excel с именем **Иерархическое отношение** в Visual Basic или C\#.  Убедитесь, что выбрано **Создать новый документ**.  Дополнительные сведения см. в разделе [Практическое руководство. Создание проектов Office в Visual Studio](../vsto/how-to-create-office-projects-in-visual-studio.md).  
  
 Созданная книга Excel открывается в конструкторе Visual Studio. Проект "Иерархическое отношение" добавляется в **обозреватель решений**.  
  
## Создание источника данных  
 Чтобы добавить типизированный набор данных в проект, следует использовать окно **Источники данных**.  
  
#### Создание источника данных  
  
1.  Если окно **Источники данных** не отображается, его отображение в строке меню, выбирая **Вид**, **Другие окна**, **Источники данных**.  
  
2.  Выберите **Добавить новый источник данных**, чтобы запустить **Мастер настройки источника данных**.  
  
3.  Выберите **База данных** и нажмите **Далее**.  
  
4.  Выберите подключение к базе данных SQL Server "Northwind" или добавьте новое подключение с помощью кнопки **Новое подключение**.  
  
5.  После выбора или создания подключения нажмите кнопку **Далее**.  
  
6.  Чтобы сохранить подключение, снимите флажок, если он установлен, и нажмите **Далее**.  
  
7.  В окне **Объекты базы данных** разверните узел **Таблицы**.  
  
8.  Выберите таблицу **Заказы** и затем таблицу **Сведения о заказе**.  
  
9. Нажмите кнопку **Готово**.  
  
 С помощью мастера обе таблицы добавляются в окно **Источники данных**.  Также к проекту добавляется типизированный набор данных, который отображается в **Обозревателе решений**.  
  
## Добавление элементов управления на лист  
 На этом шаге на первый лист выполняется добавление именованного диапазона, объекта списка и двух кнопок.  Сначала добавьте именованный диапазон и объект списка из окна **Источники данных**, чтобы обеспечить их автоматическое связывание с источником данных.  Далее добавьте кнопки с **Панели элементов**.  
  
#### Добавление именованного диапазона и объекта списка  
  
1.  Убедитесь, что книга **My Master\-Detail.xlsx** открыта в конструкторе Visual Studio, и отображается **Лист1**.  
  
2.  Откройте окно **Источники данных** и разверните узел **Заказы**.  
  
3.  Выберите столбец **Код заказа** и щелкните отображаемую стрелку раскрывающегося списка.  
  
4.  Выберите в раскрывающемся списке объект **NamedRange** и перетащите его в ячейку **A2** столбца **Код заказа**.  
  
     В ячейке **A2** создается элемент управления <xref:Microsoft.Office.Tools.Excel.NamedRange> с именем `OrderIDNamedRange`.  Одновременно в проект добавляются элемент управления <xref:System.Windows.Forms.BindingSource> с именем `OrdersBindingSource`, адаптер таблиц и экземпляр класса <xref:System.Data.DataSet>.  Элемент управления связан с объектом <xref:System.Windows.Forms.BindingSource>, который в свою очередь связан с экземпляром <xref:System.Data.DataSet>.  
  
5.  Прокрутите столбцы таблицы **Заказы**.  В нижней части списка располагается таблица **Сведения о заказе**, которая является дочерней по отношению к таблице **Заказы**.  Выберите дочернюю таблицу **Сведения о заказе** \(не расположенную на одном уровне с таблицей **Заказы**\) и щелкните отображающуюся стрелку раскрывающегося списка.  
  
6.  Выберите в раскрывающемся списке элемент управления **ListObject** и перетащите таблицу **Сведения озаказе** в ячейку **A6**.  
  
7.  В ячейке **A6** создается элемент управления <xref:Microsoft.Office.Tools.Excel.ListObject> с именем **Order\_DetailsListObject**, который привязывается к объекту <xref:System.Windows.Forms.BindingSource>.  
  
#### Добавление двух кнопок  
  
1.  Со вкладки **Стандартные элементы управленияПанели элементов** перетащите элемент управления <xref:System.Windows.Forms.Button> в ячейку **A3** листа.  
  
     Этой кнопке присваивается имя `Button1`.  
  
2.  Перетащите другой элемент управления <xref:System.Windows.Forms.Button> в ячейку **B3** листа.  
  
     Этой кнопке присваивается имя `Button2`.  
  
 Затем пометьте набор данных как кэшируемый в документе.  
  
## Кэширование набора данных  
 Чтобы пометить набор данных как кэшируемый в документе, определите его с помощью модификатора Public и установите свойство **CacheInDocument**.  
  
#### Кэширование набора данных  
  
1.  Выберите объект **NorthwindDataSet** в области компонентов.  
  
2.  В окне **Свойства** измените значение свойства **Modifiers** на **Public**.  
  
     Допускается кэширование только документов, определенных с помощью модификатора Public.  
  
3.  Измените значение свойства **CacheInDocument** на **True**.  
  
 Далее следует добавить текст для кнопок. В C\# также добавляется код управления обработчиками событий.  
  
## Инициализация элементов управления  
 Установите текст кнопки и добавьте обработчики событий в событии <xref:Microsoft.Office.Tools.Excel.Workbook.Startup>.  
  
#### Инициализация данных и элементов управления  
  
1.  В **Обозревателе решений** щелкните правой кнопкой мыши **Лист1.vb** или **Лист1.cs** и выберите в контекстном меню команду **Перейти к коду**.  
  
2.  В метод `Sheet1_Startup` добавьте следующий код, в котором задается текст кнопок.  
  
     [!code-csharp[Trin_VstcoreDataExcel#15](../snippets/csharp/VS_Snippets_OfficeSP/Trin_VstcoreDataExcel/CS/Sheet2.cs#15)]
     [!code-vb[Trin_VstcoreDataExcel#15](../snippets/visualbasic/VS_Snippets_OfficeSP/Trin_VstcoreDataExcel/VB/Sheet2.vb#15)]  
  
3.  Добавьте обработчики событий для событий Click кнопок в метод `Sheet1_Startup` \(только для C\#\).  
  
     [!code-csharp[Trin_VstcoreDataExcel#16](../snippets/csharp/VS_Snippets_OfficeSP/Trin_VstcoreDataExcel/CS/Sheet2.cs#16)]  
  
## Добавление кода, включающего прокрутку записей  
 Чтобы включить перемещение по записям, добавьте код в обработчики событий <xref:System.Windows.Forms.Control.Click> для каждой кнопки.  
  
#### Прокрутка записей  
  
1.  Добавьте обработчик событий <xref:System.Windows.Forms.Control.Click> для элемента управления `Button1`, а также следующий код, обеспечивающий перемещение по записям в обратном направлении:  
  
     [!code-csharp[Trin_VstcoreDataExcel#17](../snippets/csharp/VS_Snippets_OfficeSP/Trin_VstcoreDataExcel/CS/Sheet2.cs#17)]
     [!code-vb[Trin_VstcoreDataExcel#17](../snippets/visualbasic/VS_Snippets_OfficeSP/Trin_VstcoreDataExcel/VB/Sheet2.vb#17)]  
  
2.  Добавьте обработчик событий <xref:System.Windows.Forms.Control.Click> для элемента управления `Button2`, а также следующий код, обеспечивающий перемещение по записям в прямом направлении:  
  
     [!code-csharp[Trin_VstcoreDataExcel#18](../snippets/csharp/VS_Snippets_OfficeSP/Trin_VstcoreDataExcel/CS/Sheet2.cs#18)]
     [!code-vb[Trin_VstcoreDataExcel#18](../snippets/visualbasic/VS_Snippets_OfficeSP/Trin_VstcoreDataExcel/VB/Sheet2.vb#18)]  
  
## Тестирование приложения  
 Теперь можно выполнить тестирование книги, чтобы проверить корректность отображения данных, а также возможность использования решения в автономном режиме.  
  
#### Тестирование кэширования данных  
  
1.  Нажмите клавишу **F5**.  
  
2.  Убедитесь, что именованный диапазон и объект списка заполняются данными из источника данных.  
  
3.  Выполните прокрутку записей, нажимая соответствующие кнопки.  
  
4.  Сохраните книгу. Закройте книгу и среду Visual Studio.  
  
5.  Закройте подключение к базе данных.  Если база данных располагается на сервере, отключите сетевой кабель. Если база данных располагается на компьютере разработчика, остановите службу SQL Server.  
  
6.  Откройте Excel, а затем откройте **My Master\-Detail.xlsx** из каталога \\ bin \\ \(моих с отображением вида " главный\-подчиненный " \\ bin в Visual Basic или \\ my Образец\- сведения \\ bin \\ debug в C\-\#\).  
  
7.  Выполните прокрутку записей, чтобы проверить правильность работы листа в автономном режиме.  
  
8.  Восстановите подключение к базе данных.  Если база данных располагается на сервере, подключите компьютер к сети. Если база данных располагается на компьютере разработчика, запустите службу SQL Server.  
  
## Следующие действия  
 В этом пошаговом руководстве показаны основные принципы создания иерархического отношения на листе, а также кэширования набора данных.  Далее будут рассмотрены следующие задачи:  
  
-   Развертывание решения.  Дополнительные сведения см. в разделе [Развертывание решения Office](../vsto/deploying-an-office-solution.md).  
  
## См. также  
 [Привязка данных к элементам управления в решениях Office](../vsto/binding-data-to-controls-in-office-solutions.md)   
 [Данные в решениях Office](../vsto/data-in-office-solutions.md)   
 [Кэширование данных](../vsto/caching-data.md)   
 [Общие сведения о ведущих элементах и элементах управления ведущего приложения](../vsto/host-items-and-host-controls-overview.md)  
  
  