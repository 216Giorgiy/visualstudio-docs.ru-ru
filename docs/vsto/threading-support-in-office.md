---
title: "Поддержка потока в Office | Microsoft Docs"
ms.custom: ""
ms.date: "02/02/2017"
ms.prod: "visual-studio-dev14"
ms.reviewer: ""
ms.suite: ""
ms.technology: 
  - "office-development"
ms.tgt_pltfrm: ""
ms.topic: "article"
dev_langs: 
  - "VB"
  - "CSharp"
helpviewer_keywords: 
  - "несколько потоков [разработка решений Office в Visual Studio]"
  - "модели объектов [разработка решений Office в Visual Studio], поддержка потоков"
  - "Office - приложения [разработка решений Office в Visual Studio], поддержка потоков"
  - "работа с потоками [разработка решений Office в Visual Studio]"
ms.assetid: 810a6648-fece-4b43-9eb6-948d28ed2157
caps.latest.revision: 33
author: "kempb"
ms.author: "kempb"
manager: "ghogen"
caps.handback.revision: 32
---
# Поддержка потока в Office
  Этот раздел предоставляет сведения о поддержке потоков в объектной модели Microsoft Office.  Несмотря на то что модели объектов Office имеют небезопасные потоки, решение Office позволяет работать с различными потоками.  Приложения Office являются моделью серверов Component Object Model \(COM\).  COM дает возможность клиентам осуществить звонок к серверам с произвольными потоками.  Сервера COM, которые не имеют безопасных потоков, предоставляют механизм преобразования параллельных звонков и выполнения одного логического потока на сервере в любое время.  Этот механизм известен как модель однопотокового подразделения \(STA\).  Поскольку звонки обрабатываются, звонки других сторон блокируются на тот период времени, когда сервер занят или принимает другие звонки на фоновом потоке.  
  
 [!INCLUDE[appliesto_all](../vsto/includes/appliesto-all-md.md)]  
  
## Необходимо наличие определенного набора знаний при работе с многочисленными потоками  
 Для того чтобы работать с многочисленными потоками, необходимо иметь по крайней мере базовый набор знаний следующих особенностей многопоточности:  
  
-   Windows API  
  
-   Многопотоковые концепты COM  
  
-   Параллельность  
  
-   Синхронизация  
  
-   Маршалинг  
  
 Общие сведения о многопоточности см. в разделе [Multithreading in Components](../Topic/Multithreading%20in%20Components.md).  
  
 Office выполняется в основном однопотоковом подразделении \(STA\).  Понимание следствий этого позволяет понять способы использования нескольких потоков с Office.  
  
## Основной скрипт многопоточности  
 Код в решениях Office всегда выполняется в основном потоке пользовательского интерфейса.  Возможно потребуется добиться более плавного выполнения приложения. Для этого можно выполнять одну из задач в фоновом потоке.  Основной целью является выполнить две задачи не последовательно, а одновременно, для того чтобы отрегулировать работу \(это главная причина выполнения различных задач\).  Например, в основном потоке пользовательского интерфейса Excel можно оставить код событий, а на фоне потоков запустить задачу, которая собирает данные с сервера и обновляет ячейки данных в пользовательском интерфейсе сервера Excel.  
  
## Фоновые потоки, которые запускают объектные модели Office  
 Когда фоновый поток выполняет запрос приложений Office, звонок автоматически маршалируется в пределах STA.  Однако нет гарантии, что приложение Office может принять звонок во время выполнения фонового потока.  Существует несколько вариантов:  
  
1.  Приложение Office должно отказать сообщениям в доступе, для того чтобы звонок был принят.  Если процесс выполняется медленно без торможения, то потребуется некоторое время для осуществления операции.  
  
2.  Если другой логический поток уже находится в подразделении, к новому потоку доступ будет закрыт.  Часто происходит таким образом, что логический поток поступает в приложение Office и перенаправляет звонок обратно к подразделению вызывающей стороны.  Приложение блокируется в ожидании возвращения звонка.  
  
3.  Документ Excel должен находится в таком режиме, чтобы не принимать немедленно входящие звонки.  Например, приложение Office должно отображать модальное диалоговое окно.  
  
 Для 2 и 3 вариантов COM предоставляет интерфейс [IMessageFilter](http://msdn.microsoft.com/ru-ru/e12d48c0-5033-47a8-bdcd-e94c49857248).  Если на сервере реализован такой интерфейс, все вызовы поступают через метод [HandleIncomingCall](http://msdn.microsoft.com/ru-ru/7e31b518-ef4f-4bdd-b5c7-e1b16383a5be).  Во 2 варианте звонки автоматически блокируются.  В 3 варианте сервер может блокировать звонки в зависимости от обстоятельств.  При блокировке звонка вызывающей стороне необходимо решить, что делать дальше.  Обычно вызывающий код реализует интерфейс [IMessageFilter](http://msdn.microsoft.com/ru-ru/e12d48c0-5033-47a8-bdcd-e94c49857248), и в этом случае он информируется об отклонении методом [RetryRejectedCall](http://msdn.microsoft.com/ru-ru/3f800819-2a21-4e46-ad15-f9594fac1a3d).  
  
 Однако в случае решений, созданных с помощью средств разработки Office в Visual Studio, взаимодействие COM преобразует все отклоненные вызовы в объекты <xref:System.Runtime.InteropServices.COMException> \("Фильтр сообщений выдал диагностику о занятости приложения"\).  При осуществлении звонка объектной модели на фоновом потоке будьте готовы получить предупреждающее сообщение.  Обычно диалоговое окно появляется не сразу. Отображение требует некоторого времени и определенного количества попыток.  Однако в этом случае можно также создать фоновые потоки, такие как STA, а потом зарегистрировать фильтр сообщений для осуществления потока.  
  
## Правильный запуск потока  
 При создании нового потока STA перед запуском потока задайте для состояния подразделения значение STA.  В следующем примере кода показано, как это сделать.  
  
 [!code-csharp[Trin_VstcoreCreatingExcel#5](../snippets/csharp/VS_Snippets_OfficeSP/Trin_VstcoreCreatingExcel/CS/ThisWorkbook.cs#5)]
 [!code-vb[Trin_VstcoreCreatingExcel#5](../snippets/visualbasic/VS_Snippets_OfficeSP/Trin_VstcoreCreatingExcel/VB/ThisWorkbook.vb#5)]  
  
 Дополнительные сведения см. в разделе [Managed Threading Best Practices](../Topic/Managed%20Threading%20Best%20Practices.md).  
  
## Безрежимные формы  
 Безрежимные формы во время отображения допускают некоторые форм взаимодействий с приложениями.  Пользователь работает с формами, а формы взаимодействуют с открытыми приложениями.  Объектная модель Office поддерживает безрежимные формы, однако их необходимо использовать на фоновом потоке.  
  
## См. также  
 [Multithreading in Components](../Topic/Multithreading%20in%20Components.md)   
 [Managed Threading](../Topic/Managed%20Threading.md)   
 [Работа с потоками &#40;C&#35; и Visual Basic&#41;](../Topic/Threading%20(C%23%20and%20Visual%20Basic).md)   
 [Using Threads and Threading](../Topic/Using%20Threads%20and%20Threading.md)   
 [Проектирование и создание решений Office](../vsto/designing-and-creating-office-solutions.md)  
  
  