---
title: Поддержка потоков в Office
ms.custom: ''
ms.date: 02/02/2017
ms.technology:
- office-development
ms.topic: conceptual
dev_langs:
- VB
- CSharp
helpviewer_keywords:
- multiple threads [Office development in Visual Studio]
- threading [Office development in Visual Studio]
- Office applications [Office development in Visual Studio], threading support
- object models [Office development in Visual Studio], threading support
author: TerryGLee
ms.author: tglee
manager: douge
ms.workload:
- office
ms.openlocfilehash: 966f012b2ff4860205186410951b759c2e214668
ms.sourcegitcommit: 0aafcfa08ef74f162af2e5079be77061d7885cac
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 06/01/2018
ms.locfileid: "34693088"
---
# <a name="threading-support-in-office"></a>Поддержка потоков в Office
  В этой статье содержатся сведения о поддержке потоков в объектной модели Microsoft Office. Объектные модели Office не является потокобезопасным, но можно работать с несколькими потоками в решении Office. Приложения Office являются серверами объектов модели компонентов (COM). COM позволяет клиентам вызывать COM-серверы с произвольными потоками. Для COM-серверы, которые не являются потокобезопасными предоставляют механизм для сериализации одновременных вызовов, так что только один логический поток выполняется на сервере в любое время. Этот механизм известен как модель однопотокового подразделения (STA). Поскольку вызовы сериализуются, вызывающие объекты могут быть заблокированы для периодов времени, пока сервер занят или принимает другие звонки на фоновом потоке.  
  
 [!INCLUDE[appliesto_all](../vsto/includes/appliesto-all-md.md)]  
  
## <a name="knowledge-required-when-using-multiple-threads"></a>Необходимо знать при работе с несколькими потоками.  
 Для работы с несколькими потоками, необходимо иметь по крайней мере базовых знаний о следующих аспектов Многопоточность:  
  
-   API-интерфейсы Windows  
  
-   COM многопоточных основные понятия  
  
-   параллелизм  
  
-   Синхронизация  
  
-   маршалинг  
  
 Общие сведения о многопоточности см [управляемые потоки](/dotnet/standard/threading/).  
  
 Office работает в главном однопотоковое подразделение. Основные сведения о последствиях это дает возможность понять, как использование нескольких потоков с Office.  
  
## <a name="basic-multithreading-scenario"></a>Основной сценарий многопоточности  
 Код в решениях Office всегда выполняется в основном потоке пользовательского интерфейса. Может потребоваться для сглаживания производительность приложения, выполнив отдельную задачу в фоновом потоке. Целью является выполнить две задачи первый взгляд за один раз вместо один за другим, задачи, что должно привести гладкую выполнения (основной причиной для использования несколькими потоками). Например возможно, ваш код события в основном потоке пользовательского интерфейса Excel и в фоновом потоке может запустить задачу, которая собирает данные с сервера и обновляет ячейки в пользовательском Интерфейсе Excel с данными с сервера.  
  
## <a name="background-threads-that-call-into-the-office-object-model"></a>Фоновые потоки, которые вызывают объектную модель Office  
 Когда в фоновом потоке делает вызов в приложение Office, вызов автоматически выполняется маршалинг в границах однопотокового Подразделения. Тем не менее нет никакой гарантии, что приложения Office могут обрабатывать вызов во время фонового потока. Существует несколько вариантов:  
  
1.  Приложения Office должны выдавать сообщения для вызова можно ввести. Если процесс выполняется без торможения, это может занять время.  
  
2.  Если другой логический поток уже находится в подразделении, нельзя ввести новый поток. Это часто происходит, когда логический поток поступает в приложение Office, а затем вызывает повторный входящий вызов к подразделению вызывающей стороны. Приложение блокируется в ожидании возвращения звонка.  
  
3.  Excel может находиться в состоянии, таким образом, чтобы немедленно обрабатывать входящие вызовы. Например приложения Office могут применяться для отображения модального диалогового окна.  
  
 Для возможности, 2 и 3, предоставляют [IMessageFilter](http://msdn.microsoft.com/en-us/e12d48c0-5033-47a8-bdcd-e94c49857248) интерфейса. Если такой интерфейс сервера, все вызовы поступают через [HandleIncomingCall](http://msdn.microsoft.com/en-us/7e31b518-ef4f-4bdd-b5c7-e1b16383a5be) метод. 2 варианте вызовы будут автоматически отклонены. 3 варианте сервер может блокировать вызов, в зависимости от обстоятельств. Если вызов отклоняется, вызывающий объект должен выбрать нужное действие. Как правило, вызывающий объект реализует [IMessageFilter](http://msdn.microsoft.com/en-us/e12d48c0-5033-47a8-bdcd-e94c49857248), в этом случае он будет узнавать о отклонение с помощью [RetryRejectedCall](http://msdn.microsoft.com/en-us/3f800819-2a21-4e46-ad15-f9594fac1a3d) метод.  
  
 Однако в случае решений, созданных с помощью средств разработки Office в Visual Studio, COM-взаимодействия преобразует все отклоненные вызовы <xref:System.Runtime.InteropServices.COMException> («фильтр сообщений выдал приложение занято»). При осуществлении звонка объектной модели в фоновом потоке, должны быть готовы обрабатывать это исключение. Обычно повторять в течение определенного времени, а затем отображения диалогового окна. Однако можно также создать фоновый поток как STA и затем зарегистрировать фильтр сообщений для потока для обработки таких случаев.  
  
## <a name="start-the-thread-correctly"></a>Правильно запустить поток  
 При создании нового потока STA, задайте состояние подразделения в STA перед началом потока. В следующем примере кода показано, как это сделать.  
  
 [!code-csharp[Trin_VstcoreCreatingExcel#5](../vsto/codesnippet/CSharp/Trin_VstcoreCreatingExcelCS/ThisWorkbook.cs#5)]
 [!code-vb[Trin_VstcoreCreatingExcel#5](../vsto/codesnippet/VisualBasic/Trin_VstcoreCreatingExcelVB/ThisWorkbook.vb#5)]  
  
 Дополнительные сведения см. в разделе [управляемые потоки рекомендации](/dotnet/standard/threading/managed-threading-best-practices).  
  
## <a name="modeless-forms"></a>Безрежимные формы  
 Безрежимные формы позволяет своего рода взаимодействие с приложением, а отображается форма. Пользователь взаимодействует с формой и формы взаимодействуют с открытыми приложениями. Объектная модель Office поддерживает Безрежимные формы; Тем не менее они должны использоваться не в фоновом потоке.  
  
## <a name="see-also"></a>См. также  
 [Управляемые потоки](/dotnet/standard/threading/)  
 [Работа с потоками (C#)](/dotnet/csharp/programming-guide/concepts/threading/index) [работа с потоками (Visual Basic)](/dotnet/visual-basic/programming-guide/concepts/threading/index)   
 [Использование потоков и работа с потоками](/dotnet/standard/threading/using-threads-and-threading)   
 [Проектирование и создание решений Office](../vsto/designing-and-creating-office-solutions.md)  
  
  