---
title: "Пошаговое руководство. Обработка исключения параллельности | Microsoft Docs"
ms.custom: ""
ms.date: "09/22/2016"
ms.prod: "visual-studio-dev14"
ms.reviewer: ""
ms.suite: ""
ms.tgt_pltfrm: ""
ms.topic: "article"
dev_langs: 
  - "VB"
  - "CSharp"
  - "C++"
  - "aspx"
helpviewer_keywords: 
  - "управление параллелизмом, исключения"
  - "управление параллелизмом, пошаговые руководства"
  - "параллельное использование данных, пошаговые руководства"
  - "наборы данных [Visual Basic], ошибки"
  - "обработка исключений, вопросы параллелизма"
  - "обновление наборов данных, ошибки"
ms.assetid: 73ee9759-0a90-48a9-bf7b-9d6fc17bff93
caps.latest.revision: 23
caps.handback.revision: 19
author: "mikeblome"
ms.author: "mblome"
manager: "ghogen"
---
# Пошаговое руководство. Обработка исключения параллельности
Исключения совместного доступа \(<xref:System.Data.DBConcurrencyException>\) вызываются, когда два пользователя пытаются одновременно изменить одни и те же данные в базе данных.  В этом пошаговом руководстве создается приложение Windows, описывающее перехват <xref:System.Data.DBConcurrencyException>, поиск строки, вызвавшей ошибку, и одну стратегия, которую можно использовать для его обработки.  
  
 В данном пошаговом руководстве необходимо выполнить следующий процесс:  
  
1.  Создать новый проект **Приложение Windows**.  
  
2.  Создать новый набор данных на основе таблицы `Customers` базы данных "Борей".  
  
3.  Создать форму с <xref:System.Windows.Forms.DataGridView> для отображения данных.  
  
4.  Заполнить набор данных данными из таблицы `Customers` базы данных "Борей".  
  
5.  После заполнения набора данных необходимо использовать [Визуальные инструменты для баз данных](http://msdn.microsoft.com/ru-ru/6b145922-2f00-47db-befc-bf351b4809a1) в Visual Studio для непосредственного доступа к таблице данных `Customers` и изменения записи.  
  
6.  Затем в форме изменить значение в той же записи на другое, обновить набор данных и попытаться записать изменения в базу данных, что приведет к ошибке совместного доступа.  
  
7.  Перехватить ошибку, а затем отобразить различные версии записей, предоставляя пользователю возможность продолжить обновление базы данных, либо отменить его.  
  
## Обязательные компоненты  
 Для выполнения этого пошагового руководства потребуется следующее.  
  
-   Доступ к образцу базы данных "Борей" с разрешением на выполнение обновления.  Для получения дополнительной информации см. [Практическое руководство. Установка образцов баз данных](../data-tools/how-to-install-sample-databases.md).  
  
> [!NOTE]
>  Отображаемые диалоговые окна и команды меню могут отличаться от описанных в справке в зависимости от текущих настроек или выпуска.  Чтобы изменить параметры, в меню **Сервис** выберите команду **Импорт и экспорт параметров**.  Для получения дополнительной информации см. [Customizing Development Settings in Visual Studio](http://msdn.microsoft.com/ru-ru/22c4debb-4e31-47a8-8f19-16f328d7dcd3).  
  
## Создание нового проекта  
 Пошаговое руководство начинается с создания нового приложения Windows.  
  
#### Чтобы создать проект приложения Windows:  
  
1.  В меню **Файл** создайте новый проект.  
  
2.  Выберите язык программирования в области **Типы проектов**.  
  
3.  Выберите **Приложение Windows** в области **Шаблоны**.  
  
4.  Назовите проект `ConcurrencyWalkthrough` и нажмите кнопку **OK**.  
  
     Visual Studio добавит проект в **Обозреватель решений** и откроет новую форму в конструкторе.  
  
## Создание набора данных в базе данных "Борей"  
 В этом разделе создается набор данных с именем `NorthwindDataSet`.  
  
#### Чтобы создать NorthwindDataSet  
  
1.  В меню **Данные** выберите **Добавить новый источник данных**.  
  
     Откроется окно [мастер настройки источника данных](../data-tools/media/data-source-configuration-wizard.png).  
  
2.  На странице **Выбор типа источника данных** выберите **База данных**.  
  
3.  Выберите подключение к образцу базы данных "Борей" из списка доступных подключений или нажмите кнопку **Создать подключение**, если подключение недоступно в списке подключений.  
  
    > [!NOTE]
    >  Если вы подключаетесь к файлу локальной базы данных, выберите **Нет** в ответ на вопрос о том, необходимо ли добавить файл в проект.  
  
4.  Нажмите **Далее** на странице **Сохранение подключения в файле конфигурации приложения**.  
  
5.  Разверните узел **Таблицы** и выберите таблицу `Customers`.  По умолчанию набор данных должен называться `NorthwindDataSet`.  
  
6.  Нажмите кнопку **Готово**, чтобы добавить набор данных в проект.  
  
## Создание элемента управления с привязкой к данным DataGridView  
 В этом разделе создается <xref:System.Windows.Forms.DataGridView> путем перетаскивания элемента **Customers** из окна **Источники данных** на форму Windows Form.  
  
#### Чтобы создать элемент управления DataGridView, привязанный к таблице Customers  
  
1.  Выберите **Показать Источники данных** в меню **Данные** для открытия окна **Источники данных**.  
  
2.  В окне **Источники данных** разверните узел **NorthwindDataSet** и выберите таблицу **Customers**.  
  
3.  Щелкните стрелку вниз на узле таблицы и выберите **DataGridView** из раскрывающегося списка.  
  
4.  Перетащите таблицу в пустую область формы.  
  
     Элемент управления <xref:System.Windows.Forms.DataGridView> с именем `CustomersDataGridView` и <xref:System.Windows.Forms.BindingNavigator> с именем `CustomersBindingNavigator` добавляются на форму, связанную с <xref:System.Windows.Forms.BindingSource>, который, в свою очередь, связан с таблицей в `Customers` `NorthwindDataSet`.  
  
## Контрольная точка  
 Теперь можно проверить форму, чтобы убедиться, что она ведет себя, как ожидалось до сих пор.  
  
#### Чтобы проверить форму, выполните следующие действия:  
  
1.  Нажмите клавишу F5 для запуска приложения.  
  
     Появится форма с элементом управления <xref:System.Windows.Forms.DataGridView>, заполненным данными из таблицы `Customers`.  
  
2.  В меню **Отладка** выберите команду **Остановить отладку**.  
  
## Обработка ошибок совместного доступа  
 Способ обработки ошибок зависит от бизнес\-правил, которым подчиняется приложение.  В данном пошаговом руководстве после возникновения ошибки совместного доступа в качестве иллюстрации будет использоваться следующая стратегия ее обработки:  
  
 Приложение предоставляет пользователю три версии записи:  
  
-   Текущая запись в базе данных.  
  
-   Исходная запись, загруженная в набор данных.  
  
-   Предлагаемые изменения в наборе данных.  
  
 Далее пользователь может либо перезаписать базу данных предложенными изменениями, либо отменить обновление и обновить набор данных новыми значениями из базы данных.  
  
#### Чтобы включить обработку ошибок совместного доступа  
  
1.  Создайте пользовательский обработчик ошибок.  
  
2.  Отобразите пользователю варианты выбора.  
  
3.  Обработайте ответ пользователя.  
  
4.  Отправьте обновления или сбросьте данные в наборе данных.  
  
### Добавление кода обработки исключений совместного доступа  
 Когда при попытке выполнить обновление возникает исключение, обычно требуется сделать что\-нибудь со сведениями, предоставляемыми возникшим исключением.  
  
 В этом разделе добавляется код, который будет пытаться обновить базу данных и обработать все <xref:System.Data.DBConcurrencyException>, которые могут возникать, а также любые другие исключения.  
  
> [!NOTE]
>  Методы `CreateMessage` и `ProcessDialogResults` будут добавлены позже в этом пошаговом руководстве.  
  
##### Чтобы добавить обработку ошибок совместного доступа  
  
1.  Добавьте следующий код под методом `Form1_Load`:  
  
     [!code-cs[VbRaddataConcurrency#1](../data-tools/codesnippet/CSharp/handle-a-concurrency-exception_1.cs)]
     [!code-vb[VbRaddataConcurrency#1](../data-tools/codesnippet/VisualBasic/handle-a-concurrency-exception_1.vb)]  
  
2.  Замените метод `CustomersBindingNavigatorSaveItem_Click` для вызова метода `UpdateDatabase`, чтобы он выглядел следующим образом:  
  
     [!code-cs[VbRaddataConcurrency#2](../data-tools/codesnippet/CSharp/handle-a-concurrency-exception_2.cs)]
     [!code-vb[VbRaddataConcurrency#2](../data-tools/codesnippet/VisualBasic/handle-a-concurrency-exception_2.vb)]  
  
### Отображение вариантов выбора  
 Только что написанный код вызывает процедуру `CreateMessage` для отображения пользователю сведений об ошибке.  В рамках настоящего пошагового руководства окно сообщений используется для отображения пользователю различных версий записи и предоставления выбора: перезаписать запись с новыми изменениями или отменить изменения.  Когда пользователь выбирает параметр \(нажимает кнопку\) в окне сообщения, ответ передается методу `ProcessDialogResult`.  
  
##### Чтобы создать сообщение для отображения пользователю  
  
-   Создайте сообщение, добавив следующий код в **Редактор кода**.  Введите этот код под методом `UpdateDatabase`.  
  
     [!code-cs[VbRaddataConcurrency#4](../data-tools/codesnippet/CSharp/handle-a-concurrency-exception_3.cs)]
     [!code-vb[VbRaddataConcurrency#4](../data-tools/codesnippet/VisualBasic/handle-a-concurrency-exception_3.vb)]  
  
### Обработка ответа пользователя  
 При обработке ответа пользователя для окна сообщений требуется код.  Можно либо перезаписать текущую запись в базе данных с предложенными изменениями, либо сбросить локальные изменения и обновить таблицу записью, содержащейся в данный момент в базе данных.  Если пользователь выбирает да, то при вызове метода <xref:System.Data.DataTable.Merge%2A> аргумент *preserveChanges*, имеющим значение `true`.  В результате обновление считается успешно завершенным, поскольку исходная версия записи теперь совпадает с версией записи в базе данных.  
  
##### Чтобы обработать введенные пользователем данные из окна сообщений  
  
-   Добавьте следующий код под кодом, добавленным в предыдущем разделе.  
  
     [!code-cs[VbRaddataConcurrency#3](../data-tools/codesnippet/CSharp/handle-a-concurrency-exception_4.cs)]
     [!code-vb[VbRaddataConcurrency#3](../data-tools/codesnippet/VisualBasic/handle-a-concurrency-exception_4.vb)]  
  
## Проверка  
 Теперь можно проверить форму, чтобы убедиться, что она работает так, как ожидалось.  Для имитации ошибки совместного доступа необходимо изменить данные в базе данных после заполнения NorthwindDataSet.  
  
#### Чтобы проверить форму, выполните следующие действия:  
  
1.  Нажмите клавишу F5 для запуска приложения.  
  
2.  После отображения формы оставьте ее запущенной и переключитесь на интегрированную среду разработки Visual Studio.  
  
3.  В меню **Вид** выберите **Обозреватель серверов**.  
  
4.  В окне **Обозреватель серверов** разверните узел подключения, используемого приложением, и разверните узел **Таблицы**.  
  
5.  Щелкните правой кнопкой мыши на таблице **Customers** и выберите **Показать таблицу данных**.  
  
6.  В первой записи \(`ALFKI`\) измените `ContactName` на `Maria Anders2`.  
  
    > [!NOTE]
    >  Перейдите на другую строку для фиксации изменений.  
  
7.  Переключитесь на запущенную форму `ConcurrencyWalkthrough`.  
  
8.  В первой записи на форме \(`ALFKI`\) измените `ContactName` на `Maria Anders1`.  
  
9. Нажмите кнопку **Сохранить**.  
  
     Возникнет ошибка совместного доступа, и появится окно сообщения.  
  
10. Нажатие кнопки **Нет** отменяет обновление и обновляет набор данных значениями, содержащимися в данный момент в базе данных, тогда как нажатие **Да** записывает предложенное значение в базу данных.  
  
## См. также  
 [Пошаговые руководства работы с данными](../Topic/Data%20Walkthroughs.md)   
 [Привязка элементов управления Windows Forms к данным в Visual Studio](../data-tools/bind-windows-forms-controls-to-data-in-visual-studio.md)   
 [Подключение к данным в Visual Studio](../data-tools/connecting-to-data-in-visual-studio.md)   
 [Подготовка приложения к получению данных](../Topic/Preparing%20Your%20Application%20to%20Receive%20Data.md)   
 [Выборка данных в приложение](../data-tools/fetching-data-into-your-application.md)   
 [Привязка элементов управления к данным в Visual Studio](../data-tools/bind-controls-to-data-in-visual-studio.md)   
 [Редактирование данных в приложении](../data-tools/editing-data-in-your-application.md)   
 [Проверка данных](../Topic/Validating%20Data.md)   
 [Сохранение данных](../data-tools/saving-data.md)