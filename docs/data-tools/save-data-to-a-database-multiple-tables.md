---
title: "Пошаговое руководство. Сохранение данных в базе данных (несколько таблиц) | Microsoft Docs"
ms.custom: ""
ms.date: "12/15/2016"
ms.prod: "visual-studio-dev14"
ms.reviewer: ""
ms.suite: ""
ms.tgt_pltfrm: ""
ms.topic: "article"
dev_langs: 
  - "VB"
  - "CSharp"
  - "C++"
  - "aspx"
helpviewer_keywords: 
  - "данные [Visual Studio], сохранение"
  - "данные [Visual Studio], обновление"
  - "сохранение данных, пошаговые руководства"
  - "обновление наборов данных, пошаговые руководства"
ms.assetid: 7ebe03da-ce8c-4cbc-bac0-a2fde4ae4d07
caps.latest.revision: 24
caps.handback.revision: 20
author: "mikeblome"
ms.author: "mblome"
manager: "ghogen"
---
# Пошаговое руководство. Сохранение данных в базе данных (несколько таблиц)
Одним из наиболее распространенных сценариев в разработке приложений является отображение данных на форме в приложении Windows, изменение этих данных и отправка обновленных данных обратно в базу данных.  Это пошаговое руководство описывает создание формы, отображающей данные из двух связанных таблиц, правку записей и сохранение изменений в базе данных.  В данном примере используются таблицы `Customers` и `Orders` из учебной базы данных "Борей".  
  
 Вы можете сохранить данные из приложения в базе данных, вызвав метод `Update` адаптера таблицы.  При перетаскивании элементов из окна **Источники данных** код для сохранения данных автоматически добавляется для первой таблицы, помещенной на форму.  Для добавляемых на форму дополнительных таблиц код для сохранения данных требуется добавлять вручную.  Это пошаговое руководство описывает добавление кода для сохранения обновлений из нескольких таблиц.  
  
> [!NOTE]
>  Отображаемые диалоговые окна и команды меню могут отличаться от описанных в справке в зависимости от текущих параметров или выпуска.  Чтобы изменить параметры, выберите в меню **Сервис** пункт **Импорт и экспорт параметров**.  Для получения дополнительной информации см. [Customizing Development Settings in Visual Studio](http://msdn.microsoft.com/ru-ru/22c4debb-4e31-47a8-8f19-16f328d7dcd3).  
  
 В данном пошаговом руководстве представлены следующие задачи.  
  
-   Создание нового проекта **Приложение Windows**.  
  
-   Создание и настройка источника данных в приложении с помощью [мастер настройки источника данных](../data-tools/media/data-source-configuration-wizard.png).  
  
-   Настройка элементов управления для элементов в [окно "Источники данных"](../Topic/Data%20Sources%20Window.md).  Для получения дополнительной информации см. [Задание поведения, при котором элемент управления создается при перетаскивании из окна "Источники данных"](../data-tools/set-the-control-to-be-created-when-dragging-from-the-data-sources-window.md).  
  
-   Создание элементов управления с привязкой к данным с помощью перетаскивания элементов из окна **Источники данных** на форму.  
  
-   Изменение пары записей в каждой таблице набора данных.  
  
-   Изменение кода для отправки обновленных данных в наборе данных обратно в базу данных.  
  
## Обязательные компоненты  
 Для выполнения данного пошагового руководства требуется:  
  
-   Доступ к примеру базы данных "Борей".  Для получения дополнительной информации см. [Практическое руководство. Установка образцов баз данных](../data-tools/how-to-install-sample-databases.md).  
  
## Создание приложения Windows  
 Первым шагом является создание **Приложения Windows**.  На данном этапе имя проекту можно не назначать, однако мы зададим его, так как позднее планируем сохранить проект.  
  
#### Порядок создания нового проекта приложения Windows  
  
1.  Перейдите в меню **Файл** и создайте новый проект.  
  
2.  Присвойте проекту имя `UpdateMultipleTablesWalkthrough`.  
  
3.  Выберите **Приложение Windows** и нажмите кнопку **ОК**.  Для получения дополнительной информации см. [Клиентские приложения](../Topic/Developing%20Client%20Applications%20with%20the%20.NET%20Framework.md).  
  
     Создается проект **UpdateMultipleTablesWalkthroug**, который добавляется в **Обозреватель решений**.  
  
## Создание источника данных  
 На этом шаге **Мастер настройки источника данных** используется для создания источника данных из базы данных "Борей".  Для создания подключения необходимо иметь доступ к учебной базе данных "Борей".  Дополнительные сведения о настройке учебной базы данных "Борей" см. в разделе [Практическое руководство. Установка образцов баз данных](../data-tools/how-to-install-sample-databases.md).  
  
#### Создание источника данных  
  
1.  В меню **Данные** выберите команду **Показать источники данных**.  
  
2.  В окне **Источники данных** выберите **Добавить новый источник данных**, чтобы запустить **Мастер настройки источника данных**.  
  
3.  На странице **Выбор типа источника данных** выберите элемент **База данных** и нажмите **Далее**.  
  
4.  На странице **Выбор подключения к базе данных** выполните одно из следующих действий.  
  
    -   Если подключение к учебной базе данных Northwind доступно в раскрывающемся списке, то выберите его.  
  
         \-или\-  
  
    -   Выберите **Новое подключение** для открытия диалогового окна **Добавить\/изменить подключение**.  
  
5.  Если базе данных требуется пароль, выберите параметр для включения конфиденциальных данных и щелкните **Далее**.  
  
6.  На странице **Сохранение подключения в файле конфигурации приложения** нажмите кнопку **Далее**.  
  
7.  Разверните узел **Таблицы** на странице **Выбор объектов базы данных**.  
  
8.  Выберите таблицы **Customers** и **Orders** и нажмите **Готово**.  
  
     Объект **NorthwindDataSet** добавляется в проект, и таблицы отображаются в окне **Источники данных**.  
  
## Настройка создаваемых элементов управления  
 В рамках этого пошагового руководства данные из таблицы `Customers` будут находиться в макете **Сведения**, где данные отображаются в отдельных элементах управления.  Данные из таблицы `Orders` будут находиться в макете **Сетка**, отображаясь в элементе управления <xref:System.Windows.Forms.DataGridView>.  
  
#### Установка типа удаления для элементов в окне "Источники данных"  
  
1.  Разверните узел **Клиенты** в окне **Источники данных**.  
  
2.  Измените элемент управления таблицы **Клиенты** на отдельные элементы управления, выбрав **Сведения** в списке элементов управления в узле **Клиенты**.  Для получения дополнительной информации см. [Задание поведения, при котором элемент управления создается при перетаскивании из окна "Источники данных"](../data-tools/set-the-control-to-be-created-when-dragging-from-the-data-sources-window.md).  
  
## Создание формы с привязкой к данным  
 Вы можете создавать элементы управления с привязкой к данным с помощью перетаскивания элементов из окна **Источники данных** на форму.  
  
#### Создание элементов управления с привязкой к данным на форме  
  
1.  Перетащите главный узел **Клиенты** из окна **Источники данных** на **Form1**.  
  
     Привязанные к данным элементы управления с метками описания отображаются на форме вместе с панелью инструментов \(<xref:System.Windows.Forms.BindingNavigator>\) для перемещения по записям.  В области компонентов появляется [NorthwindDataSet](../data-tools/dataset-tools-in-visual-studio.md), [CustomersTableAdapter](../data-tools/tableadapter-overview.md), <xref:System.Windows.Forms.BindingSource> и <xref:System.Windows.Forms.BindingNavigator>.  
  
2.  Перетащите связанный узел **Заказы** из окна **Источники данных** на **Form1**.  
  
    > [!NOTE]
    >  Связанный узел **Заказы** расположен под столбцом **Факс** и является дочерним для узла **Клиенты**.  
  
     На форме появляется элемент <xref:System.Windows.Forms.DataGridView> и панель инструментов \(<xref:System.Windows.Forms.BindingNavigator>\) для перемещения по записям.  В области компонентов отображается [OrdersTableAdapter](../data-tools/tableadapter-overview.md) и <xref:System.Windows.Forms.BindingSource>.  
  
## Добавление кода для обновления базы данных  
 Вы можете обновить базу данных, вызвав методы `Update` адаптеров таблицы **Клиенты** и **Заказы**.  По умолчанию обработчик событий для кнопки **Сохранить** <xref:System.Windows.Forms.BindingNavigator> добавляется в код формы для отправки обновлений в базу данных.  Данная процедура изменяет этот код для отправки обновлений в нужном порядке, устраняя возможность возникновения ошибок целостности данных.  Этот код также реализует обработку ошибок, упаковывая вызов обновления в блок try\-catch.  Вы можете изменить этот код в соответствии с потребностями своего приложения.  
  
> [!NOTE]
>  Для ясности в этом пошаговом руководстве не используется транзакция, однако в случае обновления двух и более связанных таблиц следует включить всю логику обновления в транзакцию.  Транзакция — это процесс, который подтверждает успешное внесение связанных изменений в базу данных перед фиксацией изменений.  Для получения дополнительной информации см. [Транзакции и параллелизм](../Topic/Transactions%20and%20Concurrency.md).  
  
#### Добавление логики обновления в приложение  
  
1.  Дважды нажмите кнопку **Сохранить** на <xref:System.Windows.Forms.BindingNavigator>, чтобы открыть редактор кода с обработчиком событий `bindingNavigatorSaveItem_Click`.  
  
2.  Замените код в обработчике событий на вызов методов `Update` связанных адаптеров таблицы.  Следующий код сначала создает три временные таблицы данных для хранения обновленной информации для каждого <xref:System.Data.DataRowState> \(<xref:System.Data.DataRowState>, <xref:System.Data.DataRowState> и <xref:System.Data.DataRowState>\).  После этого выполняются обновления в нужном порядке.  Код должен выглядеть следующим образом:  
  
     [!code-vb[VbRaddataSaving#10](../data-tools/codesnippet/VisualBasic/save-data-to-a-database-multiple-tables_1.vb)]
     [!code-cs[VbRaddataSaving#10](../data-tools/codesnippet/CSharp/save-data-to-a-database-multiple-tables_1.cs)]  
  
## Тестирование приложения  
  
#### Тестирование приложения  
  
1.  Нажмите клавишу F5.  
  
2.  Внесите изменения в данные одной или нескольких записей в каждой таблице.  
  
3.  Нажмите кнопку **Сохранить**.  
  
4.  Проверьте значения в базе данных и убедитесь, что изменения были сохранены.  
  
## Следующие действия  
 В зависимости от требований приложения существуют несколько шагов, которые, возможно, потребуется выполнить после создания формы с привязкой к данным в приложении Windows.  Ниже приводится перечень рекомендаций, позволяющих улучшить полученный результат.  
  
-   Добавление функциональности поиска в форму.  Для получения дополнительной информации см. [Практическое руководство. Добавление параметризованного запроса в приложение Windows Forms](../Topic/How%20to:%20Add%20a%20Parameterized%20Query%20to%20a%20Windows%20Forms%20Application.md).  
  
-   Изменение источника данных для добавления или удаления объектов базы данных.  Для получения дополнительной информации см. [Практическое руководство. Редактирование набора данных](../Topic/How%20to:%20Edit%20a%20Dataset.md).  
  
## См. также  
 [Пошаговые руководства работы с данными](../Topic/Data%20Walkthroughs.md)   
 [Привязка элементов управления Windows Forms к данным в Visual Studio](../data-tools/bind-windows-forms-controls-to-data-in-visual-studio.md)   
 [Общие сведения о приложениях для работы с данными в Visual Studio](../data-tools/overview-of-data-applications-in-visual-studio.md)   
 [Подключение к данным в Visual Studio](../data-tools/connecting-to-data-in-visual-studio.md)   
 [Подготовка приложения к получению данных](../Topic/Preparing%20Your%20Application%20to%20Receive%20Data.md)   
 [Выборка данных в приложение](../data-tools/fetching-data-into-your-application.md)   
 [Привязка элементов управления к данным в Visual Studio](../data-tools/bind-controls-to-data-in-visual-studio.md)   
 [Редактирование данных в приложении](../data-tools/editing-data-in-your-application.md)   
 [Проверка данных](../Topic/Validating%20Data.md)   
 [Сохранение данных](../data-tools/saving-data.md)