---
title: Сохранение данных в базе данных (несколько таблиц)
ms.date: 11/04/2016
ms.topic: conceptual
dev_langs:
- VB
- CSharp
helpviewer_keywords:
- updating datasets, walkthroughs
- data [Visual Studio], saving
- saving data, walkthroughs
- data [Visual Studio], updating
ms.assetid: 7ebe03da-ce8c-4cbc-bac0-a2fde4ae4d07
author: gewarren
ms.author: gewarren
manager: douge
ms.technology: vs-data-tools
ms.workload:
- data-storage
ms.openlocfilehash: 5cb987da516c295ea1b3a5b203a1739a70705ae8
ms.sourcegitcommit: 42ea834b446ac65c679fa1043f853bea5f1c9c95
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 04/19/2018
---
# <a name="save-data-to-a-database-multiple-tables"></a>Сохранение данных в базе данных (несколько таблиц)
Одним из наиболее распространенных сценариев в разработке приложений является отображение данных на форме в приложении Windows, изменение этих данных и отправка обновленных данных обратно в базу данных. Это пошаговое руководство описывает создание формы, отображающей данные из двух связанных таблиц, правку записей и сохранение изменений в базе данных. В данном примере используются таблицы `Customers` и `Orders` из учебной базы данных "Борей".

 Вы можете сохранить данные из приложения в базе данных, вызвав метод `Update` адаптера таблицы. При перетаскивании таблиц из **источники данных** автоматически добавляется на форму, код, необходимый для сохранения данных. Дополнительные таблицы, которые добавляются в форму требуется добавлять вручную этот код. Это пошаговое руководство описывает добавление кода для сохранения обновлений из нескольких таблиц.

> [!NOTE]
>  Диалоговые окна и команды меню могут отличаться от описанных в справке в зависимости от текущих параметров или выпуска, которую вы используете. Чтобы изменить параметры, выберите в меню **Сервис** пункт **Импорт и экспорт параметров** . Дополнительные сведения см. в разделе [Персонализация интегрированной среды разработки Visual Studio](../ide/personalizing-the-visual-studio-ide.md).

 В данном пошаговом руководстве представлены следующие задачи.

-   Создание нового **приложение Windows Forms** проекта.

-   Создание и настройка источника данных в приложении с [мастер настройки источника данных](../data-tools/media/data-source-configuration-wizard.png).

-   Настройка элементов управления из элементов в [окно "Источники данных"](add-new-data-sources.md). Дополнительные сведения см. в разделе [задать элемент управления, создаваемого при перетаскивании из окна источников данных](../data-tools/set-the-control-to-be-created-when-dragging-from-the-data-sources-window.md).

-   Создание элементов управления с привязкой к данным путем перетаскивания элементов из **источники данных** на форму.

-   Изменение нескольких записей в каждой таблице в наборе данных.

-   Изменение кода для отправки обновленных данных в наборе данных обратно в базу данных.

## <a name="prerequisites"></a>Предварительные требования
В этом пошаговом руководстве используется SQL Server Express LocalDB и базе данных Northwind.

1.  Если у вас нет SQL Server Express LocalDB, установите его из [страницы загрузки SQL Server Express](https://www.microsoft.com/sql-server/sql-server-editions-express), либо с помощью **установщик Visual Studio**. Установщик Visual Studio можно установить SQL Server Express LocalDB в рамках **хранения и обработки данных** рабочей нагрузки, или в отдельных компонентов.

2.  Установка образца базы данных Northwind, выполните следующие действия:

    1. В Visual Studio откройте **обозреватель объектов SQL Server** окна. (Обозреватель объектов SQL Server устанавливается как часть **хранения и обработки данных** рабочей нагрузки в установщик Visual Studio.) Разверните **SQL Server** узла. Щелкните правой кнопкой мыши на экземпляре LocalDB и выберите **нового запроса...** .

       Откроется окно редактора запросов.

    2. Копировать [сценарий Northwind Transact-SQL](https://github.com/MicrosoftDocs/visualstudio-docs/blob/master/docs/data-tools/samples/northwind.sql?raw=true) в буфер обмена. Этот скрипт T-SQL создает базу данных Northwind с нуля и заполняет ее данными.

    3. Вставьте скрипт T-SQL в редакторе запросов, а затем выберите **Execute** кнопки.

       Через некоторое время завершения выполнения запроса и создания базы данных "Борей".

## <a name="create-the-windows-forms-application"></a>Создайте приложение Windows Forms
 Первым шагом является создание **приложение Windows Forms**. Присвоение имени проекта является необязательным на этом этапе, но мы будем присвойте ему имя, так как мы будем было сохранить проект.

#### <a name="to-create-the-new-windows-forms-application-project"></a>Создание нового проекта приложения Windows forms

1. В Visual Studio на **файл** последовательно выберите пункты **New**, **проекта...** .

2. Разверните **Visual C#** или **Visual Basic** на левой панели, затем выберите **классического Windows**.

3. В средней области выберите **приложение Windows Forms** тип проекта.

4. Назовите проект **UpdateMultipleTablesWalkthrough**, а затем выберите **ОК**.

     **UpdateMultipleTablesWalkthrough** создается и добавляется в проект **обозревателе решений**.

## <a name="create-the-data-source"></a>Создание источника данных
 Этот шаг создает источник данных из базы данных Northwind с помощью **мастер настройки источника данных**. Для создания подключения необходимо иметь доступ к учебной базе данных "Борей". Сведения об установке образца базы данных Northwind см. в разделе [как: установить образцы баз данных](../data-tools/installing-database-systems-tools-and-samples.md).

#### <a name="to-create-the-data-source"></a>Создание источника данных

1.  На **данные** последовательно выберите пункты **Показать источники данных**.

2.  В **источники данных** выберите**добавить новый источник данных** запуск **мастер настройки источника данных**.

3.  На **Выбор типа источника данных** выберите **базы данных**, а затем выберите **Далее**.

4.  На **Выбор подключения базы данных** экрана выполните одно из следующих:

    -   Если подключение к учебной базе данных Northwind доступно в раскрывающемся списке, то выберите его.

         - или -

    -   Выберите **новое подключение** Открытие **Добавить/изменить подключение** диалоговое окно.

5.  Если базе данных требуется пароль, выберите параметр для включения конфиденциальных данных, а затем выберите **Далее**.

6.  На **Сохранение строки подключения в файле конфигурации приложения**выберите **Далее**.

7.  На **Выбор объектов базы данных**экрана, разверните **таблиц** узла.

8.  Выберите **клиентов** и **заказов** таблицы, а затем выберите **Готово**.

     **NorthwindDataSet** добавляется в проект, и таблицы отображаются в **источники данных** окна.

## <a name="set-the-controls-to-be-created"></a>Набор создаваемых элементов управления
 В этом пошаговом руководстве, данные в `Customers` таблица находится в **сведения** макет, где данные отображаются в отдельных элементах управления. Данные из `Orders` таблица находится в **сетки** макет, который отображается в <xref:System.Windows.Forms.DataGridView> элемента управления.

#### <a name="to-set-the-drop-type-for-the-items-in-the-data-sources-window"></a>Установка типа удаления для элементов в окне "Источники данных"

1.  В **источники данных** окна, разверните **клиентов** узла.

2.  На **клиентов** выберите **сведения** в списке элементов управления, чтобы изменить контроль **клиентов** на отдельные элементы управления. Дополнительные сведения см. в разделе [задать элемент управления, создаваемого при перетаскивании из окна источников данных](../data-tools/set-the-control-to-be-created-when-dragging-from-the-data-sources-window.md).

## <a name="create-the-data-bound-form"></a>Создание формы с привязкой к данным
 Можно создать элементы управления с привязкой к данным путем перетаскивания элементов из **источники данных** на форму.

#### <a name="to-create-data-bound-controls-on-the-form"></a>Создание элементов управления с привязкой к данным на форме

1.  Перетащите главный **клиентов** узел из **источники данных** окна на **Form1**.

     Привязанные к данным элементы управления с метками описания отображаются на форме вместе с панелью инструментов (<xref:System.Windows.Forms.BindingNavigator>) для перемещения по записям. Объект [NorthwindDataSet](../data-tools/dataset-tools-in-visual-studio.md), `CustomersTableAdapter`, <xref:System.Windows.Forms.BindingSource>, и <xref:System.Windows.Forms.BindingNavigator> отображаются в области компонентов.

2.  Перетащите связанный **заказов** узел из **источники данных** окна на **Form1**.

    > [!NOTE]
    >  Связанный **заказов** узел расположен ниже **факс** столбца и является дочерним узлом **клиентов** узла.

     На форме появляется элемент <xref:System.Windows.Forms.DataGridView> и панель инструментов (<xref:System.Windows.Forms.BindingNavigator>) для перемещения по записям. `OrdersTableAdapter` И <xref:System.Windows.Forms.BindingSource> отображаются в области компонентов.

## <a name="add-code-to-update-the-database"></a>Добавление кода для обновления базы данных
 Можно обновить базу данных, вызвав `Update` методы **клиентов** и **заказов** адаптеры таблиц TableAdapter. По умолчанию обработчик событий для **Сохранить** кнопки<xref:System.Windows.Forms.BindingNavigator> добавляется в код формы для отправки обновлений в базу данных. Эта процедура изменяет код для отправки обновлений в правильном порядке. Это позволяет исключить вероятность возникновения ошибок целостности данных. Этот код также реализует обработку ошибок, упаковывая вызов обновления в блок try-catch. Вы можете изменить этот код в соответствии с потребностями своего приложения.

> [!NOTE]
>  Для ясности в данном пошаговом руководстве не используется транзакция. Тем не менее если вы выполняете обновление двух или нескольких связанных таблицах, включить всю логику обновления в транзакцию. Транзакция — это процесс, который подтверждает, что все связанные изменения в базе данных выполнены успешно, прежде чем изменения будут зафиксированы. Дополнительные сведения см. в разделе [транзакции и параллельность](/dotnet/framework/data/adonet/transactions-and-concurrency).

#### <a name="to-add-update-logic-to-the-application"></a>Добавление логики обновления в приложение

1.  Выберите **Сохранить** кнопку <xref:System.Windows.Forms.BindingNavigator>. Откроется редактор кода для `bindingNavigatorSaveItem_Click` обработчика событий.

2.  Замените код в обработчике событий на вызов методов `Update` связанных адаптеров таблицы. Следующий код сначала создает три временные таблицы данных для хранения обновленной информации для каждого <xref:System.Data.DataRowState> (<xref:System.Data.DataRowState.Deleted>, <xref:System.Data.DataRowState.Added> и <xref:System.Data.DataRowState.Modified>). Затем обновления выполняются в правильном порядке. Код должен выглядеть следующим образом:

     [!code-vb[VbRaddataSaving#10](../data-tools/codesnippet/VisualBasic/save-data-to-a-database-multiple-tables_1.vb)]
     [!code-csharp[VbRaddataSaving#10](../data-tools/codesnippet/CSharp/save-data-to-a-database-multiple-tables_1.cs)]

## <a name="test-the-application"></a>Тестирование приложения

#### <a name="to-test-the-application"></a>Тестирование приложения

1.  Выберите **F5**.

2.  Внесите изменения в данные одной или нескольких записей в каждой таблице.

3.  Выберите **Сохранить** кнопки.

4.  Проверьте значения в базе данных и убедитесь, что изменения были сохранены.


## <a name="see-also"></a>См. также

- [Сохранение данных обратно в базу данных](../data-tools/save-data-back-to-the-database.md)