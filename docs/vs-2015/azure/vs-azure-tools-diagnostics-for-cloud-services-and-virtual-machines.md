---
title: Настройка системы диагностики для облачных служб Azure и виртуальных машин | Документация Майкрософт
description: Узнайте, как настроить систему диагностики для отладки Azure облачных служб и виртуальных машин (ВМ) в Visual Studio.
author: mikejo5000
manager: douge
ms.assetid: e70cd7b4-6298-43aa-adea-6fd618414c26
ms.topic: conceptual
ms.workload: azure-vs
ms.date: 06/28/2018
ms.author: mikejo
ms.prod: visual-studio-dev14
ms.technology: vs-azure
ms.openlocfilehash: 4448825c5d443887833a405aab14d2243a0e5216
ms.sourcegitcommit: e481d0055c0724d20003509000fd5f72fe9d1340
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 11/05/2018
ms.locfileid: "51003074"
---
# <a name="set-up-diagnostics-for-azure-cloud-services-and-virtual-machines"></a>Настройка системы диагностики для облачных служб и виртуальных машин Azure
Если необходимо устранить неполадки в облачной службе Azure или виртуальных машинах, можно использовать Visual Studio для быстрой настройки системы диагностики Azure. Диагностики собирает системные данные и данные журналов с виртуальных машин и экземпляров виртуальных машин, работающих в облачной службе. Диагностические данные передаются выбранную вами учетную запись хранения. Дополнительные сведения о диагностике ведения журналов в Azure, см. в разделе [Включение ведения журнала диагностики для веб-приложений в службе приложений Azure](/azure/app-service/web-sites-enable-diagnostic-log).

В этой статье мы покажем, как использовать Visual Studio для включения и настройки системы диагностики Azure, до и после развертывания. Узнайте, как настроить систему диагностики на виртуальных машинах Azure, как выбирать типы собираемых диагностических данных и как просматривать информацию после сбора.

Для настройки системы диагностики Azure можно использовать один из следующих вариантов:

* Изменить параметры диагностики в **конфигурации диагностики** диалоговое окно в Visual Studio. Параметры сохраняются в файл с именем diagnostics.wadcfgx (в Azure SDK 2.4 и более ранних файл назывался diagnostics.wadcfg). Вы также можете напрямую изменить файл конфигурации. Если вы измените вручную файл, конфигурации изменения вступят в силу при следующем развертывании облачной службы в Azure или запуске службы в эмуляторе.
* Используйте Cloud Explorer или обозревателя серверов в Visual Studio, чтобы изменить параметры диагностики для облачной службы или виртуальной машины, на котором выполняется.

## <a name="azure-sdk-26-diagnostics-changes"></a>Изменения системы диагностики Azure SDK 2.6
Следующие изменения применяются к Azure SDK 2.6 и более поздних версий проектов в Visual Studio.

* Локальный эмулятор теперь поддерживает систему диагностики. Это означает, что можно собирать диагностические данные и убедиться, что приложение создает правильные трассировки во время разработки и тестирования в Visual Studio. Строка подключения `UseDevelopmentStorage=true` включает сбор данных диагностики при запуске проекта облачной службы в Visual Studio с помощью эмулятора хранения Azure. Все диагностические данные собираются в учетную запись хранилища разработки.
* Строка подключения учетной записи хранения диагностики `Microsoft.WindowsAzure.Plugins.Diagnostics.ConnectionString` хранится в файле конфигурации (cscfg) службы. В пакете Azure SDK 2.5 учетную запись хранения диагностики указывается в файле diagnostics.wadcfgx.

Строка подключения по-разному работает в некоторых случаях в пакете Azure SDK 2.6 и выше, чем в Azure SDK 2.4 и более ранних версий:

* В Azure SDK 2.4 и более ранних версиях строка подключения используется как среда выполнения подключаемого модуля диагностики — Чтобы получить сведения об учетной записи хранения для передачи журналов диагностики.
* В пакете Azure SDK 2.6 и более поздних версиях Visual Studio использует строку подключения диагностики для настройки расширения диагностики Azure с помощью данные учетной записи хранения во время публикации. Строку подключения можно использовать для определения различных учетных записей хранения для разных конфигураций службы, которые Visual Studio использует во время публикации. Тем не менее поскольку подключаемый модуль диагностики не поддерживается после пакета Azure SDK 2.5, cscfg-файле сам по себе не удается настроить расширение системы диагностики. Необходимо настроить расширение отдельно с помощью таких средств, как Visual Studio или PowerShell.
* Чтобы упростить процесс настройки расширения диагностики с помощью PowerShell, выходные данные пакета Visual Studio включает общедоступный XML-ФАЙЛ конфигурации для расширения диагностики для каждой роли. Visual Studio использует строку подключения диагностики для заполнения из общедоступной конфигурации данные учетной записи хранения. Общедоступные файлы конфигураций создаются в папке Extensions. Общедоступные файлы конфигураций используют шаблон именования PaaSDiagnostics. &lt;имя роли\>. PubConfig.xml. Все развертывания, на основе PowerShell могут использовать этот шаблон для сопоставления каждой конфигурации роли.
* [Портала Azure](http://go.microsoft.com/fwlink/p/?LinkID=525040) использует строку подключения в cscfg-файле для доступа к данным диагностики. Данные появляются на **мониторинг** вкладки. Строку подключения необходимо настроить в службе отображение подробных данных мониторинга на портале.

## <a name="migrate-projects-to-azure-sdk-26-and-later"></a>Перенос проектов на Azure SDK 2.6 и более поздних версий
При миграции из пакета Azure SDK 2.5 на Azure SDK 2.6 или более поздней версии, если у вас есть учетная запись хранения диагностики, указанные в wadcfgx-файле, она остается в этом файле. Чтобы воспользоваться преимуществами гибкости использования различных учетных записей хранения для разных конфигураций хранилища, вручную добавьте строку подключения в проект. При переносе проекта из пакета SDK Azure 2.4 или более ранней версии в пакете Azure SDK 2.6, строки подключения диагностики сохраняются. Тем не менее Обратите внимание на изменения, в том, как обрабатываются строки подключения в Azure SDK 2.6, описанные в предыдущем разделе.

### <a name="how-visual-studio-determines-the-diagnostics-storage-account"></a>Определение учетной записи хранения диагностики с помощью Visual Studio
* Если строка подключения диагностики указан в файле cscfg, Visual Studio использует ее для настройки расширения диагностики во время публикации, а также при создании общедоступных XML файлов конфигурации во время упаковки.
* Если в cscfg-файле строка подключения диагностики не указан, Visual Studio возвращается использованию учетной записи хранения, которая указана в wadcfgx-файле для настройки расширения диагностики для публикации, а также для создания XML-ФАЙЛ общедоступной конфигурации файлы во время упаковки.
* Строка подключения диагностики в cscfg-файле имеет приоритет над учетной записи хранения в wadcfgx-файле. Если строка подключения диагностики в cscfg-файле, Visual Studio использует эту строку подключения и игнорирует учетной записи хранения в wadcfgx-файле.

### <a name="what-does-the-update-development-storage-connection-strings-check-box-do"></a>Что делает флажок «Обновлять строки подключения хранилища разработки...»?
**Обновлять строки подключения хранилища разработки для диагностики и кэширования с учетными данными учетной записи хранения Microsoft Azure при публикации в Microsoft Azure** флажок является удобным способом для обновления любого хранилища разработки строки подключения учетной записи с учетной записью хранения Azure, указанной во время публикации.

Например, если выбрать этот флажок и строки подключения диагностики указывает `UseDevelopmentStorage=true`при публикации проекта в Azure, Visual Studio автоматически заменит строки подключения диагностики учетной записью хранения, указанной в Мастер публикации. Тем не менее если строка подключения диагностики указана реальная учетная запись хранения, эта учетная запись будет использовано.

## <a name="diagnostics-functionality-differences-in-azure-sdk-24-and-earlier-vs-azure-sdk-25-and-later"></a>Функциональные различия диагностики в Azure SDK 2.4 и более ранних vs. Пакет Azure SDK 2.5 и более поздние версии
Если вы обновляете проект с Azure SDK 2.4 и более ранних версий на Azure SDK 2.5 или более поздней версии, не забывайте следующих функциональных различиях диагностики:

* **API конфигурации устарели**. Программная конфигурация диагностики доступна в Azure SDK 2.4 и более ранних, но является устаревшим в пакете Azure SDK 2.5 и более поздних версий. Если в конфигурацию системы диагностики в настоящее время определяется в коде, необходимо перенастроить эти параметры с нуля переноса проекта для диагностики, чтобы продолжить работу. Файл конфигурации диагностики для Azure SDK 2.4 — diagnostics.wadcfg. Файл конфигурации диагностики Azure SDK 2.5 и более поздние версии — diagnostics.wadcfgx.
* **Диагностику для приложений облачной службы можно настроить только на уровне роли**. Пакет SDK Azure 2.5 и более поздних версиях нельзя настроить диагностику для приложений облачной службы на уровне экземпляра.
* **Каждый раз при развертывании приложения, конфигурация диагностики обновляется**. Это может вызвать проблемы с контролем четности, если изменить конфигурацию диагностики в обозревателе серверов Visual Studio и повторно развернуть приложение.
* **Пакет SDK Azure 2.5 и более поздних версиях аварийные дампы настраиваются в файле конфигурации диагностики, а не в коде**. Имея аварийные дампы настроены в коде, необходимо вручную перенести параметры из кода в файле конфигурации. Аварийные дампы не перемещаются во время миграции на Azure SDK 2.6.

## <a name="turn-on-diagnostics-in-cloud-service-projects-before-you-deploy-them"></a>Включение диагностики в проектах облачных служб перед их развертыванием
В Visual Studio можно собирать диагностические данные для ролей, выполняемых в Azure, при запуске службы в эмуляторе перед ее развертыванием. Все изменения в параметры диагностики в Visual Studio сохраняются в файле конфигурации diagnostics.wadcfgx. Эти параметры определяют учетную запись хранения, где сохраняются диагностические данные при развертывании облачной службы.

[!INCLUDE [cloud-services-wad-warning](./includes/cloud-services-wad-warning.md)]

### <a name="to-turn-on-diagnostics-in-visual-studio-before-deployment"></a>Включение диагностики в Visual Studio перед развертыванием

1. В контекстном меню для роли, выберите **свойства**. В этой роли **свойства** выберите **конфигурации** вкладки.
2. В **диагностики** разделе, убедитесь, что **включить диагностику** установлен флажок.
   
    ![Доступ к параметру "Включить диагностику"](./media/vs-azure-tools-diagnostics-for-cloud-services-and-virtual-machines/IC796660.png)
3. Укажите учетную запись хранения для данных диагностики, нажмите кнопку с многоточием (...).
   
    ![Укажите учетную запись хранения для использования](./media/vs-azure-tools-diagnostics-for-cloud-services-and-virtual-machines/IC796661.png)
4. В **Создание строки подключения хранилища** диалоговом окне укажите ли вы хотите подключить с помощью эмулятора хранения Azure, подписка Azure или ручной ввод учетных данных.
   
    ![Диалоговое окно учетной записи хранения](./media/vs-azure-tools-diagnostics-for-cloud-services-and-virtual-machines/IC796662.png)
   
   * При выборе **эмулятор хранилища Microsoft Azure**, строка подключения имеет значение `UseDevelopmentStorage=true`.
   * При выборе **подписке**, можно выбрать подписку Azure, которую вы хотите использовать и введите имя учетной записи. Чтобы управлять подписками Azure, выберите **управление учетными записями**.
   * При выборе **ручной ввод учетных данных**, введите имя и ключ учетной записи Azure, который вы хотите использовать.
5. Чтобы просмотреть **конфигурации диагностики** выберите **Настройка**. За исключением **Общие** и **каталоги журналов**, каждая вкладка представляет определенному источнику диагностических данных, которые можно собирать. Значение по умолчанию **Общие** вкладке предлагает следующие диагностики параметров сбора данных: **только ошибки**, **всю информацию**, и **пользовательский план**. Значение по умолчанию **только ошибки** используется наименьший объем хранилища, так как он не переносятся, предупреждения и сообщения трассировки. **Всю информацию** передает больше всего информации, использует объем хранилища и таким образом, вариант является наиболее затратным.

   > [!NOTE]
   > Минимальный поддерживаемый размер «Диск квоты в МБ» составляет 4 ГБ. Тем не менее если выполняется сбор дампов памяти, увеличьте до более высокое значение, как и 10 ГБ.
   >
  
    ![Включение и настройка диагностики Azure](./media/vs-azure-tools-diagnostics-for-cloud-services-and-virtual-machines/IC758144.png)
6. В этом примере выберите **пользовательский план** параметр, вы можете настроить собранные данные.
7. В **Квота диска в МБ** поле, можно задать как объем дискового пространства необходимо выделить в учетной записи хранения для диагностических данных. Можно изменить или принять значение по умолчанию.
8. На каждой вкладке данных диагностики, которые требуется собрать, установите **включить передачу \<тип_журнала\>**  "флажок". Например, если вы хотите собирать журналы приложений, на **журналы приложений** выберите **включить передачу журналов приложения** "флажок". Кроме того укажите другие сведения, которые требуются для каждого типа диагностических данных. Сведения о конфигурации для каждой вкладки, см. в разделе **Настройка источников диагностических данных** далее в этой статье. 
9. После включения сбора диагностических данных, необходимо, выберите **ОК**.
10. Запустите ваш проект облачной службы Azure в Visual Studio обычным образом. При использовании приложения, данные журнала, которые вы включили сохраняется для указанной учетной записи хранения Azure.

## <a name="turn-on-diagnostics-on-azure-virtual-machines"></a>Включение диагностики на виртуальных машинах Azure
В Visual Studio вы можете собирать диагностические данные для виртуальных машин Azure.

### <a name="to-turn-on-diagnostics-on-azure-virtual-machines"></a>Чтобы включить диагностику на виртуальных машинах Azure

1. В обозревателе сервера выберите узел Azure и подключитесь к подписке Azure, если вы еще не подключены.
2. Разверните **виртуальных машин** узла. Можно создать виртуальную машину или выбрать имеющийся узел.
3. В контекстном меню для виртуальной машины, необходимо выбрать **Настройка**. Откроется диалоговое окно конфигурации виртуальной машины.
   
    ![Настройка виртуальной машины Azure](./media/vs-azure-tools-diagnostics-for-cloud-services-and-virtual-machines/IC796663.png)
4. Если он еще не установлен, добавьте расширение Microsoft Monitoring Agent Diagnostics. Это расширение позволяет собирать диагностические данные для виртуальной машины Azure. В разделе **установленные расширения**в **выберите доступное расширение** выберите в раскрывающемся списке выберите **Microsoft Monitoring Agent Diagnostics**.
   
    ![Установить расширение виртуальной машины Azure](./media/vs-azure-tools-diagnostics-for-cloud-services-and-virtual-machines/IC766024.png)
   
    > [!NOTE]
   > Другие расширения системы диагностики доступны для виртуальных машин. Дополнительные сведения см. в разделе [расширений виртуальной машины и компонентов для Windows](https://docs.microsoft.com/azure/virtual-machines/windows/extensions-features).
   > 
   > 
5. Чтобы добавить расширение и просмотреть его **конфигурации диагностики** выберите **добавить**.
6. Чтобы указать учетную запись хранения, выберите **Настройка**, а затем выберите **ОК**.
   
    Каждая вкладка (за исключением **Общие** и **каталоги журналов**) соответствует определенному источнику диагностических данных, которые можно собирать.
   
    ![Включение и настройка диагностики Azure](./media/vs-azure-tools-diagnostics-for-cloud-services-and-virtual-machines/IC758144.png)
   
    На вкладке по умолчанию **Общие**, предлагает следующие режимы сбора диагностических данных: **только ошибки**, **всю информацию**, и **пользовательский план**. Параметр по умолчанию, **только ошибки**, занимает наименьший объем хранилища, так как он не переносятся, предупреждения и сообщения трассировки. **Всю информацию** параметр передается больше всего информации; это таким образом, наиболее затратный по объему хранения вариант.
7. В этом примере выберите **пользовательский план** параметр, вы можете настроить данные.
8. **Квота диска в МБ** определяет, сколько места, которые нужно выделить в учетной записи хранения для диагностических данных. Если требуется, можно изменить значение по умолчанию.
9. На каждой вкладке данных диагностики, которые требуется собрать, установите его **включить передачу \<тип_журнала\>**  "флажок".
   
    Например, если вы хотите собирать журналы приложений, выберите **включить передачу журналов приложения** флажок на **журналы приложений** вкладки. Кроме того укажите другие сведения, необходимые для каждого типа диагностических данных. Сведения о конфигурации для каждой вкладки, см. в разделе **Настройка источников диагностических данных** далее в этой статье.
10. После включения сбора диагностических данных, которые вы хотите, выберите **ОК**.
11. Сохраните обновленный проект.
    
    Сообщения в **журнал действий Microsoft Azure** окно указывает, что виртуальная машина была обновлена.

## <a name="set-up-diagnostics-data-sources"></a>Настройка источников диагностических данных
Включив сбор диагностических данных, вы можете точно, какие источники данных, которые требуется собрать, и какие сведения собираются. В следующих разделах содержатся сведения о вкладках в **конфигурации диагностики** диалоговое окно и описание каждого параметра.

### <a name="application-logs"></a>Журналы приложений
Журналы приложений содержат диагностические данные, созданные веб-приложения. Если вы хотите собирать журналы приложений, выберите **включить передачу журналов приложения** "флажок". Чтобы увеличить или уменьшить интервал между перемещениями журналов приложений в вашей учетной записи хранения, измените **период передачи (мин)** значение. Также можно изменить объем сведений, сохраняемых в журнале, установив **уровень ведения журнала** значение. Например, выберите **Verbose** для получения дополнительных сведений или выберите **критическое** только критические ошибки. Если у вас есть определенный провайдер диагностических данных, создающий журналы приложений, вы можете собирать журналы, добавив GUID поставщика в **GUID поставщика** поле.

  ![Журналы приложений](./media/vs-azure-tools-diagnostics-for-cloud-services-and-virtual-machines/IC758145.png)

Дополнительные сведения о журналах приложений см. в разделе [Включение ведения журнала диагностики для веб-приложений в службе приложений Azure](/azure/app-service/web-sites-enable-diagnostic-log).

### <a name="windows-event-logs"></a>Журналы событий Windows
Чтобы собирать журналы событий Windows, установите **включить перемещение журналов событий Windows** "флажок". Чтобы увеличить или уменьшить интервал между перемещениями журналов событий в вашей учетной записи хранения, измените **период передачи (мин)** значение. Установите флажки для типов событий, которые вы хотите отслеживать.

![Журналы событий](./media/vs-azure-tools-diagnostics-for-cloud-services-and-virtual-machines/IC796664.png)

Если вы используете пакет Azure SDK 2.6 или более поздней версии, и вы хотите указать пользовательский источник данных, введите его в **\<имя источника данных\>** текстовое поле, а затем выберите **добавить**. Источник данных добавляется в файл diagnostics.cfcfg.

Если вы используете Azure SDK 2.5 и хотите указать пользовательский источник данных, его можно добавить к `WindowsEventLog` diagnostics.wadcfgx в раздел файла, как в следующем примере:

```
<WindowsEventLog scheduledTransferPeriod="PT1M">
   <DataSource name="Application!*" />
   <DataSource name="CustomDataSource!*" />
</WindowsEventLog>
```
### <a name="performance-counters"></a>Счетчики производительности.
Сведений о счетчиках производительности помогут вам найти узкие места и оптимизировать производительность системы и приложения. Дополнительные сведения см. в разделе [Создание и использование счетчиков производительности в приложении Azure](https://msdn.microsoft.com/library/azure/hh411542.aspx). Чтобы собирать счетчики производительности, установите **включить перемещение счетчиков производительности** "флажок". Чтобы увеличить или уменьшить интервал между перемещениями журналов событий в вашей учетной записи хранения, измените **период передачи (мин)** значение. Установите флажки для счетчиков производительности, которые вы хотите отслеживать.

![Счетчики производительности.](./media/vs-azure-tools-diagnostics-for-cloud-services-and-virtual-machines/IC758147.png)

Чтобы отслеживать счетчик производительности, который отсутствует в списке, введите счетчик производительности с помощью предложенного синтаксиса. а затем выберите **добавить**. Какие счетчики производительности, вы можете отслеживать определяется операционной системой на виртуальной машине. Дополнительные сведения о синтаксисе см. в разделе [укажите путь к счетчику](https://msdn.microsoft.com/library/windows/desktop/aa373193.aspx).

### <a name="infrastructure-logs"></a>Журналы инфраструктуры
Журналы инфраструктуры содержат сведения об инфраструктуре диагностики Azure, модуле RemoteAccess и remoteforwarder. Для сбора данных о журналах инфраструктуры установите **включить передачу журналов инфраструктуры** "флажок". Чтобы увеличить или уменьшить интервал между перемещениями журналов инфраструктуры в вашей учетной записи хранения, измените **период передачи (мин)** значение.

![Журналы инфраструктуры диагностики](./media/vs-azure-tools-diagnostics-for-cloud-services-and-virtual-machines/IC758148.png)

Дополнительные сведения см. в разделе [сбор данных журналов с помощью системы диагностики Azure](https://msdn.microsoft.com/library/azure/gg433048.aspx).

### <a name="log-directories"></a>Каталоги журналов
Каталоги журналов содержат данные, собранные из каталогов журналов для запросов, невыполненных запросов или выбранных папок Internet Information Services (IIS). Чтобы записать каталоги журналов, выберите **включить перемещение каталогов журналов** "флажок". Чтобы увеличить или уменьшить интервал между перемещениями журналов для учетной записи хранения, измените **период передачи (мин)** значение.

Установите флажки для журналов, которые вы хотите собирать, например **журналы IIS** и **неудачно завершенных запросов** журналы. Имена контейнеров хранилища по умолчанию предоставляются, но можно изменить имена.

Вы можете собирать журналы из любой папки. Укажите путь в **журнал из абсолютного каталога** , а затем выберите **добавить каталог**. Журналы сохраняются в указанные контейнеры.

![Каталоги журналов](./media/vs-azure-tools-diagnostics-for-cloud-services-and-virtual-machines/IC796665.png)

### <a name="etw-logs"></a>Журналы трассировки событий Windows
Если вы используете [трассировки событий для Windows](https://msdn.microsoft.com/library/windows/desktop/bb968803\(v=vs.85\).aspx) (ETW) и хотите записать журналы трассировки событий Windows, выберите **включить передачу журналов ETW** "флажок". Чтобы увеличить или уменьшить интервал между перемещениями журналов для учетной записи хранения, измените **период передачи (мин)** значение.

События записываются из источников событий и манифестов событий, указываемые. Чтобы указать источник события в **источники событий** раздел, введите имя и выберите **добавить источник событий**. Аналогичным образом можно указать манифест событий в **манифесты событий** , а затем выберите **добавить манифест событий**.

![Журналы трассировки событий Windows](./media/vs-azure-tools-diagnostics-for-cloud-services-and-virtual-machines/IC766025.png)

Инфраструктура ETW поддерживается в ASP.NET через классы в [System.Diagnostics.aspx](https://msdn.microsoft.com/library/system.diagnostics(v=vs.110)) пространства имен. Пространство имен Microsoft.WindowsAzure.Diagnostics, которое наследует и расширяет стандартные [System.Diagnostics.aspx](https://msdn.microsoft.com/library/system.diagnostics(v=vs.110)) классы, позволяет использовать [System.Diagnostics.aspx](https://msdn.microsoft.com/library/system.diagnostics(v=vs.110)) как ведение журнала Платформа, в среде Azure. Дополнительные сведения см. в разделе [контроль ведения журналов и трассировкой в Microsoft Azure](https://msdn.microsoft.com/magazine/ff714589.aspx) и [включение диагностики в облачных службах Azure и виртуальных машин](/azure/cloud-services/cloud-services-dotnet-diagnostics).

### <a name="crash-dumps"></a>Аварийные дампы
Чтобы собирать сведения об аварийном завершении работы экземпляра роли, установите **включить перемещение аварийных дампов** "флажок". (Так как ASP.NET обрабатывает большинство исключений, обычно это полезно только для рабочих ролей.) Чтобы увеличить или уменьшить процент выделяемого под аварийные дампы места в хранилище, измените **Квота каталога (%)** значение. Можно изменить контейнер хранилища, в котором хранятся аварийные дампы и выберите ли вы хотите собирать **полный** или **Mini** дампа.

Отслеживаемые процессы, перечислены на следующем снимке экрана. Установите флажки для процессов, которые необходимо записать. Чтобы добавить другой процесс в список, введите имя процесса, а затем выберите **добавить процесс**.

![Аварийные дампы](./media/vs-azure-tools-diagnostics-for-cloud-services-and-virtual-machines/IC766026.png)

Дополнительные сведения см. в разделе [контроль ведения журналов и трассировкой в Microsoft Azure](https://msdn.microsoft.com/magazine/ff714589.aspx) и [диагностики Microsoft Azure. часть 4: настраиваемые компоненты ведения журнала и диагностики Azure 1.3 изменения](http://justazure.com/microsoft-azure-diagnostics-part-4-custom-logging-components-azure-diagnostics-1-3-changes/).

## <a name="view-the-diagnostics-data"></a>Просмотр диагностических данных
После сбора данных диагностики для облачной службы или виртуальной машины, можно просмотреть его.

### <a name="to-view-cloud-service-diagnostics-data"></a>Для просмотра диагностических данных облачной службы
1. Развернуть облачную службу как обычно и затем запустите его.
2. Можно просмотреть данные диагностики в отчете, который создается в Visual Studio или в таблицах в учетной записи хранения. Представление данных в отчете, откройте Cloud Explorer или обозревателе сервера откройте контекстное меню узла для роли, а затем выберите **Просмотр диагностических данных**.
   
    ![Просмотр данных диагностики](./media/vs-azure-tools-diagnostics-for-cloud-services-and-virtual-machines/IC748912.png)
   
    Отображается отчет, показывающий доступных данных.
   
    ![Отчет системы диагностики Microsoft Azure в Visual Studio](./media/vs-azure-tools-diagnostics-for-cloud-services-and-virtual-machines/IC796666.png)
   
    Если самые последние данные не отображается, возможно, для ожидания очередного периода передачи.
   
    Чтобы немедленно обновить данные, выберите **обновить** ссылку. Чтобы автоматического обновления данных, выберите интервал в **автообновления** поле с раскрывающимся списком. Чтобы экспортировать данные об ошибке, выберите **Экспорт в CSV-ФАЙЛ** кнопку, чтобы создать CSV-файл, который можно открыть в листе Excel.
   
    В Cloud Explorer или обозревателе сервера откройте учетную запись хранения, связанную с развертыванием.
3. Откройте диагностические таблицы в средстве просмотра таблиц, а затем просмотрите собранные данные. Журналы IIS и настраиваемые журналы можно открыть контейнер больших двоичных объектов. В следующей таблице перечислены таблиц или контейнеров больших двоичных объектов, содержащих данные для различных файлах журналов. В дополнение к данным для данного файла журнала таблицы содержат **EventTickCount**, **DeploymentId**, **роли**, и **RoleInstance** , чтобы помочь вам понять, какая виртуальная машина и роль создали данные и когда. 
   
   | Диагностические данные | Описание | Расположение |
   | --- | --- | --- |
   | Журналы приложений |Журналы, которые ваш код создает, вызывая методы класса **System.Diagnostics.Trace** класса. |WADLogsTable |
   | Журналы событий |Данные из журналов событий Windows на виртуальных машинах. Windows в этих журналах хранится информация, но приложения и службы также использовать журналы для сообщения об ошибках или журнал сведения. |WADWindowsEventLogsTable |
   | Счетчики производительности. |Можно собирать данные с любого счетчика производительности, который доступен на виртуальной машине. Операционная система предоставляет счетчики производительности, которые позволяют изучать всевозможную статистику, например использование памяти и процессора загруженность. |WADPerformanceCountersTable |
   | Журналы инфраструктуры |Журналы, созданные из сама инфраструктура диагностики. |WADDiagnosticInfrastructureLogsTable |
   | Журналы IIS |Журналы, которые записываются веб-запросы. Если облачная служба получает значительный объем трафика, эти журналы могут быть длинными. Рекомендуется собирать и хранить эти данные только в том случае, когда она нужна. |Можно найти журналы неудачных запросов в BLOB-контейнере wad-iis-failedreqlogs, по пути для этого развертывания, роли и экземпляра. Вы найдете полные журналы в wad-iis-logfiles. В таблицу WADDirectories вносятся записи для каждого файла. |
   | Аварийные дампы |Предоставляет двоичные образы процесса облачной службы (обычно рабочей роли). |контейнер больших двоичных объектов wad-crush-dumps |
   | Файлы пользовательских журналов |Настроенные вами журналы. |Можно указать в коде расположение файлов пользовательских журналов в учетной записи хранения. Например можно указать контейнер пользовательских больших двоичных объектов. |
4. Если данные любого типа усекаются, попробуйте увеличить размер буфера для данных типа или уменьшить интервал между передачами данных из виртуальной машины в вашей учетной записи хранения.
5. (Необязательно) Удалите данные из учетной записи хранения, время от времени, чтобы снизить общие затраты на хранение.
6. При выполнении полного развертывания обновляет файл diagnostics.cscfg (Diagnostics.wadcfgx Azure SDK 2.5) обновляется в Azure, и облачная служба принимает все изменения, внесенные в конфигурацию диагностики. Если вы обновляете существующее развертывание, Azure не обновляет cscfg-файле. Параметры диагностики, по-прежнему можно изменить, выполнив действия, описанные в следующем разделе. Дополнительные сведения о полном развертывании и обновлении существующего развертывания, см. в разделе [мастер публикации приложений Azure](vs-azure-tools-publish-azure-application-wizard.md).

### <a name="to-view-virtual-machine-diagnostics-data"></a>Чтобы просмотреть данные диагностики виртуальной машины
1. В контекстном меню для виртуальной машины, выберите **Просмотр данных диагностики**.
   
    ![Просмотр диагностических данных на виртуальной машине Azure](./media/vs-azure-tools-diagnostics-for-cloud-services-and-virtual-machines/IC766027.png)
   
    **Сводка диагностики** откроется диалоговое окно.
   
    ![Сводка по диагностическим данным виртуальной машины Azure](./media/vs-azure-tools-diagnostics-for-cloud-services-and-virtual-machines/IC796667.png)  
   
    Если самые последние данные не отображается, возможно, для ожидания очередного периода передачи.
   
    Чтобы немедленно обновить данные, выберите **обновить** ссылку. Чтобы автоматического обновления данных, выберите интервал в **автообновления** поле с раскрывающимся списком. Чтобы экспортировать данные об ошибке, выберите **Экспорт в CSV-ФАЙЛ** кнопку, чтобы создать CSV-файл, который можно открыть в листе Excel.

## <a name="set-up-cloud-service-diagnostics-after-deployment"></a>Настройка диагностики облачной службы после развертывания
Если вы изучаете проблему с облачной службой, на котором уже выполняется, можно собирать данные, которые не были указаны перед первоначальным развертыванием этой роли. В этом случае можно начинать сбор этих данных, изменив параметры в обозревателе серверов. Можно настроить диагностику для одного экземпляра или для всех экземпляров в роли, следует открыть **конфигурации диагностики** диалоговое окно, в контекстном меню для экземпляра или роли. Если вы настраиваете в узле роли, любые сделанные изменения применяются ко всем экземплярам. Если вы настраиваете в узле экземпляра, все изменения, внесенные применяются только к этому экземпляру.

### <a name="to-set-up-diagnostics-for-a-running-cloud-service"></a>Для настройки системы диагностики для работающей облачной службы
1. В обозревателе сервера разверните **облачных служб** узел, а затем разверните список узлы, найдите роль или экземпляр (или оба), которое необходимо изучить.
   
    ![Настройка диагностики](./media/vs-azure-tools-diagnostics-for-cloud-services-and-virtual-machines/IC748913.png)
2. В контекстном меню для узла экземпляра или роли, выберите **обновить параметры диагностики**, а затем выберите параметры диагностики, которые требуется собрать.
   
    Сведения о параметрах конфигурации см. в разделе **Настройка источников диагностических данных** в этой статье. Сведения о том, как просмотреть данные диагностики, см. в разделе **Просмотр диагностических данных** в этой статье.
   
    При изменении параметров сбора данных в обозревателе серверов, изменения остаются в силе до следующего полного развертывания облачной службы. Если вы используете стандартные параметры публикации, изменения не перезаписываются. По умолчанию при публикации для обновления существующего развертывания, а не полное повторное развертывание сделать. Чтобы убедиться, что эти параметры были сброшены во время развертывания, перейдите в раздел **Дополнительные параметры** вкладку в мастере публикации, а затем снимите **обновление развертывания** "флажок". При повторном развертывании со снятым флажком, параметры вернитесь к использованию в wadcfgx-файле- или wadcfg-файле через **свойства** редактор для роли. Если вы обновляете развертывание, Azure сохраняет старые настройки.

## <a name="troubleshoot-azure-cloud-service-issues"></a>Устранение неполадок облачной службы Azure
Если возникли проблемы с проектах облачных служб, такие как роли зависает в состоянии «занято», постоянно перезапускается или выдает внутреннюю ошибку сервера, существуют средства и методы, которые можно использовать для диагностики и устранения проблемы. Конкретные примеры распространенных проблем и решений и общие сведения о концепциях и инструментах, которые можно использовать для диагностики и устранения этих ошибок, см. в разделе [данные диагностики вычислений Azure PaaS](http://blogs.msdn.com/b/kwill/archive/2013/08/09/windows-azure-paas-compute-diagnostics-data.aspx).

## <a name="q--a"></a>Вопросы и ответы
**Что такое размер буфера, и должен быть его как размер?**

Для каждого экземпляра виртуальной машины квоты ограничивают объем данных диагностики, которые могут храниться в локальной файловой системе. Кроме того вы определяете размер буфера для каждого типа диагностических данных, которая доступна. Этот буфер выполняет роль индивидуальной квоты для соответствующего типа данных. Чтобы определить общую квоту и объем свободной памяти, см. в разделе в нижней части диалогового окна для типа диагностических данных. Если указать большие размеры буферов или большее количество типов данных, можно превысить общую квоту. Общую квоту можно изменить путем изменения файла конфигурации diagnostics.wadcfg или Diagnostics.wadcfgx. Диагностические данные хранятся в той же файловой системе, как данные приложения. Если приложение использует много места на диске, не следует увеличивать общую квоту для диагностики.

**Что такое период передачи, и сколько времени он должен быть?**

Период передачи определяет количество времени, который фиксирует промежутка между данными. По окончании каждого периода передачи данных перемещается из локальной файловой системы на виртуальной машине с таблицами в вашей учетной записи хранения. Если объем собираемых данных превышает квоту до окончания периода передачи, старые данные удаляются. Если вы теряете данные из-за превышения размера буфера или общей квоты, можно уменьшить период передачи.

**Какой часовой пояс используется для отметок времени?**

В отметках времени локальный часовой пояс того центра обработки данных, на котором размещена облачная служба. Используются следующие три столбца отметки времени в таблицы журнала:

* **PreciseTimeStamp**: метка времени события ETW. То есть время, то событие заносится от клиента.
* **Метка времени**: значение **PreciseTimeStamp** округлением до границы частоты передачи. Например если вы используете период передачи 5 минут, а событие регистрируется в 00:17:12, метка времени — 00:15:00.
* **Метка времени**: метка времени, по которому объект был создан в таблице Azure.

**Как управлять затратами при сборе диагностической информации?**

Параметры по умолчанию (**уровень ведения журнала** присвоено **ошибка**, и **период передачи** присвоено **1 минута**) предназначены для минимизации расходов. Ваши затраты на вычисления увеличиваются, если вы собираете больше диагностических данных или уменьшаете период передачи. Не следует собирать больше данных, чем требуется и не забудьте отключить сбор данных, когда он больше не нужен. Вы можете всегда включить его снова, даже во время выполнения, как описано ранее в этой статье.

**Как собирать журналы неудачных запросов из IIS?**

По умолчанию службы IIS не собирают журналы неудачных запросов. Можно настроить IIS, чтобы собирать журналы неудачных запросов, изменив файл web.config для веб-роли.

**Я не получаю сведения о трассировке от методов RoleEntryPoint, например OnStart. В чем проблема?**

Методы **RoleEntryPoint** вызываются в контексте WAIISHost.exe, а не в службах IIS. Сведения о конфигурации в файле web.config, который обычно включает трассировку не применяется. Чтобы устранить эту проблему, добавьте проект веб-роли config-файл и назовите файл для сопоставления выходных данных сборки, содержащей **RoleEntryPoint** кода. В проект веб-роли по умолчанию config-файл должен называться WAIISHost.exe.config. Добавьте следующие строки в этот файл:

```
<system.diagnostics>
  <trace>
      <listeners>
          <add name “AzureDiagnostics” type=”Microsoft.WindowsAzure.Diagnostics.DiagnosticMonitorTraceListener”>
              <filter type=”” />
          </add>
      </listeners>
  </trace>
</system.diagnostics>
```

В **свойства** окне **Копировать в выходной каталог** свойства **всегда Копировать**.

## <a name="next-steps"></a>Следующие шаги
Дополнительные сведения о ведении журналов диагностики в Azure, см. в разделе [включение диагностики в облачных службах Azure и виртуальных машин](/azure/cloud-services/cloud-services-dotnet-diagnostics.md) и [Включение ведения журнала диагностики для веб-приложений в службе приложений Azure](/azure/app-service/web-sites-enable-diagnostic-log).

