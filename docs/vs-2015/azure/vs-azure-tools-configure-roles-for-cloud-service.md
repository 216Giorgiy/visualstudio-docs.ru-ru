---
title: Настройка ролей для облачной службы Azure с помощью Visual Studio | Документация Майкрософт
description: Узнайте, как установить и настроить роли для облачных служб Azure с помощью Visual Studio.
author: ghogen
manager: douge
assetId: d397ef87-64e5-401a-aad5-7f83f1022e16
ms.prod: visual-studio-dev14
ms.technology: vs-azure
ms.custom: vs-azure
ms.workload: azure-vs
ms.topic: conceptual
ms.date: 03/21/2017
ms.author: ghogen
ms.openlocfilehash: ce2259debb55c4792c2998f0e67df69dbc8cb7f9
ms.sourcegitcommit: e481d0055c0724d20003509000fd5f72fe9d1340
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 11/05/2018
ms.locfileid: "51003077"
---
# <a name="configure-azure-cloud-service-roles-with-visual-studio"></a>Настройка ролей облачной службы Azure в Visual Studio
Облачной службы Azure может иметь один или несколько рабочих или веб-ролей. Для каждой роли необходимо определить, как настроить эту роль, а также настроить способ выполнения. Дополнительные сведения о ролях в облачных службах см. в видеоролике [введение в облачных службах Azure](https://channel9.msdn.com/Series/Windows-Azure-Cloud-Services-Tutorials/Introduction-to-Windows-Azure-Cloud-Services). 

Сведения для облачной службы хранятся в следующих файлах:

- **ServiceDefinition.csdef** -файле определения службы определяет параметры среды выполнения для облачной службы, в том числе роли требуется, конечные точки и размер виртуальной машины. Ни один из данных, хранящихся в `ServiceDefinition.csdef` можно изменить во время вашей роли.
- **ServiceConfiguration.cscfg** - файл конфигурации службы задает, какое количество экземпляров роли выполняются, и значения параметров, определенных для роли. Данные, хранящиеся в `ServiceConfiguration.cscfg` можно изменить во время выполнения роли.

Чтобы хранить разные значения для параметров, управляющих выполнение роли, можно определить несколько конфигураций службы. Можно использовать разные конфигурации службы для каждой среды развертывания. Например можно задать строку подключения учетной записи хранения, чтобы использовать эмулятор локального хранения Azure в конфигурации локальной службы и создать другую конфигурацию службы для использования хранилища Azure в облаке.

При создании облачной службы Azure в Visual Studio, две конфигурации службы автоматически создаются и добавляются в проект Azure:

- `ServiceConfiguration.Cloud.cscfg`
- `ServiceConfiguration.Local.cscfg`

## <a name="configure-an-azure-cloud-service"></a>Настройка облачной службы Azure
Можно настроить облачную службу Azure из обозревателя решений в Visual Studio, как показано ниже:

1. Создайте или откройте проект облачной службы Azure в Visual Studio.

1. В **обозревателе решений**, щелкните правой кнопкой мыши проект и в контекстном меню выберите **свойства**.
   
    ![Контекстное меню проекта обозревателя решений](./media/vs-azure-tools-configure-roles-for-cloud-service/solution-explorer-project-context-menu.png)

1. На странице свойств проекта выберите **разработки** вкладки. 

    ![Страница свойств проекта — вкладка "Разработка"](./media/vs-azure-tools-configure-roles-for-cloud-service/project-properties-development-tab.png)

1. В **конфигурации службы** выберите имя конфигурации службы, которую требуется изменить. (Если вы хотите внести изменения для всех конфигураций службы для этой роли, выберите **все конфигурации**.)
   
    > [!IMPORTANT]
    > При выборе конкретной конфигурации службы, некоторые свойства будут отключены, так как их можно задать только для всех конфигураций. Чтобы изменить эти свойства, необходимо выбрать **все конфигурации**.
    > 
    > 
   
    ![Список конфигураций службы для облачной службы Azure](./media/vs-azure-tools-configure-roles-for-cloud-service/cloud-service-service-configuration-property.png)

## <a name="change-the-number-of-role-instances"></a>Изменение количества экземпляров роли
Чтобы повысить производительность облачной службы, можно изменить количество экземпляров роли, работающих под управлением, на основе количества пользователей или нагрузки, ожидаемый для определенной роли. Отдельная виртуальная машина создается для каждого экземпляра роли при запуске облачной службы в Azure. Это влияет на выставление счетов за развертывание этой облачной службы. Дополнительные сведения о выставлении счетов см. в разделе [расшифровка счета за использование Microsoft Azure](/azure/billing/billing-understand-your-bill).

1. Создайте или откройте проект облачной службы Azure в Visual Studio.

1. В **обозревателе решений**, разверните узел проекта. В разделе **ролей** узел, щелкните правой кнопкой мыши роль, требуется обновить и в контекстном меню выберите **свойства**.

    ![Контекстное меню роли Azure в обозревателе решений](./media/vs-azure-tools-configure-roles-for-cloud-service/solution-explorer-azure-role-context-menu.png)

1. Выберите **конфигурации** вкладки.

    ![Вкладка "Конфигурация"](./media/vs-azure-tools-configure-roles-for-cloud-service/role-configuration-properties-page.png)

1. В **конфигурации службы** выберите конфигурацию службы, который требуется обновить.
   
    ![Список конфигураций службы](./media/vs-azure-tools-configure-roles-for-cloud-service/role-configuration-properties-page-select-configuration.png)

1. В **число экземпляров** текста введите количество экземпляров, которые вы хотите начать для этой роли. Каждый экземпляр выполняется на отдельной виртуальной машине при публикации облачной службы Azure.

    ![Обновление количества экземпляров](./media/vs-azure-tools-configure-roles-for-cloud-service/role-configuration-properties-page-instance-count.png)

1. В Visual Studio панели инструментов, выберите **Сохранить**.

## <a name="manage-connection-strings-for-storage-accounts"></a>Управление строками подключения для учетных записей хранения
Можно добавлять, удалять или изменять строки подключения для конфигураций службы. Например, может потребоваться строка локального подключения для конфигурации локальной службы, которая имеет значение `UseDevelopmentStorage=true`. Можно также настроить конфигурацию облачной службы, которая использует учетную запись хранения в Azure.

> [!WARNING]
> Когда вы вводите данные ключа учетной записи хранилища Azure для строки подключения к учетной записи хранения, эта информация хранится локально в файле конфигурации службы. Тем не менее, эти сведения в настоящее время не хранятся в виде зашифрованного текста.
> 
> 

Используя другое значение для каждой конфигурации службы, у вас нет необходимости использовать различные строки подключения в облачной службе или модифицировать код при публикации облачной службы в Azure. Можно использовать то же имя для строки подключения в коде, а значение отличается, на основе конфигурации службы, выбранной при создании облачной службы или при его публикации.

1. Создайте или откройте проект облачной службы Azure в Visual Studio.

1. В **обозревателе решений**, разверните узел проекта. В разделе **ролей** узел, щелкните правой кнопкой мыши роль, требуется обновить и в контекстном меню выберите **свойства**.

    ![Контекстное меню роли Azure в обозревателе решений](./media/vs-azure-tools-configure-roles-for-cloud-service/solution-explorer-azure-role-context-menu.png)

1. Выберите **параметры** вкладки.

    ![Вкладка "Параметры"](./media/vs-azure-tools-configure-roles-for-cloud-service/project-properties-settings-tab.png)

1. В **конфигурации службы** выберите конфигурацию службы, который требуется обновить.

    ![Конфигурация службы](./media/vs-azure-tools-configure-roles-for-cloud-service/project-properties-settings-tab-select-configuration.png)

1. Чтобы добавить строку подключения, выберите **добавить параметр**.

    ![Добавление строки подключения](./media/vs-azure-tools-configure-roles-for-cloud-service/project-properties-settings-tab-add-setting.png)

1. После добавления в список новый параметр, обновите строку в списке, введите необходимые сведения.

    ![Новая строка подключения](./media/vs-azure-tools-configure-roles-for-cloud-service/project-properties-settings-tab-add-setting-new-setting.png)

    - **Имя** -введите имя, которое вы хотите использовать для строки подключения.
    - **Тип** — выберите **строку подключения** из раскрывающегося списка.
    - **Значение** — вы можете ввести строку подключения непосредственно в **значение** ячейку, или нажмите кнопку с многоточием (...) для работы в **Создание строки подключения хранилища** диалоговое окно.  

1. В **Создание строки подключения хранилища** диалоговое окно, выберите один из вариантов для **подключиться с помощью**. Следуйте инструкциям для выбранного варианта:

    - **Эмулятор хранилища Microsoft Azure** — Если выбран этот вариант, остальные параметры в диалоговом окне отключены, так как они применяются только к Azure. Нажмите кнопку **ОК**.
    - **Подписки** — Если выбран этот параметр, воспользуйтесь раскрывающимся списком для выбора и войдите в учетную запись Майкрософт или добавить учетную запись Майкрософт. Выберите подписку и хранилища учетной записи Azure. Нажмите кнопку **ОК**.
    - **Ручной ввод учетных данных** -введите имя учетной записи хранения и первичный или вторичный ключ. Выберите параметр для **подключения** (рекомендуется использовать протокол HTTPS для большинства сценариев.) Нажмите кнопку **ОК**.

1. Чтобы удалить строку подключения, выберите строку подключения, затем установите **удалить параметр**.

1. В Visual Studio панели инструментов, выберите **Сохранить**.

## <a name="programmatically-access-a-connection-string"></a>Программный доступ к строке подключения

Ниже показано, как получить программный доступ к строку соединения при помощи C#.

1. Добавьте следующие директивы using C# файл, где вы собираетесь использовать параметр:

    ```csharp
    using Microsoft.WindowsAzure;
    using Microsoft.WindowsAzure.Storage;
    using Microsoft.WindowsAzure.ServiceRuntime;
    ```

1. Ниже приведен пример того, как получить доступ к строке подключения. Замените &lt;ConnectionStringName > заполнитель с соответствующим значением. 

    ```csharp
    // Setup the connection to Azure Storage
    var storageAccount = CloudStorageAccount.Parse(RoleEnvironment.GetConfigurationSettingValue("<ConnectionStringName>"));
    ```

## <a name="add-custom-settings-to-use-in-your-azure-cloud-service"></a>Добавление пользовательских параметров для использования в облачной службе Azure
Пользовательские параметры в файле конфигурации службы позволяют добавлять имя и значение строки для конкретной конфигурации службы. Вы можете использовать этот параметр для настройки компонента в облачной службе, считывая значение параметра и используя это значение для управления логикой в коде. Можно изменить эти значения конфигурации службы без необходимости перестраивать ваш пакет служб или если выполняется облачной службе. Ваш код может проверять наличие уведомлений об изменении параметра. См. в разделе [событий RoleEnvironment.Changing](https://msdn.microsoft.com/library/azure/microsoft.windowsazure.serviceruntime.roleenvironment.changing.aspx).

Вы можете добавлять, удалять или изменять пользовательские параметры для конфигураций службы. Можно использовать разные значения для этих строк для разных конфигураций службы.

Используя другое значение для каждой конфигурации службы, у вас нет необходимости использовать разные строки в облачной службе или модифицировать код при публикации облачной службы в Azure. То же имя для строки можно использовать в коде, а значение отличается, на основе конфигурации службы, выбранной при создании облачной службы или при его публикации.

1. Создайте или откройте проект облачной службы Azure в Visual Studio.

1. В **обозревателе решений**, разверните узел проекта. В разделе **ролей** узел, щелкните правой кнопкой мыши роль, требуется обновить и в контекстном меню выберите **свойства**.

    ![Контекстное меню роли Azure в обозревателе решений](./media/vs-azure-tools-configure-roles-for-cloud-service/solution-explorer-azure-role-context-menu.png)

1. Выберите **параметры** вкладки.

    ![Вкладка "Параметры"](./media/vs-azure-tools-configure-roles-for-cloud-service/project-properties-settings-tab.png)

1. В **конфигурации службы** выберите конфигурацию службы, который требуется обновить.

    ![Список конфигураций службы](./media/vs-azure-tools-configure-roles-for-cloud-service/project-properties-settings-tab-select-configuration.png)

1. Чтобы добавить пользовательский параметр, выберите **добавить параметр**.

    ![Добавление пользовательского параметра](./media/vs-azure-tools-configure-roles-for-cloud-service/project-properties-settings-tab-add-setting.png)

1. После добавления в список новый параметр, обновите строку в списке, введите необходимые сведения.

    ![Новый пользовательский параметр](./media/vs-azure-tools-configure-roles-for-cloud-service/project-properties-settings-tab-add-setting-new-setting.png)

    - **Имя** -введите имя параметра.
    - **Тип** — выберите **строка** из раскрывающегося списка.
    - **Значение** -введите значение параметра. Вы можете ввести значение непосредственно в **значение** ячейку, или нажмите кнопку с многоточием (...) введите значение в **Изменение строкового** диалоговое окно.  

1. Чтобы удалить пользовательский параметр, выберите параметр и выберите **удалить параметр**.

1. В Visual Studio панели инструментов, выберите **Сохранить**.

## <a name="programmatically-access-a-custom-settings-value"></a>Программный доступ к значению пользовательского параметра
 
Ниже показано, как получить программный доступ к пользовательскому параметру с помощью C#.

1. Добавьте следующие директивы using C# файл, где вы собираетесь использовать параметр:

    ```csharp
    using Microsoft.WindowsAzure;
    using Microsoft.WindowsAzure.Storage;
    using Microsoft.WindowsAzure.ServiceRuntime;
    ```

1. Ниже приведен пример того, как получить доступ к пользовательскому параметру. Замените &lt;SettingName > заполнитель с соответствующим значением. 
    
    ```csharp
    var settingValue = RoleEnvironment.GetConfigurationSettingValue("<SettingName>");
    ```

## <a name="manage-local-storage-for-each-role-instance"></a>Управление локальным хранилищем для каждого экземпляра роли
Вы можете добавить хранилище локальной файловой системы для каждого экземпляра роли. Данные, хранящиеся в том, что хранилище недоступно для других экземпляров роли для хранения данных, или других ролей.  

1. Создайте или откройте проект облачной службы Azure в Visual Studio.

1. В **обозревателе решений**, разверните узел проекта. В разделе **ролей** узел, щелкните правой кнопкой мыши роль, требуется обновить и в контекстном меню выберите **свойства**.

    ![Контекстное меню роли Azure в обозревателе решений](./media/vs-azure-tools-configure-roles-for-cloud-service/solution-explorer-azure-role-context-menu.png)

1. Выберите **локальное хранилище** вкладки.

    ![Вкладка локальное хранилище](./media/vs-azure-tools-configure-roles-for-cloud-service/role-local-storage-tab.png)

1. В **конфигурации службы** убедитесь, что **все конфигурации** выбран как локальные параметры хранилища применяются ко всем конфигурациям службы. Любое другое значение приводит к все поля ввода на странице "отключен". 

    ![Список конфигураций службы](./media/vs-azure-tools-configure-roles-for-cloud-service/role-local-storage-tab-service-configuration.png)

1. Чтобы добавить запись локального хранилища, выберите **добавить локальное хранилище**.

    ![Добавить локальное хранилище](./media/vs-azure-tools-configure-roles-for-cloud-service/role-local-storage-tab-add-local-storage.png)

1. После добавления новой записи локального хранилища в список, обновите строку в списке, введите необходимые сведения.

    ![Новая запись локального хранилища](./media/vs-azure-tools-configure-roles-for-cloud-service/role-local-storage-tab-new-local-storage.png)

    - **Имя** -введите имя, которое вы хотите использовать для нового локального хранилища.
    - **Размер (МБ)** -введите размер в МБ, который необходим для нового локального хранилища.
    - **Очистить при повторном использовании роли** -выберите этот параметр, чтобы удалять данные из нового локального хранилища при перезапуске виртуальной машины для роли.

1. Чтобы удалить запись локального хранилища, выберите запись и выберите **удалить локальное хранилище**.

1. В Visual Studio панели инструментов, выберите **Сохранить**.

## <a name="programmatically-accessing-local-storage"></a>Программным способом доступ к локальному хранилищу

В этом разделе показано, как получить программный доступ к локального хранилища с помощью C# , написав тестовый текстовый файл `MyLocalStorageTest.txt`.  

### <a name="write-a-text-file-to-local-storage"></a>Запись в текстовый файл в локальное хранилище

Ниже показан пример того, как написать текстовый файл в локальном хранилище. Замените &lt;LocalStorageName > заполнитель с соответствующим значением. 

    ```csharp
    // Retrieve an object that points to the local storage resource
    LocalResource localResource = RoleEnvironment.GetLocalResource("<LocalStorageName>");
    
    //Define the file name and path
    string[] paths = { localResource.RootPath, "MyLocalStorageTest.txt" };
    String filePath = Path.Combine(paths);
    
    using (FileStream writeStream = File.Create(filePath))
    {
        Byte[] textToWrite = new UTF8Encoding(true).GetBytes("Testing Web role storage");
        writeStream.Write(textToWrite, 0, textToWrite.Length);
    }

    ```

### <a name="find-a-file-written-to-local-storage"></a>Найти файл, записываемые в локальное хранилище

Чтобы просмотреть файл, созданный с помощью кода в предыдущем разделе, выполните следующие действия.
    
1.  В области уведомлений Windows щелкните правой кнопкой мыши значок Azure и в контекстном меню выберите **Показать пользовательский Интерфейс эмулятора вычислений**. 

    ![Показать эмулятор вычислений Azure](./media/vs-azure-tools-configure-roles-for-cloud-service/show-compute-emulator.png)

1. Выберите веб-роли.

    ![Эмулятор вычислений Azure](./media/vs-azure-tools-configure-roles-for-cloud-service/compute-emulator.png)

1. На **эмулятор вычислений Microsoft Azure** меню, выберите **средства** > **открыть локальное хранилище**.

    ![Пункт меню Открыть локальное хранилище](./media/vs-azure-tools-configure-roles-for-cloud-service/compute-emulator-open-local-store-menu.png)

1. Когда откроется окно проводника Windows, введите "MyLocalStorageTest.txt'' в **поиска** текстовое поле и выберите **ввод** следует начать поиск. 

## <a name="next-steps"></a>Следующие шаги
Дополнительные сведения о проектах Azure в Visual Studio можно найти [Настройка проекта Azure](vs-azure-tools-configuring-an-azure-project.md). Дополнительные сведения о схеме облачной службы можно найти [Справочник по схеме](https://msdn.microsoft.com/library/azure/dd179398).

