---
title: Непрерывная интеграция в службах Azure DevOps, с помощью проектов группы ресурсов Azure | Документация Майкрософт
description: В этой статье описывается настройка непрерывной интеграции в службах Azure DevOps с помощью проектов развертывания группы ресурсов Azure в Visual Studio.
author: mlearned
manager: douge
ms.assetid: b81c172a-be87-4adc-861e-d20b94be9e38
ms.service: azure-resource-manager
ms.topic: article
ms.workload: azure-vs
ms.date: 08/01/2016
ms.author: mlearned
ms.openlocfilehash: b20a43181ad4d36377e61434b880b491543a6c47
ms.sourcegitcommit: af428c7ccd007e668ec0dd8697c88fc5d8bca1e2
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 11/16/2018
ms.locfileid: "51791609"
---
# <a name="continuous-integration-in-azure-devops-services-using-azure-resource-group-deployment-projects"></a>Непрерывная интеграция в службах Azure DevOps, с помощью проектов развертывания группы ресурсов Azure
Для развертывания шаблона Azure, необходимо выполнить задачи на различных этапах: сборка, тестирование, копирование в Azure (также называется «Staging») и развертывание шаблона. Существует два разных способа развертывания шаблонов служб Azure DevOps. Оба метода обеспечивают одинаковые результаты, поэтому выберите тот, который лучше всего соответствует рабочего процесса.

1. Добавьте один этап в ваш конвейер сборки, которая выполняет сценарий PowerShell, включенный в проект развертывания группы ресурсов Azure (Deploy-AzureResourceGroup.ps1). Этот сценарий копирует артефакты и развертывает шаблон.
2. Добавьте несколько служб Azure DevOps сборки действия, каждый из которых выполняется одна задача этапа.

В этой статье показаны оба варианта. Первый параметр имеет преимущество использования тот же сценарий, используемый разработчиками в Visual Studio и обеспечивает согласованность на протяжении жизненного цикла. Второй вариант предлагает удобную альтернативу в виде встроенного сценария. Обе процедуры предполагают, что у вас уже есть проект развертывания Visual Studio, извлеченный службам DevOps в Azure.

## <a name="copy-artifacts-to-azure"></a>Копирование артефактов в Azure
Независимо от сценария Если у вас есть все артефакты, которые необходимы для развертывания шаблона, необходимо предоставить Azure Resource Manager доступ к ним. Эти артефакты можно включить такие файлы:

* Вложенные шаблоны
* Сценарии конфигурации и DSC
* Двоичные файлы приложения

### <a name="nested-templates-and-configuration-scripts"></a>Вложенные шаблоны и сценарии конфигурации
При использовании шаблонов, предоставляемых Visual Studio (или созданных с помощью Visual Studio фрагменты), скрипт PowerShell не только размещает артефакты, но и параметризует URI ресурсов для различных развертываний. Сценарий а затем копирует артефакты в безопасный контейнер в Azure, создает маркер SaS для контейнера и передает эти сведения развертыванию шаблона. См. в разделе [Создание шаблона-развертывания](https://msdn.microsoft.com/library/azure/dn790564.aspx) Дополнительные сведения о вложенных шаблонах.  При использовании задач в службах Azure DevOps, необходимо выбрать соответствующие задачи для развертывания шаблона и при необходимости передавать значения параметров из промежуточного шага в процесс развертывания шаблона.

## <a name="set-up-continuous-deployment-in-azure-pipelines"></a>Настройка непрерывного развертывания в конвейерах Azure
Чтобы вызвать сценарий PowerShell в конвейерах Azure, необходимо обновить процесс сборки. В двух словах действия таковы: 

1. Измените конвейер сборки.
2. Настройте авторизацию Azure, в конвейерах Azure.
3. Добавьте этап сборки Azure PowerShell, который ссылается на сценарий PowerShell в проекте развертывания группы ресурсов Azure.
4. Установите для параметра *- ArtifactsStagingDirectory* параметра для работы с проектом, созданным в конвейерах Azure.

### <a name="detailed-walkthrough-for-option-1"></a>Подробное пошаговое руководство для варианта 1
Ниже приведены шаги, необходимые для настройки непрерывного развертывания в службах Azure DevOps, используя одну задачу, которая выполняет сценарий PowerShell в вашем проекте. 

1. Измените конвейера сборки служб Azure DevOps и добавьте этап сборки Azure PowerShell. Выберите конвейер сборки, в разделе **создавать конвейеры** категорию и нажмите кнопку **изменить** ссылку.
   
   ![Изменить конвейер сборки][0]
2. Добавьте новый **Azure PowerShell** этап построения конвейер сборки, а затем выберите **добавить шаг сборки...** .
   
   ![Добавление шага сборки][1]
3. Выберите **задачи Deploy** категорию **Azure PowerShell** задач, а затем выберите его **добавить** кнопки.
   
   ![Добавление задач][2]
4. Выберите **Azure PowerShell** шаг сборки, а затем укажите соответствующие значения.
   
   1. Если вы уже добавлены для служб Azure DevOps конечная точка службы Azure, выберите подписку из **подписки Azure** поле с раскрывающимся списком, а затем перейдите к следующему разделу. 
      
      Если у вас конечной точки службы Azure в службах Azure DevOps, необходимо добавить один. В этом подразделе описывается этот процесс. Если учетная запись Azure использует учетную запись Майкрософт (например, Hotmail), необходимо выполнить следующие действия, чтобы обеспечить аутентификацию субъекта-службы.

   2. Выберите **управление** ссылку рядом с полем **подписки Azure** поле с раскрывающимся списком.
      
      ![Управление подписками Azure][3]
   3. Выберите **Azure** в **новую конечную точку службы** поле с раскрывающимся списком.
      
      ![Новая конечная точка службы][4]
   4. В **добавления подписки Azure** выберите **субъекта-службы** параметр.
      
      ![Параметр субъекта-службы][5]
   5. Добавьте сведения о подписке Azure для **добавления подписки Azure** диалоговое окно. Необходимо указать следующие элементы:
      
      * Идентификатор подписки
      * Имя подписки
      * Идентификатор субъекта-службы
      * Ключ субъекта-службы
      * Идентификатор клиента
   6. Добавление имени по своему усмотрению, чтобы **подписки** поле "имя". Это значение в дальнейшем будет отображаться в **подписки Azure** стрелку раскрывающегося списка в службах Azure DevOps. 

   7. Если вы не знаете идентификатор подписки Azure, можно использовать один из следующих команд для его получения.
      
      Для сценариев PowerShell используйте следующую команду:
      
      `Get-AzureRmSubscription`
      
      Для Azure CLI используйте следующую команду:
      
      `azure account show`
   8. Чтобы получить идентификатор субъекта-службы, ключ субъекта-службы и идентификатор клиента, выполните процедуру в [Создание приложения Active Directory и субъекта-службы, с помощью портала](/azure/azure-resource-manager/resource-group-create-service-principal-portal) или [проверки подлинности субъекта-службы с помощью Azure Диспетчер ресурсов](/azure/azure-resource-manager/resource-group-authenticate-service-principal).
   9. Добавьте значения идентификатор субъекта-службы, ключ субъекта-службы и идентификатор клиента для **добавления подписки Azure** диалоговое окно и нажмите кнопку **ОК** кнопки.
      
      Теперь у вас есть допустимый субъект-службу для выполнения сценария Azure PowerShell.
5. Конвейер сборки и затем выберите **Azure PowerShell** этап сборки. Выберите подписку, в **подписки Azure** поле с раскрывающимся списком. (Если подписка не отображается, выберите **обновить** рядом **управление** ссылку.) 
   
   ![Настройка задачи сборки Azure PowerShell][8]
6. Укажите путь к сценарию PowerShell Deploy-AzureResourceGroup.ps1. Чтобы сделать это, нажмите кнопку с многоточием (...) рядом с полем **путь к скрипту** окне перейдите к сценарию PowerShell Deploy-AzureResourceGroup.ps1 в **сценарии** папку проекта, выберите его, а затем Выберите **ОК** кнопки.    
   
   ![Выберите путь к скрипту][9]
7. После выбора сценария, обновить путь к сценарию, чтобы ее запуск выполняется из каталога Build.StagingDirectory (тот же каталог, *ArtifactsLocation* имеет значение). Это можно сделать, добавив «$(Build.StagingDirectory)/ начало пути к сценарию.
   
    ![Изменение пути к сценарию][10]
8. В **аргументы скрипта** введите следующие параметры (в одной строке). При запуске сценария в Visual Studio можно увидеть, как VS использует параметры в **вывода** окна. Это можно использовать в качестве отправной точки для установку значений параметров на этапе сборки.
   
   | Параметр | Описание: |
   | --- | --- |
   | -ResourceGroupLocation |Значение географического расположения, где находится группа ресурсов, таких как **eastus** или **«Восточная часть США»**. (Добавьте одинарные кавычки, если в имени есть пробел.) См. в разделе [регионы Azure](https://azure.microsoft.com/regions/) Дополнительные сведения. |
   | -ResourceGroupName |Имя группы ресурсов, используемый для этого развертывания. |
   | -UploadArtifacts |Этот параметр, если он присутствует, указывает, что артефакты, которые необходимо передать в Azure из локальной системы. Необходимо задать этот параметр, если шаблон развертывания требует дополнительных артефактов, которые вы хотите разместить с помощью сценария PowerShell (например, сценарии настройки или вложенные шаблоны). |
   | -StorageAccountName |Имя учетной записи хранения, используемой для размещения артефактов для этого развертывания. Этот параметр используется только в том случае, если применяется промежуточное хранение артефактов для развертывания. Если этот параметр задан, учетную запись хранения создается в том случае, если сценарий не создал ее во время предыдущего развертывания. Если этот параметр указан, то учетная запись хранения уже должна существовать. |
   | -StorageAccountResourceGroupName |Имя группы ресурсов, связанной с учетной записью хранения. Этот параметр является обязательным только в том случае, если указать значение параметра StorageAccountName. |
   | -TemplateFile |Путь к файлу шаблона в проекте развертывания группы ресурсов Azure. Для большей гибкости, используйте путь для этого параметра, который задается относительно расположения в скрипте PowerShell, а не абсолютный путь. |
   | -TemplateParametersFile |Путь к файлу параметров в проекте развертывания группы ресурсов Azure. Для большей гибкости, используйте путь для этого параметра, который задается относительно расположения в скрипте PowerShell, а не абсолютный путь. |
   | -ArtifactStagingDirectory |Этот параметр позволяет сценарию PowerShell определить папку из куда следует копировать двоичные файлы проекта. Это значение переопределяет значение по умолчанию, используемое сценарием PowerShell. Для использования служб Azure DevOps, задайте значение:-$ (Build.stagingdirectory) |
   
   Ниже приведен пример аргументов сценария (разрывы строк — для удобства чтения).
   
   ```    
   -ResourceGroupName 'MyGroup' -ResourceGroupLocation 'eastus' -TemplateFile '..\templates\azuredeploy.json' 
   -TemplateParametersFile '..\templates\azuredeploy.parameters.json' -UploadArtifacts -StorageAccountName 'mystorageacct' 
   –StorageAccountResourceGroupName 'Default-Storage-EastUS' -ArtifactStagingDirectory '$(Build.StagingDirectory)'    
   ```
   
   Когда закончите, **аргументы скрипта** поле должно напоминать следующий список:
   
   ![Аргументы скрипта][11]
9. После добавления всех необходимых элементов в этап сборки Azure PowerShell, выберите **очереди** построения, чтобы построить проект. **Построения** экрана показаны выходные данные сценария PowerShell.

### <a name="detailed-walkthrough-for-option-2"></a>Подробное пошаговое руководство для варианта 2
Ниже приведены шаги, необходимые для настройки непрерывного развертывания в службах Azure DevOps, с помощью встроенных задач.

1. Измените процесс сборки служб Azure DevOps, добавить два новых этапов построения. Выберите конвейер сборки, в разделе **определений построений** категорию и нажмите кнопку **изменить** ссылку.
   
   ![Изменение определения сборок][12]
2. Добавить новые шаги сборки конвейера с помощью **добавить шаг сборки...** .
   
   ![Добавление шага сборки][13]
3. Выберите **развернуть** категорию задачи **копирование файлов Azure** задач, а затем выберите его **добавить** кнопки.
   
   ![Добавление задачи копирования файлов Azure][14]
4. Выберите **развертывания группы ресурсов Azure** задач, а затем выберите его **добавить** кнопки и затем **закрыть** **каталог задач**.
   
   ![Добавление задачи развертывания группы ресурсов Azure][15]
5. Выберите **копирование файлов Azure** задач и укажите соответствующие значения.
   
   Если вы уже добавлены для служб Azure DevOps конечная точка службы Azure, выберите подписку из **подписки Azure** поле с раскрывающимся списком. Если у вас нет подписки, см. в разделе [вариант 1](#detailed-walkthrough-for-option-1) инструкции по ее настройке в службах Azure DevOps.
   
   * Источник: введите **$(Build.StagingDirectory)**
   * Тип соединения с Azure: выберите **Azure Resource Manager**
   * Подписка на Azurerm - выберите подписку для учетной записи хранения, вы хотите использовать в **подписки Azure** поле с раскрывающимся списком. Если подписка не отображается, выберите **обновить** рядом **управление** ссылку.
   * Тип назначения: выберите **BLOB-объектов Azure**
   * RM учетная запись хранения — выберите учетную запись хранения, вы хотели бы использовать для промежуточного хранения артефактов
   * Имя контейнера — введите имя контейнера, вы бы хотели использовать для промежуточного хранения; он может быть любое допустимое имя контейнера, но использовать один выделенный для этого конвейера сборки
   
   Значения выходных данных:
   
   * Введите URI - контейнера хранилища **artifactsLocation**
   * Токен SAS контейнера хранилища — введите **artifactsLocationSasToken**
   
   ![Настройка задачи копирования файлов Azure][16]
6. Выберите **развертывания группы ресурсов Azure** шаг сборки, а затем укажите соответствующие значения.
   
   * Тип соединения с Azure: выберите **Azure Resource Manager**
   * Подписка на Azurerm - выберите подписку для развертывания в **подписки Azure** поле с раскрывающимся списком. Обычно это будет использовать на предыдущем шаге ту же подписку
   * Действие — выберите **создать или обновить группу ресурсов**
   * Группа ресурсов — выберите группу ресурсов или введите имя новой группы ресурсов для развертывания
   * Расположение — выберите расположение группы ресурсов
   * Шаблон — введите путь и имя шаблона для развертывания добавляя **$(Build.StagingDirectory)**, например: **$(Build.StagingDirectory/DSC-CI/azuredeploy.json)**
   * Параметры шаблона — введите путь и имена параметров для использования, добавляя в начало **$(Build.StagingDirectory)**, например: **$(Build.StagingDirectory/DSC-CI/azuredeploy.parameters.json)**
   * Переопределить параметры шаблона — введите или скопируйте и вставьте следующий код:
     
     ```    
     -_artifactsLocation $(artifactsLocation) -_artifactsLocationSasToken (ConvertTo-SecureString -String "$(artifactsLocationSasToken)" -AsPlainText -Force)
     ```
     ![Настройка задачи развертывания группы ресурсов Azure][17]
7. После добавления всех необходимых элементов, сохранить конвейер сборки и выберите **новую сборку в очередь** вверху.

## <a name="next-steps"></a>Следующие шаги
Чтение [обзоре Azure Resource Manager](/azure-resource-manager/resource-group-overview.md) получить дополнительные сведения об Azure Resource Manager и групп ресурсов Azure.

[0]: media/vs-azure-tools-resource-groups-ci-in-vsts/walkthrough1.png
[1]: media/vs-azure-tools-resource-groups-ci-in-vsts/walkthrough2.png
[2]: media/vs-azure-tools-resource-groups-ci-in-vsts/walkthrough3.png
[3]: media/vs-azure-tools-resource-groups-ci-in-vsts/walkthrough4.png
[4]: media/vs-azure-tools-resource-groups-ci-in-vsts/walkthrough5.png
[5]: media/vs-azure-tools-resource-groups-ci-in-vsts/walkthrough6.png
[8]: media/vs-azure-tools-resource-groups-ci-in-vsts/walkthrough9.png
[9]: media/vs-azure-tools-resource-groups-ci-in-vsts/walkthrough10.png
[10]: media/vs-azure-tools-resource-groups-ci-in-vsts/walkthrough11b.png
[11]: media/vs-azure-tools-resource-groups-ci-in-vsts/walkthrough12.png
[12]: media/vs-azure-tools-resource-groups-ci-in-vsts/walkthrough13.png
[13]: media/vs-azure-tools-resource-groups-ci-in-vsts/walkthrough14.png
[14]: media/vs-azure-tools-resource-groups-ci-in-vsts/walkthrough15.png
[15]: media/vs-azure-tools-resource-groups-ci-in-vsts/walkthrough16.png
[16]: media/vs-azure-tools-resource-groups-ci-in-vsts/walkthrough17.png
[17]: media/vs-azure-tools-resource-groups-ci-in-vsts/walkthrough18.png
