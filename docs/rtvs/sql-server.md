---
title: "Интеграция SQL Server с инструментами R для Visual Studio | Документация Майкрософт"
ms.custom: 
ms.date: 06/30/2017
ms.reviewer: 
ms.suite: 
ms.technology: devlang-r
ms.devlang: r
ms.tgt_pltfrm: 
ms.topic: article
ms.assetid: 919dfc34-234a-489e-91bf-74a4cefae26c
caps.latest.revision: "1"
author: kraigb
ms.author: kraigb
manager: ghogen
ms.openlocfilehash: dfccd737ae7017823fdf7f2a5112fd05c8900559
ms.sourcegitcommit: fb751e41929f031d1a9247bc7c8727312539ad35
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 11/15/2017
---
# <a name="working-with-sql-server-and-r"></a>Работа с SQL Server и R

Отличная поддержка  SQL Server в Visual Studio позволяет специалистам по анализу и обработке данных работать с базами данных SQL и R благодаря возможности создавать и выполнять SQL-запросы и использовать хранимые процедуры.

> [!Note]
> Для интеграции SQL с R необходимо установить SQL Server Data Tools.
> - Visual Studio 2017: запустите установщик Visual Studio и выберите рабочую нагрузку "Хранение и обработка данных", которая включает SQL Server Data Tools.
> - Visual Studio 2015: следуйте инструкциям в разделе [SQL Server Data Tools](https://docs.microsoft.com/sql/ssdt/download-sql-server-data-tools-ssdt).

В следующем видео (3 мин, 3 с) представлен краткий обзор SQL Server и R.

<iframe width="560" height="315" src="https://www.youtube.com/embed/n4AYr0QIwdQ" frameborder="0" allowfullscreen></iframe>

## <a name="creating-and-running-sql-queries"></a>Создание и выполнение SQL-запросов

RTVS поддерживает добавление SQL-запросов в проекты R, позволяя итеративно разрабатывать SQL-запросы в отдельном контексте, пока не будут получены требуемые результаты.

Чтобы добавить файл SQL-запроса, щелкните правой кнопкой мыши проект в обозревателе решений выберите **Добавить > Новый элемент** и выберите в качестве типа файла **SQL-запрос**.

![Добавление элемента "SQL-запрос" в проект](media/sql-add-item.png)

Эта команда открывает файл в редакторе Transact-SQL в Visual Studio, где реализована полная поддержка технологии IntelliSense для SQL и возможность выполнения запросов. Для работы этих функций нужно подключиться к базе данных, используя кнопку "Подключить" на панели инструментов редактора или попытаться выполнить запрос (нажать клавиши CTRL+SHIFT+E, которые также можно использовать для выделенной области). В любом случае появляется диалоговое окно подключения.

![Диалоговое окно подключения SQL](media/sql-connection-dialog.png)

После установления соединения можно выполнять запросы и просматривать результаты.

![Окно с результатами выполнения SQL-запроса](media/sql-query-results.png)

Редактор Transact-SQL поддерживает множество других функций, таких как просмотр плана выполнения запроса и отладчик запросов.
Дополнительные сведения см. в разделе [Использование редактора Transact-SQL для редактирования и выполнения скриптов](https://msdn.microsoft.com/library/hh272706.aspx).

## <a name="working-with-sql-server-stored-procedures"></a>Работа с хранимыми процедурами SQL Server

[Службы SQL Server R Services](https://docs.microsoft.com/sql/advanced-analytics/r/sql-server-r-services) (SQL Server 2016 и более поздние версии) позволяют внедрять и выполнять код R из хранимых процедур T-SQL. Вы можете выполнять код R на компьютере с SQL Server, работать с данными, возвращаемыми SQL-запросом, а также создавать наборы результатов SQL, которые можно далее обработать в SQL или возвратить клиенту.

RTVS упрощает громоздкий и подверженный ошибкам процесс объединения SQL с кодом R, используя вместо него одну инструкцию SQL, как описано в следующих разделах.

- [Добавление подключения к базе данных](#add-a-database-connection)
- [Написание и тестирование хранимой процедуры SQL](#write-and-test-a-sql-stored-procedure)
- [Публикация хранимой процедуры SQL](#publish-a-sql-stored-procedure)

В следующем видео (6 мин, 9 с) представлен обзор этих функций.

<iframe width="560" height="315" src="https://www.youtube.com/embed/dFKIT2OitWQ" frameborder="0" allowfullscreen></iframe>

### <a name="add-a-database-connection"></a>Добавление подключения к базе данных

1. Выберите **Инструменты R > Данные > Добавить подключение к базе данных**, чтобы отобразить диалоговое окно **Свойства подключения**. В нем укажите имя источника данных (в данном случае — SQL Server), имя сервера, режим проверки подлинности и имя базы данных. Выберите **Проверить подключение** для проверки введенных данных, прежде чем закрывать диалоговое окно.

    ![Диалоговое окно подключения SQL](media/sql-connection-string-dialog.png)

1. После указания допустимых настроек подключения и нажатия кнопки **ОК** Visual Studio создает строку подключения с именем `dbConnection` в новом файле `settings.R`. RTVS автоматически выполняет этот файл, чтобы это подключение можно было сразу использовать в скриптах R.

![Файл Settings.R для SQL](media/sql-settings-dot-r.png)

### <a name="write-and-test-a-sql-stored-procedure"></a>Написание и тестирование хранимой процедуры SQL

Чтобы добавить новую хранимую процедуру SQL, щелкните правой кнопкой мыши проект, выберите **Добавить > Новый элемент**, выберите в списке шаблонов пункт **Хранимая процедура SQL с R**, присвойте файлу имя (в этом примере "`StoredProcedure.R`") и нажмите кнопку **ОК**.

RTVS создают три файла для хранимой процедуры: файл `.R` для кода R, файл `.Query.sql` для кода SQL и файл `.Template.sql`, в котором объединены эти два кода. Последние два отображаются в обозревателе решений как дочерние элементы файла `.R`.

![Развернутое окно обозревателя решений с хранимой процедурой SQL с R](media/sql-solution-explorer-expanded.png)

Файл `StoredProcedure.R` (в данном примере), который используется для написания кода R. Содержимое по умолчанию выглядит следующим образом:

```R
# @InputDataSet: input data frame, result of SQL query execution
# @OutputDataSet: data frame to pass back to SQL

# Test code
# library(RODBC)
# channel <- odbcDriverConnect(dbConnection)
# InputDataSet <- sqlQuery(channel, )
# odbcClose(channel)

OutputDataSet <- InputDataSet
```

Проще говоря, код получает кадр данных R, который называется `InputDataSet`, и возвращает свои результаты в `OutputDataSet`, а код шаблона просто копирует входные данные в вывод.

> [!Note]
> Для управления именами этих кадров данных используются параметры `@input_data_1_name` и `@output_data_1_name` в вызове системной хранимой процедуры `sp_execute_external_script`. Дополнительные сведения о проектировании этого соглашения о вызовах и некоторые примеры его использования см. в разделе [sp_execute_external_script (Transact-SQL)](https://docs.microsoft.com/sql/relational-databases/system-stored-procedures/sp-execute-external-script-transact-sql).

Другой сгенерированный код (в заметках) предоставляет небольшой скрипт теста, который использует [пакет RODBC](https://cran.r-project.org/web/packages/RODBC/index.html) для передачи инструкции SQL в SQL Server, ее запуска и получения результирующего набора в виде кадра данных R. Можно раскомментировать этот код теста для интерактивного создания собственного кода R на основе результирующего набора, полученного от SQL Server.

Файл `StoredProcedure.Query.sql` используется для записи и проверки SQL-запроса, который генерирует данные для `InputDataSet`. С этим файлом `.sql` редактор предоставляет вам все обычные функции Transact-SQL.

Оформив код SQL требуемым образом, интегрируйте его с кодом R в файле `StoredProcedure.R`, перетащив файл `.sql` в редактор, где открыт файл `.R`. На рисунке ниже файл `StoredProcedure.Query.sql` перемещен в место после запятой в переменной `sqlQuery(channel, )`.

![Считывание содержимого файла SQL в строковую переменную R](media/sql-reference-sql-file-from-r.png)

Как видно, при выполнении этого простого действия автоматически создается код R для открытия файла `.sql`, считывания его содержимого в строку и ее передачи в пакет RODBC для отправки в SQL Server.

Теперь можно в интерактивном режиме написать код R, который управляет кадром данных `InputDataSet` требуемым образом. Помните, что можно просто выбрать код R в редакторе и отправить его в [интерактивное окно](interactive-repl.md) нажатием клавиш CTRL + ВВОД.

Наконец, в файле `StoredProcedure.Template.sql` находится шаблон для создания хранимой процедуры SQL.

```sql
CREATE PROCEDURE [StoredProcedure]
AS
BEGIN
EXEC sp_execute_external_script @language = N'R'
    , @script = N'_RCODE_'
    , @input_data_1 = N'_INPUT_QUERY_'
--- Edit this line to handle the output data frame.
    WITH RESULT SETS (([MYNEWCOLUMN] NVARCHAR(max)));
END;
```

- Заполнитель `_RCODE_` заменяется содержимым файла `StoredProcedure.R`.
- Заполнитель `_INPUT_QUERY_` заменяется содержимым файла `StoredProcedure.Query.sql`.
- Измените предложение `WITH RESULT SETS`, чтобы описать схему результирующего набора, который возвращается из хранимой процедуры. В частности, необходимо определить столбцы из кадра данных `OutputDataSet`, которые требуется вернуть вызывающему хранимую процедуру. 

Например, для следующего запроса:

```sql
SELECT TOP 100 medallion, hack_license FROM nyctaxi_sample
```

Необходимо использовать следующее предложение `WITH RESULT SETS` для указания типов данных возвращаемых значений.

```sql
WITH RESULT SETS ((medallion NVARCHAR(max), hack_license NVARCHAR(max)));
```

### <a name="publish-a-sql-stored-procedure"></a>Публикация хранимой процедуры SQL

1. Выберите команду **Инструменты R > Данные > Опубликовать с параметрами**.
1. В появившемся диалоговом окне выберите для параметра **Публикация в:** значение **База данных**, укажите целевой объект, нажмите **Опубликовать**, после чего RTVS создают и публикуют хранимую процедуру.

    ![Диалоговое окно публикации хранимой процедуры](media/sql-publish-with-options.png)

1. Чтобы опубликовать все хранимые процедуры в проекте, можно воспользоваться командой **Инструменты R > Данные > Опубликовать хранимые процедуры**, которая также доступна в контекстном меню проекта в обозревателе решений.

> [!Tip]
> Если в Visual Studio открыт обозреватель объектов SQL Server, опубликованная хранимая процедура отображается в папке **Программирование > Хранимые процедуры** базы данных. Процедуру также можно выполнить в обозревателе объектов, щелкнув ее правой кнопкой мыши и выбрав **Выполнить процедуру**, либо путем ее интерактивного вызова в окне запроса `.sql`.
