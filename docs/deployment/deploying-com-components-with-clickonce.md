---
title: "Развертывание компонентов COM с помощью ClickOnce | Документы Microsoft"
ms.custom: 
ms.date: 11/04/2016
ms.reviewer: 
ms.suite: 
ms.technology: vs-ide-deployment
ms.tgt_pltfrm: 
ms.topic: article
dev_langs:
- VB
- CSharp
- C++
helpviewer_keywords:
- registration-free COM deployment
- ClickOnce deployment, COM components
- COM components, deploying
- deploying applications [ClickOnce], COM components
- components, deploying
ms.assetid: 1a4c7f4c-7a41-45f2-9af4-8b1666469b89
caps.latest.revision: "12"
author: stevehoag
ms.author: shoag
manager: wpickett
ms.openlocfilehash: d3a8ae32afec789595ecd126eeaee0c5ea05a9e8
ms.sourcegitcommit: aadb9588877418b8b55a5612c1d3842d4520ca4c
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 10/27/2017
---
# <a name="deploying-com-components-with-clickonce"></a>Развертывание компонентов COM с помощью ClickOnce
Развертывание устаревших компонентов COM традиционно трудной задачей. Компоненты должны быть глобально зарегистрированы и таким образом, может вызвать нежелательные побочные эффекты между перекрывающимися приложениями. Такая ситуация встречается обычно не проблемы в приложениях .NET Framework, так как компоненты, полностью изолированы от приложения или side-by-side совместимы. Visual Studio позволяет развертывать изолированные компоненты COM в Windows XP или более поздней версии операционной системы.  
  
 [!INCLUDE[ndptecclick](../deployment/includes/ndptecclick_md.md)]обеспечивает простой и безопасный механизм развертывания приложений .NET. Однако если приложение использует устаревшие компоненты COM, необходимо выполнить дополнительные действия для его развертывания. В этом разделе описывается развертывать изолированные компоненты COM и ссылок на собственные компоненты (например, Visual Basic 6.0 или Visual C++).  
  
 Дополнительные сведения о развертывании изолированные компоненты COM см. в разделе «упростить развертывание приложения с [!INCLUDE[ndptecclick](../deployment/includes/ndptecclick_md.md)] и COM без регистрации» в [http://msdn.microsoft.com/msdnmag/issues/05/04/RegFreeCOM/default.aspx](http://msdn.microsoft.com/msdnmag/issues/05/04/RegFreeCOM/default.aspx).  
  
## <a name="registration-free-com"></a>COM-Взаимодействия без регистрации  
 COM-Взаимодействия без регистрации — это новая технология, развертывания и активации изолированных COM-компонентов. Он работает путем помещения библиотеки типов компонента и сведения о регистрации, который обычно устанавливается в системный реестр в XML-файл, называемый манифестом, хранящихся в той же папке, что и приложение.  
  
 Изолированного компонента COM требуется регистрироваться на компьютере разработчика, но не должен быть зарегистрирован на компьютере конечного пользователя. Чтобы изолировать компонент COM, все, что нужно сделать значение свою ссылку **Isolated** свойства **True**. По умолчанию это свойство имеет значение **False**, указывающее на то, что оно должно считаться зарегистрированного COM-ссылка. Если это свойство имеет **True**, это вызывает манифеста, созданный для этого компонента во время построения. Она вызывает соответствующие файлы копируются в папку приложения во время установки.  
  
 Если генератор манифеста встречает изолированную ссылку COM, то перечисляются все `CoClass` операций в библиотеке типов компонентов, сопоставляя каждый элемент с соответствующими данными регистрации и создавая определения манифеста для COM классы в файле библиотеки типов.  
  
## <a name="deploying-registration-free-com-components-using-clickonce"></a>Развертывание компонентов COM-Взаимодействия без регистрации с помощью ClickOnce  
 [!INCLUDE[ndptecclick](../deployment/includes/ndptecclick_md.md)]технологии развертывания хорошо подходит для развертывания изолированных компонентов COM, так как оба [!INCLUDE[ndptecclick](../deployment/includes/ndptecclick_md.md)] и COM-Взаимодействия без регистрации требуют наличия манифеста для развертывания компонентов.  
  
 Как правило автор компонента должен предоставлять манифест. Если нет, однако Visual Studio не может создавать манифест автоматически для COM-компонента. Создание манифеста выполняется во время [!INCLUDE[ndptecclick](../deployment/includes/ndptecclick_md.md)] процесса публикации; Дополнительные сведения см. в разделе [публикация приложений ClickOnce](../deployment/publishing-clickonce-applications.md). Эта функция также позволяет использовать устаревшие компоненты, созданные в предыдущих средах разработки, таких как Visual Basic 6.0.  
  
 Существует два способа, [!INCLUDE[ndptecclick](../deployment/includes/ndptecclick_md.md)] развертывание компонентов COM:  
  
-   Использование загрузчика для развертывания компонентов COM; Это работает на всех поддерживаемых платформах.  
  
-   Использование собственного компонента развертывания изоляции (также называется COM без регистрации). Тем не менее это будет работать только на Windows XP или более поздней версии операционной системы.  
  
### <a name="example-of-isolating-and-deploying-a-simple-com-component"></a>Пример изоляции и развертывания простого компонента COM  
 Чтобы продемонстрировать развертывание компонента COM без регистрации, в этом примере будет создавать приложения Windows в Visual Basic, который ссылается на собственный изолированный компонент COM, созданных с помощью Visual Basic 6.0 и развернуть ее с помощью [!INCLUDE[ndptecclick](../deployment/includes/ndptecclick_md.md)].  
  
 Сначала необходимо создать собственный компонент COM:  
  
##### <a name="to-create-a-native-com-component"></a>Для создания собственного компонента COM  
  
1.  С помощью Visual Basic 6.0 из **файл** меню, нажмите кнопку **New**, затем **проекта**.  
  
2.  В **новый проект** выберите **Visual Basic** , а затем выберите **ActiveX DLL** проекта. В поле **Имя** введите `VB6Hello`.  
  
    > [!NOTE]
    >  Поддерживаются только типы проектов ActiveX DLL и элемент управления ActiveX с COM-Взаимодействия без регистрации; Типы проектов ActiveX EXE и документ ActiveX не поддерживаются.  
  
3.  В **обозревателе решений**, дважды щелкните **Class1.vb** для открытия текстового редактора.  
  
4.  В Class1.vb добавьте следующий код после созданного кода для `New` метод:  
  
    ```  
    Public Sub SayHello()  
       MsgBox "Message from the VB6Hello COM component"  
    End Sub  
    ```  
  
5.  Создать компонент. Из **построения** меню, нажмите кнопку **построить решение**.  
  
> [!NOTE]
>  COM-Взаимодействия без регистрации поддерживает только библиотеки DLL и COM определяет типы проектов. Нельзя использовать EXE-файлов с помощью объектов COM без регистрации.  
  
 Теперь можно создать приложение на основе Windows и добавьте ссылку на COM-компонент к нему.  
  
##### <a name="to-create-a-windows-based-application-using-a-com-component"></a>Создание приложения Windows, с помощью COM-компонент  
  
1.  С помощью Visual Basic из **файл** меню, нажмите кнопку **New**, затем **проекта**.  
  
2.  В **новый проект** выберите **Visual Basic** , а затем выберите **приложение Windows**. В поле **Имя** введите `RegFreeComDemo`.  
  
3.  В **обозревателе решений**, нажмите кнопку **Показать все файлы** кнопку, чтобы отобразить ссылки на проект.  
  
4.  Щелкните правой кнопкой мыши **ссылки** , а затем выберите **добавить ссылку** в контекстном меню.  
  
5.  В **добавить ссылку** диалоговое окно, нажмите кнопку **Обзор** вкладки, перейдите к библиотеке VB6Hello.dll, затем выберите ее.  
  
     Объект **VB6Hello** ссылка появится в списке ссылок.  
  
6.  Пункты **элементов**выберите **кнопку** управления и перетащите его на **Form1** формы.  
  
7.  В **свойства** задайте кнопки **текст** свойства **Hello**.  
  
8.  Дважды щелкните кнопку, чтобы добавить код обработчика и в файле кода добавьте код, чтобы обработчик следующим образом:  
  
    ```  
    Private Sub Button1_Click(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles Button1.Click  
        Dim VbObj As New VB6Hello.Class1  
        VbObj.SayHello()  
    End Sub  
    ```  
  
9. Запустите приложение. Из **отладки** меню, нажмите кнопку **начать отладку**.  
  
 Далее необходимо изолировать элемент. Каждый COM-компонент, который использует приложение представляется в проекте как COM-ссылка. Эти ссылки видны под **ссылки** узел в **обозревателе решений** окна. (Обратите внимание, что можно добавить ссылается либо напрямую, используя **добавить ссылку** на **проекта** меню или косвенно путем перетаскивания элемента управления ActiveX в форму.)  
  
 Ниже показано, как изолировать компонент COM и опубликовать обновленное приложение, содержащее изолированный элемент управления:  
  
##### <a name="to-isolate-a-com-component"></a>Чтобы изолировать компонент COM  
  
1.  В **обозревателе решений**в **ссылки** выберите **VB6Hello** ссылки.  
  
2.  В **свойства** окна, измените значение **Isolated** свойство из **False** для **True**.  
  
3.  Из **построения** меню, нажмите кнопку **построить решение**.  
  
 Теперь при нажатии клавиши F5, приложение работает, как ожидалось, но теперь он работает в группе объектов COM без регистрации. Чтобы проверить это, попробуйте отменить регистрацию компонента VB6Hello.dll, а затем запустить RegFreeComDemo1.exe вне Visual Studio IDE. Это время, при нажатии кнопки, приложение продолжает работать. Если временно переименовать манифест приложения, оно вновь завершится с ошибкой.  
  
> [!NOTE]
>  Вы можете имитировать отсутствие компонента COM, временно отменив регистрацию. Откройте командную строку, перейдите в папку system, введя `cd /d %windir%\system32`, затем отменить регистрацию компонента, введя `regsvr32 /u VB6Hello.dll`. Снова зарегистрируйте его, введя `regsvr32 VB6Hello.dll`.  
  
 Последним шагом является публикация приложения с помощью [!INCLUDE[ndptecclick](../deployment/includes/ndptecclick_md.md)]:  
  
##### <a name="to-publish-an-application-update-with-an-isolated-com-component"></a>Чтобы опубликовать обновления приложения с помощью изолированного компонента COM  
  
1.  Из **построения** меню, нажмите кнопку **публикации RegFreeComDemo**.  
  
     Откроется Мастер публикации.  
  
2.  В мастере публикации укажите расположение на диске локального компьютера где можно открыть и проверить опубликованные файлы.  
  
3.  Нажмите кнопку **Готово** для публикации приложения.  
  
 Если посмотреть на опубликованных файлов, можно заметить, что включен файл sysmon.ocx. Элемент управления полностью изолирован данного приложения, это означает, что если на компьютере конечного пользователя установлено другое приложение, с помощью другой версии элемента управления, он не оказывает влияния на это приложение.  
  
## <a name="referencing-native-assemblies"></a>Ссылки на сборки в машинном коде  
 Visual Studio поддерживает ссылки на машинном коде Visual Basic 6.0 или сборки C++; такие ссылки называются собственных ссылок. Можно определить, является ли ссылка собственного путем проверки, что его **тип файла** свойству **собственного** или **ActiveX**.  
  
 Чтобы добавить собственную ссылку, используйте **добавить ссылку** команды, а затем найти в манифест. Некоторые компоненты помещают манифест внутри библиотеки DLL. В этом случае можно просто выбрать самой библиотеки DLL, и Visual Studio добавит ее как собственную ссылку, если он обнаруживает, что компонент содержит внедренный манифест. Visual Studio также автоматически включит зависимые файлы или сборки, перечисленные в манифесте, если они находятся в той же папке, что указанный компонент.  
  
 Изоляция элемента управления COM облегчает развертывание компонентов COM, которые еще не имеют манифестов. Если компонент предоставляется с манифестом, манифест можно ссылаться непосредственно. На самом деле, следует всегда использовать манифест, предоставляемый автором компонента, по возможности вместо использования **Isolated** свойство.  
  
## <a name="limitations-of-registration-free-com-component-deployment"></a>Ограничения развертывания без регистрации COM-компонент  
 COM-Взаимодействия без регистрации имеет явные преимущества перед традиционные методы. Однако существует несколько ограничений и пояснения, которые следует также обратить внимание. Самое большое ограничение заключается в том, что он работает только в ОС Windows XP или более поздней версии. Реализации COM-Взаимодействия без регистрации необходимые изменения в работе, в котором компоненты загружаются в основной операционной системы. К сожалению нет никакой уровень поддержки нижнего уровня для объектов COM без регистрации.  
  
 Не каждый компонент является кандидатом подходит для объектов COM без регистрации. Компонент не подходит, если хотя бы одно из следующих:  
  
-   Компонент является сервером out of process. Серверы EXE не поддерживаются; поддерживаются только библиотеки DLL.  
  
-   Компонент является частью операционной системы или является компонентом системы, таких как XML, Internet Explorer или компонентов доступа к данным (MDAC). Необходимо соблюдать политику распространения автор компонента; Обратитесь к поставщику.  
  
-   Компонент является частью приложения, такие как Microsoft Office. Например не следует пытаться выявить объектной модели Microsoft Excel. Это является частью Office и может использоваться только на компьютере с установленным полным продуктом Office.  
  
-   Компонент предназначен для использования как надстройка, например надстройка Office или элемент управления в веб-браузере. Такие компоненты обычно требуется регистрация схемы, определенной средой размещения, который выходит за пределы области видимости самого манифеста.  
  
-   Компонент управляет физическим или виртуальным устройством системы, например, драйвер устройства для диспетчера очереди печати.  
  
-   Компонент является распространяемый компонент доступа к данным. Данные приложений обычно требуется отдельный доступ к данным распространяемый пакет должен быть установлен перед выполнением. Не следует пытаться выявить компоненты, такие как Microsoft элемента управления данными ADO, OLE DB для Microsoft или компонентов доступа к данным (MDAC). Вместо этого Если приложение использует MDAC или SQL Server Express, необходимо устанавливать их в качестве необходимых компонентов; в разделе [как: Установка необходимых компонентов с приложением ClickOnce](../deployment/how-to-install-prerequisites-with-a-clickonce-application.md).  
  
 В некоторых случаях возможно для разработчика компонента, изменить его для объектов COM без регистрации. Если это невозможно, можно по-прежнему построения и публикации приложений, зависящих от них через стандартную схему регистрации с помощью загрузчика. Дополнительные сведения см. в разделе [создание пакетов загрузчика](../deployment/creating-bootstrapper-packages.md).  
  
 COM-компонент может быть только один раз изолированной каждого приложения. Например, нельзя изолировать один и тот же компонент COM из двух разных **библиотеки классов** проекты, которые являются частью одного приложения. Это приведет к к созданию предупреждения, а приложение сможет загрузить во время выполнения. Чтобы избежать этой проблемы, корпорация Майкрософт рекомендует инкапсулировать COM-компонентов в одной библиотеке классов.  
  
 Существует несколько сценариев, в COM требуется регистрация на компьютере разработчика, даже если для развертывания приложения не требуется регистрация. `Isolated` Свойство требует, чтобы компонент COM был зарегистрирован на компьютере разработчика, чтобы автоматически создавать манифест во время построения. Отсутствуют возможности определения регистрации, вызывающие самостоятельную регистрацию во время построения. Кроме того все классы, не определенный явным образом в библиотеке типов, не будут отражены в манифесте. При использовании компонента COM с уже существующим манифестом, такие как собственную ссылку, компонент может не должны быть зарегистрированы во время разработки. Однако регистрация не требуется, если компонент является элементом управления ActiveX, и вы хотите включить ее в **элементов** и конструктором Windows Forms.  
  
## <a name="see-also"></a>См. также  
 [Развертывание и безопасность технологии ClickOnce](../deployment/clickonce-security-and-deployment.md)