---
title: Диагностика расширения пользовательского интерфейса задержки в Visual Studio | Документы Microsoft
ms.custom: ''
ms.date: 01/26/2018
ms.technology:
- vs-ide-sdk
ms.topic: conceptual
author: PooyaZv
ms.author: pozandev
manager: douge
ms.workload: multiple
ms.openlocfilehash: b63f9538c916b74874031704a1f60d0646f8d032
ms.sourcegitcommit: 6a9d5bd75e50947659fd6c837111a6a547884e2a
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 04/16/2018
ms.locfileid: "31134374"
---
# <a name="how-to-diagnose-ui-delays-caused-by-extensions"></a>Как: диагностики пользовательского интерфейса задержки, вызванные расширения

Когда пользовательский Интерфейс перестает отвечать, Visual Studio проверяет стек вызовов потока пользовательского интерфейса, начиная с листа и работаем над базовый. Если Visual Studio определяет, к которому принадлежит модуль, который является частью расширение установлена и включена на кадре стека вызовов, он показывает уведомление.

![Задержка в пользовательском Интерфейсе (зависания) уведомления](media/ui-delay-notification-in-vs.png)

Уведомление пользователю, задержка в пользовательском Интерфейсе (т. е. зависания в пользовательском Интерфейсе) находилась результат выполнения кода из расширения. Он также предоставляет пользователю с параметрами, чтобы отключить расширение или будущие уведомления для этого расширения.

В этом документе описывается, как диагностики в коде расширение причину задержки уведомлений пользовательского интерфейса. 

> [!NOTE]
> Не используйте экспериментальный экземпляр Visual Studio для диагностики задержки пользовательского интерфейса. Некоторые части стека вызовов анализа, необходимого для пользовательского интерфейса задержка уведомления отключены при использовании экспериментальный экземпляр, это означает, что задержка уведомления пользовательского интерфейса могут не отображаться.

Обзор процесса диагностики выглядит следующим образом:
1. Идентифицируйте сценарии триггера.
2. Перезапустите VS с действием, вход в систему.
3. Запуск трассировки ETW.
4. Запустите вновь появится уведомление.
5. Остановите отслеживание ETW.
6. Проверьте в журнале действия для получения идентификатора задержки.
7. Анализ трассировки с помощью идентификатора задержки при выполнении шага 6.

В следующих разделах мы рассмотрим эти шаги более подробно.

## <a name="identifying-the-trigger-scenario"></a>Определение сценария триггера

Чтобы выяснить, задержка в пользовательском Интерфейсе, сначала нужно определить, какие (последовательность действий) вызывает отображение уведомления в Visual Studio. Это, чтобы вы может вызывать уведомление позднее с ведением журнала.

## <a name="restarting-vs-with-activity-logging-on"></a>Перезапуск VS с действием, вход в систему

Visual Studio можно создать «журнал», предоставляющий сведения, полезные при отладке проблемы. Чтобы включить ведение журнала в Visual Studio действия, запустите Visual Studio с `/log` параметр командной строки. После запуска Visual Studio, журнал действий сохраняются в следующем расположении:

```DOS
%APPDATA%\Microsoft\VisualStudio\<vs_instance_id>\ActivityLog.xml
```

Чтобы узнать больше о том, как можно найти в VS идентификатор экземпляра, в разделе [средства обнаружения и управления экземплярами Visual Studio](../install/tools-for-managing-visual-studio-instances.md). Мы будем использовать этот журнал действий позже для поиска дополнительных сведений о задержки пользовательского интерфейса и связанные уведомления.

## <a name="starting-etw-tracing"></a>Запуск трассировка событий Windows

Можно использовать [PerfView](https://github.com/Microsoft/perfview/) для сбора трассировки. PerfView предоставляет простой в использовании интерфейс для трассировки сбор и анализ. Для получения трассировки, используйте следующую команду:

```DOS
Perfview.exe collect C:\trace.etl /BufferSizeMB=1024 -CircularMB:2048 -Merge:true -Providers:*Microsoft-VisualStudio:@StacksEnabled=true -NoV2Rundown /kernelEvents=default+FileIOInit+ContextSwitch+Dispatcher
```

Это позволяет поставщика «Microsoft VisualStudio», что поставщик, используемый Visual Studio для событий, связанных с задержка уведомления пользовательского интерфейса. Также указывается ключевое слово для поставщика ядра, PerfView можно использовать для создания представления «Стеки потоков времени».

## <a name="triggering-the-notification-to-appear-again"></a>Активация вновь появится уведомление

После запуска PerfView сбора данных трассировки можно использовать последовательность действий триггера (из шага 1) для уведомления вновь появится. После отображения уведомления, можно остановить коллекцию трассировки PerfView для обработки и создания в выходном файле трассировки.

## <a name="stopping-etw-tracing"></a>Остановка трассировка событий Windows

Чтобы остановить сбор данных трассировки, используйте `Stop collection` окно в PerfView. После остановки сбора данных трассировки PerfView будет автоматически обрабатывать события трассировки событий Windows и создает выходной файл трассировки.

## <a name="examining-the-activity-log-to-get-the-delay-id"></a>Найдите в журнале действия для получения идентификатора задержки

Как упоминалось ранее, можно найти журнал действий в `%APPDATA%\Microsoft\VisualStudio\<vs_instance_id>\ActivityLog.xml`. Каждый раз, Visual Studio обнаруживает расширение задержка в пользовательском Интерфейсе, он записывает узел в журнал действий с `UIDelayNotifications` как источник. Этот узел содержит сведения о задержке пользовательского интерфейса в четырех разделах.

- Идентификатор задержки пользовательского интерфейса, это число, однозначно определяющее задержка в пользовательском Интерфейсе в сеансе VS
- Идентификатор сеанса, который однозначно определяет сеанс Visual Studio от начала до закрытия
- Ли уведомление было показано задержки пользовательского интерфейса
- Расширение, которое вероятная причина-задержка в пользовательском Интерфейсе

```xml
<entry>
  <record>271</record>
  <time>2018/02/03 12:02:52.867</time>
  <type>Information</type>
  <source>UIDelayNotifications</source>
  <description>A UI delay (Delay ID = 0) has been detected. (Session ID=16e49d4b-26c2-4247-ad1c-488edeb185e0; Blamed extension="UIDelayR2"; Notification shown? Yes.)</description>
</entry>
```

> [!NOTE]
> Не все результат задержки пользовательского интерфейса в уведомлении. Поэтому всегда следует проверять «Уведомления показано?» значение, чтобы правильно определить правой задержка в пользовательском Интерфейсе.

После того как найдены правильные задержка в пользовательском Интерфейсе в журнале активности, запишите идентификатор задержки пользовательского интерфейса, указанный в узле. Идентификатор будет использоваться для поиска соответствующего события трассировки событий Windows в следующем шаге.

## <a name="analyzing-the-etw-trace"></a>Анализ трассировки

Затем откройте файл трассировки. Это можно сделать либо с помощью того же экземпляра PerfView или путем запуска нового экземпляра и параметра текущий путь к папке в верхнем левом углу окна в расположение файла трассировки.

![Задание пути к папке в Perfview](media/perfview-set-path.png)

Затем в левой области выберите файл трассировки и откройте его, выбрав открыть меню правой кнопкой мыши или контекст.

> [!NOTE]
> По умолчанию PerfView генерирует ZIP-архиве. При открытии trace.zip, она автоматически распаковывает архив и открывает трассировки. Пропустить этот шаг, снимите флажок «Zip» во время сбора данных трассировки. Тем не менее если вы планируете перенос и применения трассировок на разных компьютерах, настоятельно не рекомендуется снимите «Zip». Без этого параметра требуется PDB-файлы для сборок Ngen не сопровождающий трассировки и таким образом символы из сборок Ngen не будут разрешены на конечном компьютере. (См. [этой записи блога](https://blogs.msdn.microsoft.com/devops/2012/12/10/creating-ngen-pdbs-for-profiling-reports/) Дополнительные сведения о PDB-файлы для сборок Ngen.) 

Он может занять несколько минут для PerfView для обработки и откройте трассировку. Если трассировка уже открыт, в нем будет отображен список различных «представления».

![Представление "Сводка" трассировки PerfView](media/perfview-summary-view-events-selected.png)

Сначала мы будем использовать представление «События» для получения диапазон времени для задержки пользовательского интерфейса:

1. Откройте представление «События», выбрав «События» в узле трассировки и выбрав команду "Открыть" в меню правой кнопкой мыши или контекст.
2. Выберите «`Microsoft-VisualStudio/ExtensionUIUnresponsiveness`» на панели слева.
3. Нажмите клавишу ВВОД

Выделение применяется и все `ExtensionUIUnresponsiveness` события отображаются в правой области.

![При выборе события в представление событий](media/perfview-event-selection.png)

Каждая строка в правой области соответствует задержка в пользовательском Интерфейсе. Событие включает значение «Задержка ID», который должен совпадать с Идентификатором задержки в журнале действий при выполнении шага 6. Поскольку `ExtensionUIUnresponsiveness` возникает в конце задержка в пользовательском Интерфейсе, отметка времени события (приблизительно) отметки времени окончания задержки пользовательского интерфейса. Это событие также содержит длительность задержки. Мы можно вычесть из отметка времени окончания для получения отметки времени при запуске пользовательского интерфейса задержки длительность.

![Вычисление временных интервалов задержки пользовательского интерфейса](media/ui-delay-time-range.png)

На предыдущем снимке экрана например, отметка времени события — 12,125.679 и длительность задержки является 6,143.085 (мс). Таким образом, выражение
* Задержка запуска — 12,125.679 6,143.085 = 5,982.594.
* Диапазон времени задержки пользовательского интерфейса — 5,982.594 для 12,125.679.

После получения диапазон времени, мы завершать представления "события" и откройте представление «Стеки потоков время (с помощью действия StartStop)». В этом представлении особенно удобно, так, как часто расширения, которые блокируют поток пользовательского интерфейса просто ожидающие операции ввода-вывода или другими потоками. Таким образом представление «ЦП стек», которое является идеально подходит для большинства случаев, не может записать время, затраченное на потоке, блокировка, так как она не использует ЦП в течение этого времени. «Потоков время стеки» решает эту проблему, правильно отображения заблокированных времени.

![Время (с помощью действия StartStop) стеки узел потока в представлении сводки PerfView](media/perfview-thread-time-with-startstop-activities-stacks.png)

При открытии «Стеки потоков времени» Просмотр, выберите процесс «devenv» для запуска анализа.

![Поток представление стеков времени для анализа задержки пользовательского интерфейса](media/ui-delay-thread-time-stacks.png)

В представлении «Стеки потоков времени» в левой верхней части страницы, можно задать диапазон времени значения, которые мы вычисляются в предыдущем шаге и нажмите клавишу ВВОД, стеки корректируются этот диапазон.

> [!NOTE]
> Определить, какой поток пользовательского интерфейса потока (запуска) могут быть нелогичным, при запуске сбора данных трассировки, когда Visual Studio уже открыта. Однако первые элементы в стеке потока пользовательского интерфейса (загрузка), наиболее вероятный всегда DLL операционной системы (ntdll.dll и kernel32.dll) следуют devenv!? и затем msenv!. Эта последовательность может помочь идентифицировать поток пользовательского интерфейса.

 ![Определение потока запуска](media/ui-delay-startup-thread.png)

В этом представлении также Дополнительно можно фильтровать, только включив стеки содержат модули из пакета.

* Значение «GroupPats» пустой текст для удаления любого группирования, добавляется по умолчанию.
* Набор «IncPats», включает имя сборки, в дополнение к существующий фильтр процесса. В этом случае он должен быть «devenv; UIDelayR2».

![Указание GroupPath и IncPath в представление стеков потоков времени](media/perfview-tts-group-path-inc-path.png)

PerfView содержатся подробные инструкции в разделе меню "Справка", можно использовать для выявления узких мест в коде. Кроме того следующие ссылки предоставляют дополнительные сведения о том, как использовать Visual Studio, работа с потоками API-интерфейсы для оптимизации кода:

* [https://aka.ms/vsthreading](https://aka.ms/vsthreading)
* [https://aka.ms/vsthreadingcookbook](https://aka.ms/vsthreadingcookbook)

Можно также использовать новый статический анализаторы Visual Studio для расширения (пакет NuGet [здесь](https://www.nuget.org/packages/microsoft.visualstudio.sdk.analyzers)), приводится советы и рекомендации для написания эффективного расширения. Просмотреть список [анализаторы VS SDK](https://github.com/Microsoft/VSSDK-Analyzers/blob/master/doc/index.md) и [работа с потоками анализаторы](https://github.com/Microsoft/vs-threading/blob/master/doc/analyzers/index.md).

> [!NOTE]
> Если не удается устранить зависания из-за зависимости у вас управления по (например если расширение должно вызвать синхронной VS служб в потоке пользовательского интерфейса), мы хотели бы узнать об этом. Если вы являетесь членом нашей программы Visual Studio партнера, можете обратиться к нам, отправляя запрос на техническую поддержку разработчика. В противном случае использовать средство «Сообщить о проблеме» отправьте свой отзыв и включить `"Extension UI Delay Notifications"` в заголовке. Также включает подробное описание анализа.
