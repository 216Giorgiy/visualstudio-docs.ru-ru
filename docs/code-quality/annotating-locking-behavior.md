---
title: "Аннотация поведения блокировки | Microsoft Docs"
ms.custom: ""
ms.date: "11/04/2016"
ms.reviewer: ""
ms.suite: ""
ms.technology: 
  - "vs-devops-test"
ms.tgt_pltfrm: ""
ms.topic: "article"
f1_keywords: 
  - "_Releases_nonreentrant_lock_"
  - "_Lock_kind_mutex_"
  - "_Lock_kind_critical_section_"
  - "_Acquires_lock_"
  - "_Releases_lock_"
  - "_Has_lock_kind_"
  - "_Releases_exclusive_lock_"
  - "_Post_same_lock_"
  - "_Requires_exclusive_lock_held_"
  - "_Requires_shared_lock_held_"
  - "_Lock_kind_semaphore_"
  - "_Requires_lock_held_"
  - "_Acquires_exclusive_lock_"
  - "_Create_lock_level_"
  - "_Acquires_nonreentrant_lock_"
  - "_Releases_shared_lock_"
  - "_Has_lock_level_"
  - "_Lock_kind_spin_lock_"
  - "_Requires_lock_not_held_"
  - "_Acquires_shared_lock_"
  - "_Requires_no_locks_held_"
  - "_Lock_level_order_"
  - "_Lock_kind_event_"
ms.assetid: 07769c25-9b97-4ab7-b175-d1c450308d7a
caps.latest.revision: 9
author: "corob-msft"
ms.author: "corob"
manager: "ghogen"
caps.handback.revision: 9
---
# Аннотация поведения блокировки
[!INCLUDE[vs2017banner](../code-quality/includes/vs2017banner.md)]

Во избежание ошибок параллелизма в многопоточных программах, всегда выполняйте соответствующую дисциплину блокировок и используйте заметки SAL.  
  
 Ошибки параллелизма, как известно, трудно воспроизвести, распознать и отладить в силу случайного характера их проявления.  Рассуждение о последовательности потоков в лучшем случае представляется трудным и становится непрактичным при разработке основной части кода с более чем несколькими потоками.  Поэтому рекомендуется следовать дисциплине блокировки в многопоточных программах.  Например, проработка порядка блокировки при множественном захвате блокировок помогает избежать взаимоблокировок, а приобретение защитной блокировки до получения доступа к общему ресурсу помогает избежать состояния гонок.  
  
 К сожалению, простым на первый взгляд правилам блокировки удивительно сложно следовать на практике.  Основным ограничением сегодняшних языков программирования и компиляторов является то, что они не поддерживают спецификацию и анализ требований параллелизма.  Программисты должны полагаться на неофициальные комментарии к коду для выражения своих намерения о том, как они используют блокировки.  
  
 Заметки SAL параллелизма предназначены для помощи в определении побочных эффектов блокировки, ответственности за блокировку, владения данным, иерархии порядка блокировки и другого ожидаемого поведения блокировки.  Выполняя неявные правила явно, заметки SAL параллелизма предоставляют последовательный способ для документирования того, как код использует правила блокировки.  Заметки параллелизма также расширяют возможности средств анализа кода для поиска условий гонки, взаимоблокировки, несоответствующих операций синхронизации и других неявных ошибок параллелизма.  
  
## Общие рекомендации  
 Используя аннотации, можно формулировать договоры, которые неявно выражены определениями функций, между реализациями \(вызываемыми объектами\) и клиентами \(вызывающими объектами\), а также позволяют задавать инварианты и другие свойства программы, которые впоследствии могут повысить эффективность анализа.  
  
 SAL поддерживает множество различных типов примитивов блокирования, — например критические секции, мьютексы, спин\-блокировки и другие объекты ресурсов.  Многие аннотации параллелизма принимают выражение блокировки в качестве параметра.  По соглашению, блокировка идентифицируется значением пути базового объекта блокировки.  
  
 Некоторые правила учета владения потоком, которые следует помнить постоянно:  
  
-   Спин\-блокировки являются несчитающими блокировками, у которых есть определенный поток\-владелец.  
  
-   Мьютексы и критические секции являются считающими блокировками, у которых есть определенный поток\-владелец.  
  
-   Семафоры и события являются считающими блокировками, не имеющими определенного потока\-владельца.  
  
## Аннотации блокирования  
 В следующей таблице перечислены аннотации блокирования.  
  
|Заметка|Описание|  
|-------------|--------------|  
|`_Acquires_exclusive_lock_(expr)`|Аннотирует функцию и указывает, что функция после вызова увеличивает на единицу число монопольных блокировок объекта блокировок с именем `expr`.|  
|`_Acquires_lock_(expr)`|Аннотирует функцию и указывает, что функция после вызова увеличивает на единицу число блокировок объекта блокировок с именем `expr`.|  
|`_Acquires_nonreentrant_lock_(expr)`|Блокировка с именем `expr` получена.  Возникает ошибка, если блокировка уже захвачена.|  
|`_Acquires_shared_lock_(expr)`|Аннотирует функцию и указывает, что функция после вызова увеличивает на единицу число разделяемых блокировок объекта блокировок с именем `expr`.|  
|`_Create_lock_level_(name)`|Оператор, который объявляет символ `name` символом уровня блокировки, благодаря чему он может быть использован в аннотациях `_Has_Lock_level_` и `_Lock_level_order_`.|  
|`_Has_lock_kind_(kind)`|Аннотирует объект для уточнения сведений о типе объекта ресурсов.  Иногда общий тип используется для различных типов ресурсов, так как перегруженного типа не достаточно для того, чтобы различать семантические требования между различными ресурсами.  Ниже представлен список предварительно определенных параметров `kind`:<br /><br /> `_Lock_kind_mutex_`<br /> Идентификатор типа блокировки для мьютексов.<br /><br /> `_Lock_kind_event_`<br /> Идентификатор типа блокировки для событий.<br /><br /> `_Lock_kind_semaphore_`<br /> Идентификатор типа блокировки для семафоров.<br /><br /> `_Lock_kind_spin_lock_`<br /> Идентификатор типа блокировки для спин\-блокировок.<br /><br /> `_Lock_kind_critical_section_`<br /> Идентификатор типа блокировки для критических секций.|  
|`_Has_lock_level_(name)`|Аннотирует объект блокировки и присваивает ему уровень блокировки `name`.|  
|`_Lock_level_order_(name1, name2)`|Оператор, который возвращает блокировку, расположенную между `name2` и `name1`.|  
|`_Post_same_lock_(expr1, expr2)`|Аннотирует функцию и указывает, что в состоянии выполнения две блокировки, `expr1` и `expr2`, рассматриваются таким образом, как если бы они были одним и тем же объектом блокировки.|  
|`_Releases_exclusive_lock_(expr)`|Аннотирует функцию и указывает, что функция после вызова уменьшает на единицу число монопольных блокировок объекта блокировок с именем `expr`.|  
|`_Releases_lock_(expr)`|Аннотирует функцию и указывает, что функция после вызова уменьшает на единицу число блокировок объекта блокировок с именем `expr`.|  
|`_Releases_nonreentrant_lock_(expr)`|Блокировка с именем `expr` снята.  Ошибка возникает, если блокировка на данный момент не захвачена.|  
|`_Releases_shared_lock_(expr)`|Аннотирует функцию и указывает, что функция после вызова уменьшает на единицу число разделяемых блокировок объекта блокировок с именем `expr`.|  
|`_Requires_lock_held_(expr)`|Аннотирует функцию и указывает, что перед вызовом функции количество блокировок объекта с именем `expr` не менее единицы.|  
|`_Requires_lock_not_held_(expr)`|Аннотирует функцию и указывает, что перед вызовом функции количество блокировок объекта с именем `expr` равно нулю.|  
|`_Requires_no_locks_held_`|Аннотирует функцию и указывает, что количества блокировок на всех объектах блокировки равны нулю.|  
|`_Requires_shared_lock_held_(expr)`|Аннотирует функцию и указывает, что перед вызовом функции количество разделяемых блокировок объекта с именем `expr` не менее единицы.|  
|`_Requires_exclusive_lock_held_(expr)`|Аннотирует функцию и указывает, что перед вызовом функции количество монопольных блокировок объекта с именем `expr` не менее единицы.|  
  
## Встроенные SAL для непредоставленных явно объектов блокировки  
 Некоторые объекты блокирования остаются уязвимы в результате реализации связанных с ними функций блокирования.  В следующей таблице перечислены встроенные переменные SAL, которые содержат заметки для функций, действующих на эти защищенные объекты блокировки.  
  
|Заметка|Описание|  
|-------------|--------------|  
|`_Global_cancel_spin_lock_`|Описывает отмену спин\-блокировки.|  
|`_Global_critical_region_`|Описывает критическую область.|  
|`_Global_interlock_`|Описывает блокируемые операции.|  
|`_Global_priority_region_`|Описывает область приоритета.|  
  
## Аннотации доступа к разделяемым данным  
 В следующей таблице перечисляются аннотации для доступа к разделяемым данным.  
  
|Заметка|Описание|  
|-------------|--------------|  
|`_Guarded_by_(expr)`|Аннотирует переменную и указывает на то, что при доступе к данной переменной количество блокировок объекта с именем `expr` не менее единицы.|  
|`_Interlocked_`|Аннотирует переменную, что эквивалентно `_Guarded_by_(_Global_interlock_)`.|  
|`_Interlocked_operand_`|Аннотированный параметр функции является целевым операндом одной из множества блокирующих функций.  Эти операнды должны иметь определенные дополнительные свойства.|  
|`_Write_guarded_by_(expr)`|Аннотирует переменную и указывает на то, что при изменении данной переменной количество блокировок объекта с именем `expr` не менее единицы.|  
  
## См. также  
 [Использование аннотаций SAL для сокращения количества дефектов в коде C\/C\+\+](../code-quality/using-sal-annotations-to-reduce-c-cpp-code-defects.md)   
 [Основные сведения о языке SAL](../code-quality/understanding-sal.md)   
 [Создание примечаний к параметрам и возвращаемым значениям функций](../code-quality/annotating-function-parameters-and-return-values.md)   
 [Аннотация поведения функций](../code-quality/annotating-function-behavior.md)   
 [Аннотация структур и классов](../code-quality/annotating-structs-and-classes.md)   
 [Указание времени и места применения примечания](../code-quality/specifying-when-and-where-an-annotation-applies.md)   
 [Встроенные функции](../code-quality/intrinsic-functions.md)   
 [Рекомендации и примеры](../code-quality/best-practices-and-examples-sal.md)   
 [Блог команды анализа кода](http://go.microsoft.com/fwlink/p/?LinkId=251197)