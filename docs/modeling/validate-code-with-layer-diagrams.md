---
title: Проверка кода по схемам зависимостей
ms.date: 11/04/2016
ms.topic: conceptual
helpviewer_keywords:
- dependency diagrams, validating
- validation, dependency diagrams
- validation, code
- code exploration, validating
- architecture, validating
- Visual Studio Ultimate, validating code
- validation, architecture
- validation, dependencies
- MSBuild, tasks
- MSBuild, dependency diagrams
- MSBuild, validating code
author: gewarren
ms.author: gewarren
manager: douge
ms.workload:
- multiple
ms.prod: visual-studio-dev15
ms.technology: vs-ide-modeling
ms.openlocfilehash: 22d51fff3dcfea81676e18c7b13d91bb5567dde8
ms.sourcegitcommit: 28909340cd0a0d7cb5e1fd29cbd37e726d832631
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 09/10/2018
ms.locfileid: "44321129"
---
# <a name="validate-code-with-dependency-diagrams"></a>Проверка кода по схемам зависимостей

**Последние новости**: см. в разделе [этой записи блога](https://blogs.msdn.microsoft.com/visualstudioalm/2016/11/30/live-dependency-validation-in-visual-studio-2017/).

[Видео: Проверка зависимостей архитектуры в режиме реального времени](https://sec.ch9.ms/sessions/69613110-c334-4f25-bb36-08e5a93456b5/170ValidateArchitectureDependenciesWithVisualStudio.mp4)

## <a name="why-use-dependency-diagrams"></a>Зачем использовать схемы зависимостей?

Чтобы убедиться, что код не конфликтует со структурой, проверьте его с помощью схем зависимостей в Visual Studio. Это может помочь:

-   Найти конфликты между зависимостями в коде и зависимостями на схеме зависимостей.

-   Найти зависимости, на которые могут повлиять предложенные изменения.

     Например можно изменить диаграмму зависимостей для отображения потенциальных изменений архитектуры и затем проверить код, чтобы просмотреть затронутые зависимости.

-   Выполнить рефакторинг или миграцию кода в другую структуру.

     Найти код или зависимости, с которыми потребуется выполнить определенные действия даже после перемещения кода в другую архитектуру.

 **Требования**

-   Visual Studio

-   Visual Studio на сервере Team Foundation Build для проверки кода автоматически с помощью Team Foundation Build

-   Решение, включающее проект моделирования со схемой зависимостей. На этой схеме зависимости должны быть связаны с артефактами в проектах C# или Visual Basic, которые вы хотите проверить. См. в разделе [Создание схем зависимостей из кода](../modeling/create-layer-diagrams-from-your-code.md).

 Чтобы узнать, какие версии Visual Studio поддерживают эту функцию, см. раздел [Поддержка версий для инструментов моделирования и архитектуры](../modeling/what-s-new-for-design-in-visual-studio.md#VersionSupport).

 Можно проверить код вручную из схемы откройте зависимостей в Visual Studio или из командной строки. Также код можно проверить автоматически при выполнении локальных сборок или Team Foundation Build. См. в разделе [видео Channel 9: проектирования и проверки архитектуры с помощью схем зависимостей](http://go.microsoft.com/fwlink/?LinkID=252073).

> [!IMPORTANT]
>  Если необходимо выполнить проверку слоев в Team Foundation Build, следует также установить ту же версию Visual Studio на сервере сборки.

-   [См. в разделе, если элемент поддерживает проверку](#SupportsValidation)

-   [Включать другие сборки .NET и проекты для проверки](#IncludeReferences)

-   [Проверка кода вручную](#ValidateManually)

-   [Автоматическая проверка кода](#ValidateAuto)

-   [Устранение неполадок проверки слоев](#TroubleshootingValidation)

-   [Понимание и устранение ошибок проверки слоев](#UnderstandingValidationErrors)

## <a name="live-dependency-validation"></a>Динамическая проверка зависимостей

В этом выпуске Visual Studio происходит проверка зависимостей в режиме реального времени и немедленно отображаются ошибки в окне списка ошибок Visual Studio.

* Динамическая проверка поддерживается для C# и Visual Basic.NET.

* Чтобы включить полный анализ решения, при использовании Динамическая проверка зависимостей, откройте настройки параметров на панели gold, которое отображается в списке ошибок.
 - Эта панель gold можно закрыть без возможности восстановления в том случае, если вы не хотите просмотреть все архитектуры в решении проблемы.
 - Если не включить полный анализ решения, анализ выполняется только для файлов, который редактируется.<p />

* При обновлении проектов для включения динамической проверки, диалоговое окно показывает ход выполнения преобразования.

* При обновлении проекта для Динамическая проверка зависимостей, версия пакета NuGet обновляется должны совпадать для всех проектов и самую новую версию используется.

* Добавив новые триггеры проекта проверки зависимостей обновление проекта.

##  <a name="SupportsValidation"></a> См. в разделе, если элемент поддерживает проверку
 Можно связать слои с веб-сайтов, документов Office, обычными текстовыми файлами и файлами в проектах, которые являются общими для нескольких приложений, но они не войдут в процессе проверки. Ошибки проверки для ссылок на проекты или сборки, связанные с отдельными слоями, отображаются только в том случае, если между этими слоями отображаются зависимости. Эти ссылки считаются зависимостями, только если используются в коде.

1.  На схеме зависимостей, выберите один или несколько слоев, щелкните правой кнопкой мыши выбранные параметры и нажмите кнопку **Просмотр ссылок**.

2.  В **обозреватель слоев**, рассмотрим **поддержка проверки** столбца. Если значение равно false, элемент не поддерживает проверку.

##  <a name="IncludeReferences"></a> Включать другие сборки .NET и проекты для проверки
 При перетаскивании элементов на схему зависимостей, ссылки на соответствующие сборки или проекты .NET автоматически добавляются в **ссылки слоя** папки в проекте моделирования. Эта папка содержит ссылки на сборки и проекты, которые анализируются во время проверки. Можно включить другие сборки .NET и проекты для проверки не вручную, перетащив их в диаграмму зависимостей.

1.  В **обозревателе решений**, щелкните правой кнопкой мыши проект моделирования или **ссылки слоя** папку, а затем щелкните **добавить ссылку**.

2.  В **добавить ссылку** диалоговом окне выберите сборки или проекты и нажмите кнопку **ОК**.

##  <a name="ValidateManually"></a> Проверка кода вручную
 Если у вас есть диаграмму зависимостей open, связанного с элементами решения, можно запустить **Validate** команда быстрого доступа из схемы. Также можно использовать командную строку для запуска **msbuild** с **/p:ValidateArchitecture** пользовательское свойство, значение **True**. Например, при внесении изменений в код регулярно выполняйте проверку слоев, чтобы заранее обнаруживать конфликты зависимостей.

#### <a name="to-validate-code-from-an-open-dependency-diagram"></a>Для проверки кода из схемы откройте зависимостей

1.  Щелкните правой кнопкой мыши поверхность схемы и нажмите кнопку **проверить архитектуру**.

    > [!NOTE]
    >  По умолчанию **действие при построении** присваивается свойству зависимостей файл схемы (.layerdiagram) **Validate** таким образом, чтобы схема включена в процесс проверки.

     **Список ошибок** окно сообщает обо всех возникающих ошибках. Дополнительные сведения об ошибках проверки см. в разделе [понимание и устранение ошибок проверки слоев](#UnderstandingValidationErrors).

2.  Чтобы просмотреть источник каждой ошибки, дважды щелкните ошибку в **список ошибок** окна.

    > [!NOTE]
    >  [!INCLUDE[vsprvs](../code-quality/includes/vsprvs_md.md)] может вместо источника ошибки показывать карту кода. Это происходит, когда код имеет зависимость от сборки, которая не задал диаграмму зависимостей, либо в коде отсутствует зависимость, которая определяется схема зависимостей. Просмотрите карту кода или код, чтобы определить, должна ли существовать зависимость. Дополнительные сведения о картах кода, см. в разделе [сопоставление зависимостей в решениях](../modeling/map-dependencies-across-your-solutions.md).

3.  Для управления ошибками, см. в разделе [Управление ошибками проверки](#ManageErrors).

#### <a name="to-validate-code-at-the-command-prompt"></a>Проверка кода в командной строке

1.  Откройте командную строку [!INCLUDE[vsprvs](../code-quality/includes/vsprvs_md.md)].

2.  Выберите один из следующих вариантов.

    -   Чтобы проверить код на соответствие конкретному проекту моделирования в решении, запустите [!INCLUDE[vstecmsbuild](../extensibility/internals/includes/vstecmsbuild_md.md)] со следующим пользовательским свойством.

        ```
        msbuild <FilePath+ModelProjectFileName>.modelproj /p:ValidateArchitecture=true
        ```

         - или

         Перейдите к папке, содержащей моделирования (MODELPROJ-файл) и схема зависимостей проекта, а затем запустите [!INCLUDE[vstecmsbuild](../extensibility/internals/includes/vstecmsbuild_md.md)] со следующим пользовательским свойством:

        ```
        msbuild /p:ValidateArchitecture=true
        ```

    -   Чтобы проверить код на соответствие всем проектам моделирования в решении, запустите [!INCLUDE[vstecmsbuild](../extensibility/internals/includes/vstecmsbuild_md.md)] со следующим пользовательским свойством.

        ```
        msbuild <FilePath+SolutionName>.sln /p:ValidateArchitecture=true
        ```

         - или

         Перейдите в папку решения, в которой должен находиться проект моделирования со схемой зависимостей, а затем запустите [!INCLUDE[vstecmsbuild](../extensibility/internals/includes/vstecmsbuild_md.md)] со следующим пользовательским свойством:

        ```
        msbuild /p:ValidateArchitecture=true
        ```

     Отобразятся любые возникающие ошибки. Дополнительные сведения о [!INCLUDE[vstecmsbuild](../extensibility/internals/includes/vstecmsbuild_md.md)], см. в разделе [MSBuild](../msbuild/msbuild.md) и [задачи MSBuild](../msbuild/msbuild-task.md).

 Дополнительные сведения об ошибках проверки см. в разделе [понимание и устранение ошибок проверки слоев](#UnderstandingValidationErrors).

###  <a name="ManageErrors"></a> Управление ошибками проверки
 В процессе разработки может понадобиться подавить некоторые конфликты, выявленные в ходе проверки. Например, можно подавлять ошибки, над которыми уже ведется работа, а также ошибки, не имеющие отношения к конкретному сценарию. При подавлении ошибки рекомендуется фиксировать рабочий элемент в журнале в [!INCLUDE[esprfound](../code-quality/includes/esprfound_md.md)].

> [!WARNING]
>  Вы должны быть уже подключены к управлению исходным кодом (SCC) TFS для создания рабочего элемента или связи с ним. При попытке открыть соединение с другим SCC TFS Visual Studio автоматически закрывает текущее решение. Убедитесь, что вы уже подключены соответствующему SCC, перед попыткой создания рабочего элемента или связи с ним. В последних выпусках Visual Studio команды меню недоступны, если вы не подключены к SCC.

##### <a name="to-create-a-work-item-for-a-validation-error"></a>Создание рабочего элемента для ошибки проверки

-   В **список ошибок** окно, щелкните ошибку правой кнопкой мыши **Создание рабочего элемента**, а затем выберите тип рабочего элемента, который вы хотите создать.

 Использование этих задач для управления ошибками проверки в **список ошибок** окна:

|**Задача**|**Выполните следующие действия**|
|------------|----------------------------|
|Подавить выбранные ошибки во время проверки|Щелкните один или несколько выбранных ошибок правой кнопкой мыши **Управление ошибками проверки**, а затем нажмите кнопку **подавление ошибок**.<br /><br /> Отобразятся подавленные ошибки с форматированием в виде зачеркивания. При выполнении проверки в следующий раз эти ошибки отображаться не будут.<br /><br /> Подавленные ошибки отслеживаются в suppressions-файле для соответствующего файла схеме зависимостей.|
|Остановить подавление выбранных ошибок|Щелкните выбранную подавленную ошибку или ошибки правой кнопкой мыши **Управление ошибками проверки**, а затем нажмите кнопку **Отменить подавление ошибок**.<br /><br /> При выполнении проверки в следующий раз выбранные подавленные ошибки будут отображаться.|
|Восстановить все подавленные ошибки в **список ошибок** окно|Щелкните правой кнопкой мыши **список ошибок** окна **Управление ошибками проверки**, а затем нажмите кнопку **Показать все подавленные ошибки**.|
|Скрыть все подавленные ошибки в **список ошибок** окно|Щелкните правой кнопкой мыши **список ошибок** окна **Управление ошибками проверки**, а затем нажмите кнопку **скрыть все подавленные ошибки**.|

##  <a name="ValidateAuto"></a> Автоматическая проверка кода
 Проверку слоев можно выполнять при каждом выполнении локальной сборки. Если команда использует Team Foundation Build, можно выполнить проверку слоев с проверкой изменений, которые можно задать путем создания пользовательской задачи MSBuild, и использовать отчеты по сборке для сбора ошибок проверки. Чтобы создать с условным возвратом, см. в разделе [использование процесса сборки с условным возвратом для проверки изменений](http://msdn.microsoft.com/Library/9cfc8b9c-1023-40fd-8ab5-1b1bd9c172ec).

#### <a name="to-validate-code-automatically-during-a-local-build"></a>Автоматическая проверка кода во время локальной сборки

-   Откройте файл проекта моделирования (.modelproj) в текстовом редакторе и включите следующее свойство.

```xml
<ValidateArchitecture>true</ValidateArchitecture>
```

 \- или -

1.  В **обозревателе решений**, щелкните правой кнопкой мыши проект моделирования, который содержит диаграмму зависимостей или схемы и нажмите кнопку **свойства**.

2.  В **свойства** окне задайте проект моделирования **проверить архитектуру** свойства **True**.

     Это позволяет включить проект моделирования в процесс проверки.

3.  В **обозревателе решений**, щелкните файл схемы (.layerdiagram) зависимостей, который вы хотите использовать для проверки.

4.  В **свойства** окна, убедитесь, что схемы **действие при построении** свойству **Validate**.

     Сюда входят диаграмму зависимостей в процесс проверки.

 Для управления ошибками в окне списка ошибок, см. в разделе [Управление ошибками проверки](#ManageErrors).

#### <a name="to-validate-code-automatically-during-a-team-foundation-build"></a>Автоматическая проверка кода во время выполнения Team Foundation Build

1.  В **Team Explorer**, дважды щелкните определение построения и нажмите кнопку **процесс**.

2.  В разделе **параметры процесса сборки**, разверните **компиляции**и введите следующую команду в **Аргументы MSBuild** параметр:

     `/p:ValidateArchitecture=true`

 Дополнительные сведения об ошибках проверки см. в разделе [понимание и устранение ошибок проверки слоев](#UnderstandingValidationErrors). Дополнительные сведения о [!INCLUDE[esprbuild](../misc/includes/esprbuild_md.md)] см. в разделах:

-   [Azure конвейеров](/azure/devops/pipelines/index?view=vsts)

-   [Использование шаблона по умолчанию для рабочего процесса сборки](http://msdn.microsoft.com/Library/43930b12-c21b-4599-a980-2995e3d16e31)

-   [Изменение прежней сборки, основанный на файле UpgradeTemplate.xaml](http://msdn.microsoft.com/Library/ee1a8259-1dd1-4a10-9563-66c5446ef41c)

-   [Настройка шаблона процесса сборки](http://msdn.microsoft.com/Library/b94c58f2-ae6f-4245-bedb-82cd114f6039)

-   [Отслеживание хода выполнения запуска построения](http://msdn.microsoft.com/Library/e51e3bad-2d1d-4b7b-bfcc-c43439c6c8ef)

##  <a name="TroubleshootingValidation"></a> Устранение неполадок проверки слоев
 Следующая таблица описывает проблемы проверки слоев и способы их устранения. Эти проблемы отличаются от ошибок, возникающих из-за несоответствия между кодом и структурой. Дополнительные сведения об этих ошибках см. в разделе [понимание и устранение ошибок проверки слоев](#UnderstandingValidationErrors).

|**Проблема**|**Возможная причина**|**Решение**|
|---------------|------------------------|--------------------|
|Ошибки проверки не возникают так, как это ожидается.|Проверка не работает на диаграммах зависимостей, которые скопированы из других схем зависимостей в обозревателе решений и находятся в том же проекте моделирования. схемы зависимостей, которые копируются в этом случае содержат те же ссылки, что и исходная схема зависимостей.|Добавьте новую схему зависимостей в проект моделирования.<br /><br /> Скопируйте элементы из исходной схемы зависимостей в новую диаграмму.|

##  <a name="UnderstandingValidationErrors"></a> Понимание и устранение ошибок проверки слоев
 При проверке кода по схеме зависимостей, ошибки проверки возникают, когда код конфликтует со структурой. Например, ошибки проверки могут происходить по следующим причинам:

-   Артефакт назначен неправильному слою. В этом случае следует переместить артефакт.

-   Способ использования артефактом (например, классом) другого класса конфликтует с имеющейся архитектурой. В этом случае необходимо выполнить рефакторинг кода, чтобы устранить зависимость.

 Для устранения этих ошибок следует обновлять код до тех пор, пока в процессе проверки не перестанут происходить ошибки. Эту процедуру можно выполнить методом итераций.

 В следующем разделе описывается синтаксис, используемый в этих ошибках, объясняется значение этих ошибок и предлагаются пути решения или управления ими.

|**Синтаксис**|**Описание**|
|----------------|---------------------|
|*ArtifactN*(*ArtifactTypeN*)|*ArtifactN* — это артефакт, связанный со слоем на схеме зависимостей.<br /><br /> *ArtifactTypeN* — это тип *ArtifactN*, такие как **класс** или **метод**, например:<br /><br /> MySolution.MyProject.MyClass.MyMethod(Method)|
|*NamespaceNameN*|Имя пространства имен.|
|*LayerNameN*|Имя слоя на диаграмме зависимостей.|
|*Тип_зависимости*|Тип отношения зависимости между *Artifact1* и *Artifact2*. Например *Artifact1* имеет **вызовы** взаимосвязь *Artifact2*.|

|**Синтаксическая ошибка**|**Описание ошибки**|
|----------------------|---------------------------|
|DV0001: **Недопустимая зависимость**|Эта проблема передается в том случае, если элемент кода (пространство имен, тип, член) сопоставлено ссылки слоя код элемента, сопоставленного с другого слоя, но есть не стрелка зависимости между этими уровнями в схема проверки зависимостей, содержащий этот слои. Это нарушение ограничения зависимостей.|
|DV1001: **неверное имя пространства имен**|Эта проблема передаются на элемент кода, связанный со слоем, в котором свойство «Допускается имена пространства имен» не содержит пространство имен, в котором определен данный элемент кода. Это нарушение ограничения именования. Обратите внимание, что быть точкой с запятой список пространств имен кода элементы, связанные с представляют слой используется синтаксис «Допускается имена пространства имен» могут быть определены.|
|DV1002: **зависимость от имен, на которые невозможно сослаться**|Эта проблема передаются на элемент кода, связанный со слоем и ссылкой на другой элемент кода, определенных в пространстве имен, который определен в свойстве «На которые невозможно сослаться пространства имен» слоя. Это нарушение ограничения именования. Обратите внимание на то, что свойство «На которые невозможно сослаться пространства имен» определяется как список пространств имен, не следует ссылаться в элементах кода, связанные с этим слоем, разделенных точкой с запятой.|
|DV1003: **имя пространства имен не разрешено**|Эта проблема передаются на элемент кода, связанный со слоем, содержащий свойство «Запрещенные имена пространств имен» пространство имен, в котором определен данный элемент кода. Это нарушение ограничения именования. Обратите внимание на то, что свойство «Имя пространства имен не разрешено» определен как разделяются точкой с запятой список пространств имен, в какой код не следует определять элементы, связанные с этим слоем.|
|DV3001: **отсутствует ссылка**|Уровень "*LayerName*«содержит ссылки на»*артефакта*" который невозможно найти. Отсутствует ссылка на сборку?|*LayerName* связан с артефактом, который не удается найти. Например, связь с классом может отсутствовать из-за отсутствия в проекте моделирования ссылки на сборку, содержащую этот класс.|
|DV9001: **архитектуры обнаружены внутренние ошибки**|Результат может быть неполным. Для получения дополнительных сведений см. подробный журнал событий построения или окно вывода.|Для получения дополнительных сведений см. журнал событий сборки или окно вывода.|


## <a name="see-also"></a>См. также

- [Проверка системы в ходе разработки](../modeling/validate-your-system-during-development.md)
- [Видео: Проверка зависимостей архитектуры в режиме реального времени](https://sec.ch9.ms/sessions/69613110-c334-4f25-bb36-08e5a93456b5/170ValidateArchitectureDependenciesWithVisualStudio.mp4)
