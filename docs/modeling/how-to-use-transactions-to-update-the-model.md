---
title: 'Как: использовать транзакции для обновления модели | Документы Microsoft'
ms.custom: ''
ms.date: 11/04/2016
ms.topic: conceptual
author: gewarren
ms.author: gewarren
manager: douge
ms.workload:
- multiple
ms.technology: vs-ide-modeling
ms.openlocfilehash: 25c70adf3f8219bf67181183bf4c1a2b822f6424
ms.sourcegitcommit: 6a9d5bd75e50947659fd6c837111a6a547884e2a
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 04/16/2018
---
# <a name="how-to-use-transactions-to-update-the-model"></a>Практическое руководство. Обновление модели с помощью транзакций
Транзакции убедитесь в том, что изменения, внесенные в хранилище, рассматриваются как группу. Изменения, которые группируются может быть зафиксирована или выполнен откат, как единое целое.  
  
 Каждый раз, когда программный код изменяет, добавляет или удаляет любой элемент в хранилище [!INCLUDE[vsprvs](../code-quality/includes/vsprvs_md.md)] визуализации и моделирования SDK, необходимо сделать это внутри транзакции. Должен быть активный экземпляр <xref:Microsoft.VisualStudio.Modeling.Transaction> связанный с хранилищем, когда происходит изменение. Это применяется для всех элементов модели, связи, фигур, диаграмм и их свойства.  
  
 Механизм транзакций поможет вам избежать несогласованное состояние. При возникновении ошибки во время транзакции откат всех изменений. Если пользователь выполняет команду отмены, каждой последней транзакции, считается за один шаг. Пользователь не удается отменить части последние изменения, если явно поместить их в отдельных транзакциях.  
  
## <a name="opening-a-transaction"></a>Открытие транзакции  
 Является наиболее удобным способом управления транзакции с `using` инструкции заключены в `try...catch` инструкции:  
  
```  
Store store; ...  
try  
{  
  using (Transaction transaction =  
    store.TransactionManager.BeginTransaction("update model"))  
    // Outermost transaction must always have a name.  
  {  
    // Make several changes in Store:  
    Person p = new Person(store);  
    p.FamilyTreeModel = familyTree;  
    p.Name = "Edward VI";  
    // end of changes to Store  
  
    transaction.Commit(); // Don't forget this!  
  } // transaction disposed here  
}  
catch (Exception ex)  
{  
  // If an exception occurs, the Store will be   
  // rolled back to its previous state.  
}  
```  
  
 Если исключение, которое предотвращает окончательная `Commit()` возникает во время изменения, хранилище будут сброшены в предыдущее состояние. Это поможет убедиться, что ошибок не оставляйте модель в несогласованном состоянии.  
  
 Можно создать любое количество изменений в рамках одной транзакции. Вы можете открыть новые транзакции внутри активной транзакции. Вложенные транзакции должны фиксации или отката до завершения транзакции содержащего. Дополнительные сведения см. пример для <xref:Microsoft.VisualStudio.Modeling.Transaction.TransactionDepth%2A> свойства.  
  
 Для внесения постоянных изменений, должны `Commit` транзакции до ее удаления. Если возникает исключение не перехватывается внутри транзакции, хранилище будут сброшены в состояние до изменения.  
  
## <a name="rolling-back-a-transaction"></a>Откат транзакции  
 Чтобы убедиться, что остается в хранилище, или возвращается в состояние до выполнения транзакции, можно использовать любой из этих методик:  
  
1.  Исключение не перехватывается внутри области транзакции.  
  
2.  Явно выполнить откат транзакции.  
  
    ```  
    this.Store.TransactionManager.CurrentTransaction.Rollback();  
    ```  
  
## <a name="transactions-do-not-affect-non-store-objects"></a>Транзакции не влияют на объекты не хранилища  
 Транзакции только управляют состояния хранилища. Их нельзя отменить частичного изменения, внесенные в внешние элементы, такие как файлы, базы данных или объекты, объявленные с обычные типы за пределами определения DSL.  
  
 Если исключение может оставить такого изменения согласована с хранилищем, должны иметь дело с данную возможность в обработчике исключений. Чтобы убедиться в том, что внешние ресурсы будут синхронизированы с объектами хранилища можно привязать каждого внешнего объекта на элемент в хранилище с помощью обработчиков событий. Дополнительные сведения см. в разделе [обработчики распространение изменений за пределами модели событий](../modeling/event-handlers-propagate-changes-outside-the-model.md).  
  
## <a name="rules-fire-at-the-end-of-a-transaction"></a>Правила срабатывают в конце транзакции  
 В конце транзакции до транзакции удаления, запускаются правила, присоединенные к элементам в хранилище. Каждое правило — это метод, который применяется к элементу модели, которая была изменена. Например правил «исправьте», обновляющих состояние фигуры при изменении его элемент модели и при создании элемента модели, которые создают фигуры. Нет указанного срабатывание порядка. Изменения, внесенные с помощью правила срабатывают другое правило.  
  
 Можно определить собственные правила. Дополнительные сведения о правилах см. в разделе [распространение изменений и реагирование на](../modeling/responding-to-and-propagating-changes.md).  
  
 Правила не срабатывают после отмены, повтора или команду rollback.  
  
## <a name="transaction-context"></a>Контекст транзакции  
 Каждая транзакция имеет словарь, в котором можно хранить любые нужные сведения:  
  
 `store.TransactionManager`  
  
 `.CurrentTransaction.TopLevelTransaction`  
  
 `.Context.Add(aKey, aValue);`  
  
 Это особенно полезно для передачи данных между правилами.  
  
## <a name="transaction-state"></a>Состояние транзакции  
 В некоторых случаях нужно избежать распространение изменений, если изменение вызвано Отмена или повтор транзакции. Это может произойти, например, если вы пишете обработчик значения свойства, который может обновить другое значение в хранилище. Так как операция отмены их предыдущих состояний сбрасывает все значения в хранилище, необязательно для вычисления обновленные значения. Используйте следующий код:  
  
```  
if (!this.Store.InUndoRedoOrRollback) {...}  
```  
  
 Правила могут срабатывать при хранилище изначально загружается из файла. Чтобы избежать реагировать на эти изменения, используйте следующую команду:  
  
```  
if (!this.Store.InSerializationTransaction) {...}  
  
```